<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Diagnostics - DTrade Scalper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        .diagnostic-card {
            transition: all 0.2s ease;
        }
        .diagnostic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }
    </style>
</head>
<body class="text-slate-100">
    <!-- Navigation -->
    <nav class="bg-slate-900/80 backdrop-blur-sm border-b border-slate-800 sticky top-0 z-50">
        <div class="max-w-full mx-auto px-6 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-6">
                    <h1 class="text-xl font-bold tracking-tight text-slate-100">ðŸ”§ System Diagnostics</h1>
                    <span class="text-xs text-slate-400">Instant problem detection</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="runDiagnostics()" class="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-red-600 hover:bg-red-500 text-white text-sm font-medium transition-colors">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            <path d="M9 12l2 2 4-4"/>
                        </svg>
                        Run Diagnostics
                    </button>
                    <a href="/" class="px-4 py-2 rounded-md bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm font-medium transition-colors">
                        Dashboard
                    </a>
                    <a href="/features" class="px-4 py-2 rounded-md bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm font-medium transition-colors">
                        Features
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-full mx-auto px-6 py-6 space-y-6">

        <!-- Overall Status Card -->
        <div id="overallStatus" class="rounded-lg border bg-slate-900/60 p-6 hidden">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-sm font-medium text-slate-400 uppercase tracking-wide mb-2">System Status</h2>
                    <p id="statusText" class="text-3xl font-bold"></p>
                </div>
                <div id="statusIcon" class="text-6xl"></div>
            </div>
        </div>

        <!-- Issues Alert -->
        <div id="issuesSection" class="rounded-lg border border-red-800 bg-red-950/40 p-6 hidden">
            <h3 class="text-lg font-bold text-red-300 mb-3 flex items-center gap-2">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                Critical Issues
            </h3>
            <ul id="issuesList" class="space-y-2 text-red-200"></ul>
        </div>

        <!-- Warnings Alert -->
        <div id="warningsSection" class="rounded-lg border border-yellow-800 bg-yellow-950/40 p-6 hidden">
            <h3 class="text-lg font-bold text-yellow-300 mb-3 flex items-center gap-2">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                Warnings
            </h3>
            <ul id="warningsList" class="space-y-2 text-yellow-200"></ul>
        </div>

        <!-- Detailed Checks Grid -->
        <div id="checksSection" class="space-y-4 hidden">
            <h2 class="text-xl font-bold text-slate-100 mb-4">Detailed Checks</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

                <!-- WebSocket Check -->
                <div id="wsCheck" class="diagnostic-card rounded-lg border border-slate-800 bg-slate-900/60 p-6">
                    <h3 class="text-base font-semibold text-slate-200 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                        WebSocket Data Flow
                    </h3>
                    <div id="wsDetails" class="text-slate-400 text-sm"></div>
                </div>

                <!-- Orderbook Depth Check -->
                <div id="depthCheck" class="diagnostic-card rounded-lg border border-slate-800 bg-slate-900/60 p-6">
                    <h3 class="text-base font-semibold text-slate-200 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 text-emerald-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="20" x2="12" y2="10"/>
                            <line x1="18" y1="20" x2="18" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="16"/>
                        </svg>
                        Orderbook Depth
                    </h3>
                    <div id="depthDetails" class="text-slate-400 text-sm"></div>
                </div>

                <!-- Feature Engine Check -->
                <div id="feCheck" class="diagnostic-card rounded-lg border border-slate-800 bg-slate-900/60 p-6">
                    <h3 class="text-base font-semibold text-slate-200 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 text-violet-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6m5.196-13.196l-4.242 4.242m0 5.908l4.242 4.242M1 12h6m6 0h6m-13.196 5.196l4.242-4.242m5.908 0l4.242 4.242"/>
                        </svg>
                        Feature Engine
                    </h3>
                    <div id="feDetails" class="text-slate-400 text-sm"></div>
                </div>

                <!-- Wall Detection Check -->
                <div id="wallCheck" class="diagnostic-card rounded-lg border border-slate-800 bg-slate-900/60 p-6">
                    <h3 class="text-base font-semibold text-slate-200 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 text-amber-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <path d="M3 9h18M3 15h18M9 3v18M15 3v18"/>
                        </svg>
                        Wall Detection
                    </h3>
                    <div id="wallDetails" class="text-slate-400 text-sm"></div>
                </div>

                <!-- Data Format Check - Full Width -->
                <div id="formatCheck" class="diagnostic-card rounded-lg border border-slate-800 bg-slate-900/60 p-6 lg:col-span-2">
                    <h3 class="text-base font-semibold text-slate-200 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 text-cyan-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="16 18 22 12 16 6"/>
                            <polyline points="8 6 2 12 8 18"/>
                        </svg>
                        Data Formats
                    </h3>
                    <div id="formatDetails" class="text-slate-400 text-sm"></div>
                </div>

            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-500/10 mb-4">
                <div class="w-8 h-8 border-4 border-red-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
            <p class="text-slate-400">Click "Run Diagnostics" to start system health check</p>
        </div>
    </div>

    <script>
        async function runDiagnostics() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('overallStatus').classList.add('hidden');
            document.getElementById('issuesSection').classList.add('hidden');
            document.getElementById('warningsSection').classList.add('hidden');
            document.getElementById('checksSection').classList.add('hidden');

            try {
                const response = await fetch('/api/diagnostics');
                const result = await response.json();
                const report = result.data;

                displayOverallStatus(report);
                displayIssues(report);
                displayWarnings(report);
                displayChecks(report);

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('overallStatus').classList.remove('hidden');
                document.getElementById('checksSection').classList.remove('hidden');
            } catch (error) {
                alert('Error running diagnostics: ' + error.message);
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function displayOverallStatus(report) {
            const statusText = document.getElementById('statusText');
            const statusIcon = document.getElementById('statusIcon');
            const overallDiv = document.getElementById('overallStatus');

            if (report.overall === 'HEALTHY') {
                statusText.textContent = 'ALL SYSTEMS HEALTHY';
                statusText.className = 'text-3xl font-bold text-emerald-400';
                statusIcon.textContent = 'âœ…';
                overallDiv.className = 'rounded-lg border border-emerald-800 bg-emerald-950/40 p-6 mb-6';
            } else if (report.overall === 'DEGRADED') {
                statusText.textContent = 'SYSTEM DEGRADED';
                statusText.className = 'text-3xl font-bold text-yellow-400';
                statusIcon.textContent = 'âš ï¸';
                overallDiv.className = 'rounded-lg border border-yellow-800 bg-yellow-950/40 p-6 mb-6';
            } else {
                statusText.textContent = 'CRITICAL ISSUES DETECTED';
                statusText.className = 'text-3xl font-bold text-red-400';
                statusIcon.textContent = 'âŒ';
                overallDiv.className = 'rounded-lg border border-red-800 bg-red-950/40 p-6 mb-6';
            }
        }

        function displayIssues(report) {
            if (report.issues.length === 0) return;

            const section = document.getElementById('issuesSection');
            const list = document.getElementById('issuesList');
            list.innerHTML = report.issues.map(issue => `
                <li class="flex items-start gap-2">
                    <span class="text-red-400">â€¢</span>
                    <span class="font-medium">${issue}</span>
                </li>
            `).join('');
            section.classList.remove('hidden');
        }

        function displayWarnings(report) {
            if (report.warnings.length === 0) return;

            const section = document.getElementById('warningsSection');
            const list = document.getElementById('warningsList');
            list.innerHTML = report.warnings.map(warning => `
                <li class="flex items-start gap-2">
                    <span class="text-yellow-400">â€¢</span>
                    <span class="font-medium">${warning}</span>
                </li>
            `).join('');
            section.classList.remove('hidden');
        }

        function displayChecks(report) {
            displayCheck('ws', report.checks.websocket);
            displayCheck('depth', report.checks.orderbookDepth);
            displayCheck('fe', report.checks.featureEngine);
            displayCheck('wall', report.checks.wallDetection);
            displayCheck('format', report.checks.dataFormats);
        }

        function displayCheck(id, check) {
            if (!check) return;

            const details = document.getElementById(id + 'Details');
            const checkDiv = document.getElementById(id + 'Check');

            // Update border color based on status
            let borderClass = 'border-slate-800';
            if (check.status === 'OK') {
                borderClass = 'border-emerald-700/50';
            } else if (check.status === 'WARNING') {
                borderClass = 'border-yellow-700/50';
            } else if (check.status === 'ERROR') {
                borderClass = 'border-red-700/50';
            }

            checkDiv.className = `diagnostic-card rounded-lg border ${borderClass} bg-slate-900/60 p-6${id === 'format' ? ' lg:col-span-2' : ''}`;

            let html = `<p class="text-slate-200 font-medium mb-3">${check.message}</p>`;

            // Add extra details with better styling
            const details_items = [];

            if (check.activeSymbols !== undefined) {
                details_items.push(`<span class="text-xs text-slate-400">Active Symbols:</span> <span class="text-slate-200 font-semibold">${check.activeSymbols}</span>`);
            }
            if (check.totalSymbols !== undefined && id === 'fe') {
                details_items.push(`<span class="text-xs text-slate-400">Total Symbols:</span> <span class="text-slate-200 font-semibold">${check.totalSymbols}</span>`);
            }
            if (check.avgDepth !== undefined) {
                details_items.push(`<span class="text-xs text-slate-400">Avg Depth:</span> <span class="text-slate-200 font-semibold">${check.avgDepth.toFixed(1)} levels</span>`);
            }
            if (check.updatesPerSecond !== undefined) {
                details_items.push(`<span class="text-xs text-slate-400">Updates/sec:</span> <span class="text-emerald-400 font-semibold">${check.updatesPerSecond}</span>`);
            }
            if (check.symbolsWithWalls !== undefined) {
                details_items.push(`<span class="text-xs text-slate-400">Symbols with Walls:</span> <span class="text-slate-200 font-semibold">${check.symbolsWithWalls} / ${check.totalSymbols || 500}</span>`);
            }

            if (details_items.length > 0) {
                html += `<div class="space-y-1">${details_items.map(item => `<p class="text-sm">${item}</p>`).join('')}</div>`;
            }

            if (check.samples && check.samples.length > 0) {
                html += `<details class="mt-3">
                    <summary class="text-xs text-slate-400 cursor-pointer hover:text-slate-300">View samples</summary>
                    <pre class="text-xs mt-2 p-3 bg-slate-950/50 rounded border border-slate-800 text-slate-300 overflow-x-auto">${JSON.stringify(check.samples, null, 2)}</pre>
                </details>`;
            }

            if (check.engines) {
                const engineList = Object.entries(check.engines)
                    .map(([name, active]) => `<span class="${active ? 'text-emerald-400' : 'text-slate-600'}">${name}</span>`)
                    .join(', ');
                html += `<p class="text-xs text-slate-400 mt-2">Engines: ${engineList}</p>`;
            }

            details.innerHTML = html;
        }

        // Auto-run on load
        window.addEventListener('load', runDiagnostics);
    </script>
</body>
</html>
