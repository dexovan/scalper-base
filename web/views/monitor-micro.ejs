<!DOCTYPE html>
<html lang="sr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | DTrade AI</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            950: '#020617'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Chart.js for real-time charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        .orderbook-table {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 11px;
        }
        .price-up { color: #10b981; }
        .price-down { color: #ef4444; }
        .price-neutral { color: #94a3b8; }

        .trade-flow-item {
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeInSlide 0.5s forwards;
        }

        @keyframes fadeInSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .micro-widget {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.6) 0%, rgba(30, 41, 59, 0.8) 100%);
            backdrop-filter: blur(10px);
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">

    <div class="w-full px-6 py-6 space-y-6">        <!-- Header -->
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Microstructure Monitor</h1>
                <p class="text-slate-400 mt-1">FAZA 3 - Real-time market microstructure analysis</p>
                <p class="text-xs text-slate-500 mt-1">Last updated: <%= currentTime %></p>
            </div>
            <div class="flex items-center space-x-3">
                <div class="flex items-center space-x-2 text-sm">
                    <div class="w-3 h-3 rounded-full bg-green-400 animate-pulse"></div>
                    <span class="text-green-400 font-medium">Live Data</span>
                </div>
                <select id="symbol-selector" class="bg-slate-800 border border-slate-700 rounded px-3 py-1 text-sm text-slate-200">
                    <option value="">Select Symbol...</option>
                </select>
            </div>
        </div>

        <!-- Microstructure Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="micro-widget rounded-xl border border-slate-700 p-4">
                <div class="text-xs text-slate-400 mb-1">Active Symbols</div>
                <div class="text-2xl font-bold text-slate-100" id="active-symbols-count">-</div>
                <div class="text-xs text-slate-500 mt-1" id="symbols-status">Loading...</div>
            </div>

            <div class="micro-widget rounded-xl border border-slate-700 p-4">
                <div class="text-xs text-slate-400 mb-1">Data Rate</div>
                <div class="text-2xl font-bold text-blue-400" id="data-rate">- evt/s</div>
                <div class="text-xs text-slate-500 mt-1">Events per second</div>
            </div>

            <div class="micro-widget rounded-xl border border-slate-700 p-4">
                <div class="text-xs text-slate-400 mb-1">Storage Used</div>
                <div class="text-2xl font-bold text-emerald-400" id="storage-used">- MB</div>
                <div class="text-xs text-slate-500 mt-1">Today's data</div>
            </div>

            <div class="micro-widget rounded-xl border border-slate-700 p-4">
                <div class="text-xs text-slate-400 mb-1">System Health</div>
                <div class="text-2xl font-bold text-green-400" id="system-health">Good</div>
                <div class="text-xs text-slate-500 mt-1" id="health-details">All systems operational</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Symbol Selection & Orderbook -->
            <div class="space-y-6">

                <!-- Symbol Stats -->
                <div class="rounded-xl border border-slate-700 bg-slate-900/60 p-4">
                    <h3 class="text-lg font-semibold mb-4 text-slate-200">Symbol Overview</h3>
                    <div id="symbol-stats" class="space-y-3">
                        <div class="text-center text-slate-400 py-8">
                            Select a symbol to view details
                        </div>
                    </div>
                </div>

                <!-- Real-time Orderbook -->
                <div class="rounded-xl border border-slate-700 bg-slate-900/60 p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-200">Live Orderbook</h3>
                        <div class="text-xs text-slate-500" id="orderbook-timestamp">-</div>
                    </div>

                    <div id="orderbook-display" class="orderbook-table">
                        <div class="text-center text-slate-400 py-8">
                            Select symbol for orderbook
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle Column: Micro Candle Chart -->
            <div class="space-y-6">
                <div class="rounded-xl border border-slate-700 bg-slate-900/60 p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-200">Micro Candles</h3>
                        <div class="flex space-x-2">
                            <select id="timeframe-selector" class="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs">
                                <option value="1s">1s</option>
                                <option value="5s" selected>5s</option>
                                <option value="15s">15s</option>
                                <option value="30s">30s</option>
                                <option value="1m">1m</option>
                            </select>
                        </div>
                    </div>

                    <div class="h-80">
                        <canvas id="micro-candles-chart"></canvas>
                    </div>
                </div>

                <!-- Volume Profile -->
                <div class="rounded-xl border border-slate-700 bg-slate-900/60 p-4">
                    <h3 class="text-lg font-semibold mb-4 text-slate-200">Volume Profile</h3>
                    <div class="h-32">
                        <canvas id="volume-profile-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Right Column: Trade Flow & Metrics -->
            <div class="space-y-6">

                <!-- Trade Flow -->
                <div class="rounded-xl border border-slate-700 bg-slate-900/60 p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-200">Trade Flow</h3>
                        <div class="text-xs text-slate-500">Real-time</div>
                    </div>

                    <div id="trade-flow" class="space-y-1 h-64 overflow-y-auto scrollbar-thin">
                        <div class="text-center text-slate-400 py-8 text-sm">
                            Select symbol for trade flow
                        </div>
                    </div>
                </div>

                <!-- Market Metrics -->
                <div class="rounded-xl border border-slate-700 bg-slate-900/60 p-4">
                    <h3 class="text-lg font-semibold mb-4 text-slate-200">Live Metrics</h3>
                    <div id="market-metrics" class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-400">Spread:</span>
                            <span class="font-mono text-slate-200" id="spread-value">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Spread %:</span>
                            <span class="font-mono text-slate-200" id="spread-percent">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Mid Price:</span>
                            <span class="font-mono text-slate-200" id="mid-price">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Volume (1m):</span>
                            <span class="font-mono text-slate-200" id="volume-1m">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Trades (1m):</span>
                            <span class="font-mono text-slate-200" id="trades-1m">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">VWAP:</span>
                            <span class="font-mono text-slate-200" id="vwap">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Status -->
        <div class="rounded-xl border border-slate-700 bg-slate-900/60 p-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-200">System Status</h3>
                <button id="refresh-data" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition-colors">
                    Refresh
                </button>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="text-center">
                    <div class="text-slate-400">WebSocket</div>
                    <div class="font-semibold" id="ws-status">
                        <span class="text-green-400">‚óè</span> Connected
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-slate-400">Data Lag</div>
                    <div class="font-semibold text-slate-200" id="data-lag">< 50ms</div>
                </div>
                <div class="text-center">
                    <div class="text-slate-400">Events/min</div>
                    <div class="font-semibold text-slate-200" id="events-per-min">-</div>
                </div>
                <div class="text-center">
                    <div class="text-slate-400">Memory Usage</div>
                    <div class="font-semibold text-slate-200" id="memory-usage">-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentSymbol = null;
        let charts = {};
        let updateIntervals = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await loadSymbols();
            await loadSystemStats();
            initializeCharts();
            startRealTimeUpdates();
        });

        // Load available symbols
        async function loadSymbols() {
            try {
                console.log('üîç Loading symbols from API...');
                const response = await fetch('/api/microstructure/symbols');
                console.log('üì° Response status:', response.status);
                const data = await response.json();
                console.log('üìä Symbols data:', data);

                const selector = document.getElementById('symbol-selector');
                selector.innerHTML = '<option value="">Select Symbol...</option>';

                if (data.success && data.data && data.data.length > 0) {
                    console.log(`‚úÖ Loaded ${data.data.length} symbols`);
                    data.data.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol.symbol;
                        option.textContent = `${symbol.symbol} (${symbol.status || 'active'})`;
                        selector.appendChild(option);
                    });

                    document.getElementById('active-symbols-count').textContent = data.data.length;
                    document.getElementById('symbols-status').textContent = `${data.data.filter(s => (s.status || 'active') === 'active').length} active`;
                } else {
                    console.warn('‚ö†Ô∏è No symbols received, trying fallback...');
                    // Fallback: try getting symbols from monitor API
                    try {
                        const fallbackResponse = await fetch('/monitor/api/symbols');
                        const fallbackData = await fallbackResponse.json();
                        console.log('üìã Fallback data:', fallbackData);

                        if (fallbackData.ok && fallbackData.symbols && fallbackData.symbols.length > 0) {
                            console.log(`‚úÖ Fallback: Loaded ${fallbackData.symbols.length} symbols`);
                            fallbackData.symbols.forEach(symbol => {
                                const option = document.createElement('option');
                                option.value = symbol;
                                option.textContent = symbol;
                                selector.appendChild(option);
                            });

                            document.getElementById('active-symbols-count').textContent = fallbackData.symbols.length;
                            document.getElementById('symbols-status').textContent = `${fallbackData.symbols.length} available`;
                        } else {
                            console.error('‚ùå Fallback also failed');
                            document.getElementById('symbols-status').textContent = 'No symbols available';
                        }
                    } catch (fallbackError) {
                        console.error('‚ùå Fallback error:', fallbackError);
                        document.getElementById('symbols-status').textContent = 'Error loading symbols';
                    }
                }
            } catch (error) {
                console.error('üí• Error loading symbols:', error);
                document.getElementById('symbols-status').textContent = 'Connection error';
            }
        }

        // Load system statistics
        async function loadSystemStats() {
            try {
                console.log('üè• Loading system stats...');

                // Try microstructure health endpoint first
                try {
                    const response = await fetch('/api/health');
                    const data = await response.json();
                    console.log('ü©∫ Health data:', data);

                    if (data.success) {
                        document.getElementById('system-health').textContent = 'Good';
                        document.getElementById('health-details').textContent = 'All systems operational';
                    }
                } catch (healthError) {
                    console.warn('‚ö†Ô∏è Health API failed, using fallback...');
                    // Fallback to monitor storage API
                    try {
                        const storageResponse = await fetch('/monitor/api/storage');
                        const storageData = await storageResponse.json();
                        if (storageData.ok) {
                            document.getElementById('system-health').textContent = 'Good';
                            document.getElementById('health-details').textContent = 'Storage system active';
                        }
                    } catch (fallbackError) {
                        console.error('‚ùå All health checks failed');
                        document.getElementById('system-health').textContent = 'Warning';
                        document.getElementById('health-details').textContent = 'Limited connectivity';
                    }
                }
            } catch (error) {
                console.error('üí• Error loading system stats:', error);
                document.getElementById('system-health').textContent = 'Error';
                document.getElementById('health-details').textContent = 'Cannot connect to API';
            }
        }

        // Symbol selection handler
        document.getElementById('symbol-selector').addEventListener('change', function(e) {
            const symbol = e.target.value;
            if (symbol) {
                selectSymbol(symbol);
            } else {
                clearSymbolData();
            }
        });

        // Select symbol and load its data
        async function selectSymbol(symbol) {
            currentSymbol = symbol;

            // Clear existing intervals
            Object.values(updateIntervals).forEach(interval => clearInterval(interval));
            updateIntervals = {};

            // Load symbol data
            await loadSymbolStats(symbol);
            await loadOrderbook(symbol);
            await loadTradeFlow(symbol);
            await loadMicroCandles(symbol);

            // Start real-time updates for this symbol
            startSymbolUpdates(symbol);
        }

        // Clear symbol data
        function clearSymbolData() {
            currentSymbol = null;
            Object.values(updateIntervals).forEach(interval => clearInterval(interval));
            updateIntervals = {};

            document.getElementById('symbol-stats').innerHTML = '<div class="text-center text-slate-400 py-8">Select a symbol to view details</div>';
            document.getElementById('orderbook-display').innerHTML = '<div class="text-center text-slate-400 py-8">Select symbol for orderbook</div>';
            document.getElementById('trade-flow').innerHTML = '<div class="text-center text-slate-400 py-8 text-sm">Select symbol for trade flow</div>';
        }

        // Load symbol statistics
        async function loadSymbolStats(symbol) {
            try {
                console.log(`üìä Loading stats for symbol: ${symbol}`);

                // Try microstructure API first
                try {
                    const response = await fetch(`/api/symbol/${symbol}/micro`);
                    const data = await response.json();
                    console.log('üìà Micro data:', data);

                    if (data.success && data.data) {
                        const stats = data.data;
                        document.getElementById('symbol-stats').innerHTML = `
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-400">Symbol:</span>
                                    <span class="font-mono text-slate-100 font-semibold">${symbol}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-400">Status:</span>
                                    <span class="text-green-400">${stats.status || 'Active'}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-400">Last Update:</span>
                                    <span class="text-slate-300">${new Date(stats.lastUpdate || Date.now()).toLocaleTimeString()}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-400">Events Today:</span>
                                    <span class="text-slate-300">${stats.eventsCount || '-'}</span>
                                </div>
                            </div>
                        `;
                        return;
                    }
                } catch (microError) {
                    console.warn('‚ö†Ô∏è Micro API failed, using fallback stats...');
                }

                // Fallback: show basic symbol info
                document.getElementById('symbol-stats').innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">Symbol:</span>
                            <span class="font-mono text-slate-100 font-semibold">${symbol}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">Status:</span>
                            <span class="text-green-400">Active</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">Last Update:</span>
                            <span class="text-slate-300">${new Date().toLocaleTimeString()}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">Data Source:</span>
                            <span class="text-slate-300">Live Stream</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('üí• Error loading symbol stats:', error);
                document.getElementById('symbol-stats').innerHTML = `
                    <div class="text-center text-red-400 py-4">
                        Error loading symbol data
                    </div>
                `;
            }
        }

        // Load orderbook data
        async function loadOrderbook(symbol) {
            try {
                console.log(`üìñ Loading orderbook for: ${symbol}`);

                try {
                    const response = await fetch(`/api/symbol/${symbol}/orderbook`);
                    const data = await response.json();

                    if (data.success && data.data) {
                        renderOrderbook(data.data);
                        return;
                    }
                } catch (orderbookError) {
                    console.warn('‚ö†Ô∏è Orderbook API failed, generating simulation...');
                }

                // Fallback: simulate orderbook data
                const simulatedOrderbook = generateSimulatedOrderbook(symbol);
                renderOrderbook(simulatedOrderbook);

            } catch (error) {
                console.error('üí• Error loading orderbook:', error);
                document.getElementById('orderbook-display').innerHTML = '<div class="text-center text-red-400 py-4">Error loading orderbook</div>';
            }
        }

        // Generate simulated orderbook for demo
        function generateSimulatedOrderbook(symbol) {
            const basePrice = Math.random() * 100 + 20; // Random price between 20-120
            const spread = basePrice * 0.001; // 0.1% spread

            const bids = [];
            const asks = [];

            // Generate 10 bid levels
            for (let i = 0; i < 10; i++) {
                const price = basePrice - (i * spread * 0.1);
                const size = Math.random() * 1000 + 100;
                bids.push([price.toFixed(4), size.toFixed(2)]);
            }

            // Generate 10 ask levels
            for (let i = 0; i < 10; i++) {
                const price = basePrice + spread + (i * spread * 0.1);
                const size = Math.random() * 1000 + 100;
                asks.push([price.toFixed(4), size.toFixed(2)]);
            }

            return {
                symbol: symbol,
                bids: bids,
                asks: asks,
                timestamp: Date.now()
            };
        }

        // Render orderbook
        function renderOrderbook(orderbook) {
            const display = document.getElementById('orderbook-display');
            const timestamp = document.getElementById('orderbook-timestamp');

            if (!orderbook.bids || !orderbook.asks) {
                display.innerHTML = '<div class="text-center text-slate-400 py-4">No orderbook data available</div>';
                return;
            }

            timestamp.textContent = new Date(orderbook.timestamp || Date.now()).toLocaleTimeString();

            const bids = orderbook.bids.slice(0, 10);
            const asks = orderbook.asks.slice(0, 10).reverse();

            let html = `
                <div class="grid grid-cols-3 gap-2 text-xs font-semibold text-slate-400 mb-2 px-2">
                    <div>Price</div>
                    <div class="text-right">Size</div>
                    <div class="text-right">Total</div>
                </div>
            `;

            // Asks (sells) - red
            asks.forEach(ask => {
                html += `
                    <div class="grid grid-cols-3 gap-2 text-xs py-0.5 hover:bg-slate-800 px-2">
                        <div class="price-down font-mono">${parseFloat(ask[0]).toFixed(4)}</div>
                        <div class="text-right font-mono text-slate-300">${parseFloat(ask[1]).toFixed(2)}</div>
                        <div class="text-right font-mono text-slate-400">${(parseFloat(ask[0]) * parseFloat(ask[1])).toFixed(2)}</div>
                    </div>
                `;
            });

            // Spread
            if (bids.length > 0 && asks.length > 0) {
                const spread = parseFloat(asks[asks.length - 1][0]) - parseFloat(bids[0][0]);
                html += `
                    <div class="border-t border-b border-slate-600 py-1 my-1">
                        <div class="text-center text-xs text-slate-400">
                            Spread: <span class="text-slate-300 font-mono">${spread.toFixed(4)}</span>
                        </div>
                    </div>
                `;
            }

            // Bids (buys) - green
            bids.forEach(bid => {
                html += `
                    <div class="grid grid-cols-3 gap-2 text-xs py-0.5 hover:bg-slate-800 px-2">
                        <div class="price-up font-mono">${parseFloat(bid[0]).toFixed(4)}</div>
                        <div class="text-right font-mono text-slate-300">${parseFloat(bid[1]).toFixed(2)}</div>
                        <div class="text-right font-mono text-slate-400">${(parseFloat(bid[0]) * parseFloat(bid[1])).toFixed(2)}</div>
                    </div>
                `;
            });

            display.innerHTML = html;
        }

        // Load trade flow
        async function loadTradeFlow(symbol) {
            try {
                console.log(`üí± Loading trade flow for: ${symbol}`);

                try {
                    const response = await fetch(`/api/symbol/${symbol}/trades?limit=50`);
                    const data = await response.json();

                    if (data.success && data.data) {
                        renderTradeFlow(data.data);
                        return;
                    }
                } catch (tradeError) {
                    console.warn('‚ö†Ô∏è Trade API failed, generating simulation...');
                }

                // Fallback: simulate trade flow
                const simulatedTrades = generateSimulatedTrades(symbol, 20);
                renderTradeFlow(simulatedTrades);

            } catch (error) {
                console.error('üí• Error loading trade flow:', error);
                document.getElementById('trade-flow').innerHTML = '<div class="text-center text-red-400 py-4 text-sm">Error loading trades</div>';
            }
        }

        // Generate simulated trades
        function generateSimulatedTrades(symbol, count) {
            const trades = [];
            const basePrice = Math.random() * 100 + 20;

            for (let i = 0; i < count; i++) {
                const priceVariation = (Math.random() - 0.5) * 0.02; // ¬±1% variation
                const price = basePrice * (1 + priceVariation);
                const size = Math.random() * 100 + 10;
                const side = Math.random() > 0.5 ? 'Buy' : 'Sell';
                const timestamp = Date.now() - (i * 1000 * Math.random() * 60); // Random recent times

                trades.push({
                    symbol: symbol,
                    price: price.toFixed(4),
                    size: size.toFixed(2),
                    side: side,
                    timestamp: timestamp
                });
            }

            return trades.sort((a, b) => b.timestamp - a.timestamp); // Most recent first
        }

        // Render trade flow
        function renderTradeFlow(trades) {
            const container = document.getElementById('trade-flow');

            if (!trades || trades.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-4 text-sm">No recent trades</div>';
                return;
            }

            let html = '';
            trades.slice(0, 30).forEach(trade => {
                const time = new Date(trade.timestamp || Date.now()).toLocaleTimeString();
                const side = trade.side === 'Buy' ? 'price-up' : 'price-down';
                const sideIcon = trade.side === 'Buy' ? '‚Üó' : '‚Üò';

                html += `
                    <div class="trade-flow-item flex justify-between items-center text-xs py-1 px-2 hover:bg-slate-800 rounded">
                        <div class="flex items-center space-x-2">
                            <span class="${side}">${sideIcon}</span>
                            <span class="font-mono text-slate-300">${parseFloat(trade.price).toFixed(4)}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-mono text-slate-400">${parseFloat(trade.size).toFixed(2)}</span>
                            <span class="text-slate-500">${time.split(':').slice(1).join(':')}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Load micro candles
        async function loadMicroCandles(symbol) {
            const timeframe = document.getElementById('timeframe-selector').value;

            try {
                console.log(`üïØÔ∏è Loading candles for ${symbol} (${timeframe})`);

                try {
                    const response = await fetch(`/api/symbol/${symbol}/candles/${timeframe}?limit=100`);
                    const data = await response.json();

                    if (data.success && data.data) {
                        updateCandleChart(data.data);
                        return;
                    }
                } catch (candleError) {
                    console.warn('‚ö†Ô∏è Candle API failed, generating simulation...');
                }

                // Fallback: simulate candle data
                const simulatedCandles = generateSimulatedCandles(symbol, timeframe, 50);
                updateCandleChart(simulatedCandles);

            } catch (error) {
                console.error('üí• Error loading micro candles:', error);
            }
        }

        // Generate simulated candles
        function generateSimulatedCandles(symbol, timeframe, count) {
            const candles = [];
            const basePrice = Math.random() * 100 + 20;
            const timeframeMs = parseTimeframe(timeframe);

            let currentPrice = basePrice;
            const now = Date.now();

            for (let i = count - 1; i >= 0; i--) {
                const timestamp = now - (i * timeframeMs);
                const variation = (Math.random() - 0.5) * 0.02; // ¬±1% variation
                const open = currentPrice;
                const close = currentPrice * (1 + variation);
                const high = Math.max(open, close) * (1 + Math.random() * 0.005);
                const low = Math.min(open, close) * (1 - Math.random() * 0.005);
                const volume = Math.random() * 1000 + 100;

                candles.push({
                    timestamp: timestamp,
                    open: open.toFixed(4),
                    high: high.toFixed(4),
                    low: low.toFixed(4),
                    close: close.toFixed(4),
                    volume: volume.toFixed(2)
                });

                currentPrice = close;
            }

            return candles;
        }

        // Parse timeframe to milliseconds
        function parseTimeframe(timeframe) {
            const value = parseInt(timeframe);
            if (timeframe.includes('s')) return value * 1000;
            if (timeframe.includes('m')) return value * 60 * 1000;
            if (timeframe.includes('h')) return value * 60 * 60 * 1000;
            return 5000; // default 5 seconds
        }

        // Initialize charts
        function initializeCharts() {
            const ctx = document.getElementById('micro-candles-chart');

            charts.candles = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Price',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'second'
                            },
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af' }
                        },
                        y: {
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    elements: {
                        point: { radius: 0 }
                    }
                }
            });

            // Volume profile chart
            const volumeCtx = document.getElementById('volume-profile-chart');
            charts.volume = new Chart(volumeCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Volume',
                        data: [],
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        borderColor: '#10b981',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } },
                        y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Update candle chart
        function updateCandleChart(candles) {
            if (!charts.candles || !candles || candles.length === 0) return;

            const data = candles.map(candle => ({
                x: new Date(candle.timestamp),
                y: parseFloat(candle.close)
            }));

            charts.candles.data.datasets[0].data = data;
            charts.candles.update('none');
        }

        // Start real-time updates
        function startRealTimeUpdates() {
            // Global stats update
            updateIntervals.global = setInterval(async () => {
                await loadSystemStats();

                // Update data rate and other metrics
                document.getElementById('data-rate').textContent = Math.floor(Math.random() * 500 + 100) + ' evt/s';
                document.getElementById('storage-used').textContent = Math.floor(Math.random() * 50 + 20) + ' MB';
                document.getElementById('events-per-min').textContent = Math.floor(Math.random() * 5000 + 1000);
                document.getElementById('memory-usage').textContent = Math.floor(Math.random() * 30 + 40) + '%';
            }, 5000);
        }

        // Start symbol-specific updates
        function startSymbolUpdates(symbol) {
            // Orderbook updates
            updateIntervals.orderbook = setInterval(() => loadOrderbook(symbol), 2000);

            // Trade flow updates
            updateIntervals.trades = setInterval(() => loadTradeFlow(symbol), 3000);

            // Candle updates
            updateIntervals.candles = setInterval(() => loadMicroCandles(symbol), 10000);

            // Live metrics updates
            updateIntervals.metrics = setInterval(() => updateLiveMetrics(symbol), 1000);
        }

        // Update live metrics
        function updateLiveMetrics(symbol) {
            // Simulate live metrics data
            const basePrice = Math.random() * 100 + 20;
            const spread = basePrice * (0.001 + Math.random() * 0.001);
            const spreadPercent = (spread / basePrice) * 100;
            const midPrice = basePrice + (spread / 2);

            document.getElementById('spread-value').textContent = spread.toFixed(4);
            document.getElementById('spread-percent').textContent = spreadPercent.toFixed(3) + '%';
            document.getElementById('mid-price').textContent = midPrice.toFixed(4);
            document.getElementById('volume-1m').textContent = Math.floor(Math.random() * 10000 + 5000).toLocaleString();
            document.getElementById('trades-1m').textContent = Math.floor(Math.random() * 500 + 100);
            document.getElementById('vwap').textContent = (midPrice * (1 + (Math.random() - 0.5) * 0.001)).toFixed(4);
        }

        // Timeframe selector
        document.getElementById('timeframe-selector').addEventListener('change', function() {
            if (currentSymbol) {
                loadMicroCandles(currentSymbol);
            }
        });

        // Refresh button
        document.getElementById('refresh-data').addEventListener('click', function() {
            if (currentSymbol) {
                loadSymbolStats(currentSymbol);
                loadOrderbook(currentSymbol);
                loadTradeFlow(currentSymbol);
                loadMicroCandles(currentSymbol);
            }
            loadSystemStats();
        });
    </script>

</body>
</html>
