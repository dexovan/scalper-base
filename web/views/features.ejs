<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature Engine - DTrade Scalper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        .feature-card {
            transition: all 0.2s ease;
        }
        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }
        .metric-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .risk-low { background: rgba(34, 197, 94, 0.1); color: rgb(34, 197, 94); }
        .risk-medium { background: rgba(234, 179, 8, 0.1); color: rgb(234, 179, 8); }
        .risk-high { background: rgba(239, 68, 68, 0.1); color: rgb(239, 68, 68); }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">

    <main class="container mx-auto px-4 py-6 space-y-6 max-w-7xl">

        <!-- Summary Stats -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-slate-400 uppercase">Active Symbols</span>
                    <svg class="w-5 h-5 text-violet-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12h18M9 6h6M12 3v18"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold text-slate-100" id="stat-active-symbols">-</p>
                <p class="text-xs text-slate-500 mt-1">of <span id="stat-total-symbols">-</span> total</p>
            </div>

            <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-slate-400 uppercase">Updates/Second</span>
                    <svg class="w-5 h-5 text-emerald-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold text-emerald-400" id="stat-updates-per-sec">-</p>
                <p class="text-xs text-slate-500 mt-1">Real-time processing</p>
            </div>

            <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-slate-400 uppercase">Total Processed</span>
                    <svg class="w-5 h-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold text-blue-400" id="stat-total-processed">-</p>
                <p class="text-xs text-slate-500 mt-1">Since startup</p>
            </div>

            <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-slate-400 uppercase">Avg Time</span>
                    <svg class="w-5 h-5 text-amber-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold text-amber-400" id="stat-avg-time">-</p>
                <p class="text-xs text-slate-500 mt-1">milliseconds</p>
            </div>
        </section>

        <!-- Engine Status -->
        <section class="rounded-lg border border-slate-800 bg-slate-900/60 p-6">
            <h2 class="text-lg font-semibold text-slate-200 mb-4">Analysis Engines</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="text-center p-3 rounded-md bg-slate-800/50 border border-slate-700">
                    <div class="w-8 h-8 mx-auto mb-2 rounded-full bg-violet-500/20 flex items-center justify-center">
                        <span class="text-sm" id="engine-imbalance-status">✓</span>
                    </div>
                    <p class="text-xs font-medium text-slate-300">Imbalance</p>
                </div>
                <div class="text-center p-3 rounded-md bg-slate-800/50 border border-slate-700">
                    <div class="w-8 h-8 mx-auto mb-2 rounded-full bg-violet-500/20 flex items-center justify-center">
                        <span class="text-sm" id="engine-walls-status">✓</span>
                    </div>
                    <p class="text-xs font-medium text-slate-300">Walls</p>
                </div>
                <div class="text-center p-3 rounded-md bg-slate-800/50 border border-slate-700">
                    <div class="w-8 h-8 mx-auto mb-2 rounded-full bg-violet-500/20 flex items-center justify-center">
                        <span class="text-sm" id="engine-flow-status">✓</span>
                    </div>
                    <p class="text-xs font-medium text-slate-300">Flow</p>
                </div>
                <div class="text-center p-3 rounded-md bg-slate-800/50 border border-slate-700">
                    <div class="w-8 h-8 mx-auto mb-2 rounded-full bg-violet-500/20 flex items-center justify-center">
                        <span class="text-sm" id="engine-volatility-status">✓</span>
                    </div>
                    <p class="text-xs font-medium text-slate-300">Volatility</p>
                </div>
                <div class="text-center p-3 rounded-md bg-slate-800/50 border border-slate-700">
                    <div class="w-8 h-8 mx-auto mb-2 rounded-full bg-violet-500/20 flex items-center justify-center">
                        <span class="text-sm" id="engine-leverage-status">○</span>
                    </div>
                    <p class="text-xs font-medium text-slate-300">Leverage</p>
                </div>
                <div class="text-center p-3 rounded-md bg-slate-800/50 border border-slate-700">
                    <div class="w-8 h-8 mx-auto mb-2 rounded-full bg-violet-500/20 flex items-center justify-center">
                        <span class="text-sm" id="engine-pumps-status">○</span>
                    </div>
                    <p class="text-xs font-medium text-slate-300">Pumps</p>
                </div>
            </div>
        </section>

        <!-- Top Symbols by Risk -->
        <section class="rounded-lg border border-slate-800 bg-slate-900/60 p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-slate-200">Top Symbols by Risk Score</h2>
                <select id="filter-tier" class="px-3 py-1.5 rounded-md bg-slate-800 border border-slate-700 text-slate-300 text-sm">
                    <option value="all">All Tiers</option>
                    <option value="prime">Prime</option>
                    <option value="normal">Normal</option>
                    <option value="wild">Wild</option>
                </select>
            </div>
            <div id="symbols-container" class="space-y-3">
                <div class="text-center py-8 text-slate-500">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    <p>Loading symbols...</p>
                </div>
            </div>
        </section>

    </main>

    <script>
        // Fetch and display feature engine data
        async function loadFeatureData() {
            try {
                const [healthRes, overviewRes] = await Promise.all([
                    fetch('/api/features/health'),
                    fetch('/api/features/overview')
                ]);

                const healthData = await healthRes.json();
                const overviewData = await overviewRes.json();

                if (healthData.status === 'success') {
                    updateHealthStats(healthData.data);
                }

                if (overviewData.status === 'success') {
                    updateSymbolsList(overviewData.data);
                }
            } catch (error) {
                console.error('Failed to load feature data:', error);
            }
        }

        function updateHealthStats(data) {
            document.getElementById('stat-active-symbols').textContent = data.activeSymbols || 0;
            document.getElementById('stat-total-symbols').textContent = data.totalSymbols || 0;
            document.getElementById('stat-updates-per-sec').textContent = data.performanceMetrics?.updatesPerSecond || 0;
            document.getElementById('stat-total-processed').textContent = (data.performanceMetrics?.symbolsProcessed || 0).toLocaleString();
            document.getElementById('stat-avg-time').textContent = (data.performanceMetrics?.averageUpdateTime || 0).toFixed(2);

            // Update engine statuses
            const engines = data.engines || {};
            document.getElementById('engine-imbalance-status').textContent = engines.imbalance ? '✓' : '✗';
            document.getElementById('engine-walls-status').textContent = engines.walls ? '✓' : '✗';
            document.getElementById('engine-flow-status').textContent = engines.flow ? '✓' : '✗';
            document.getElementById('engine-volatility-status').textContent = engines.volatility ? '✓' : '✗';
            document.getElementById('engine-leverage-status').textContent = engines.leverage ? '✓' : '○';
            document.getElementById('engine-pumps-status').textContent = engines.pumps ? '✓' : '○';
        }

        function updateSymbolsList(symbols) {
            const container = document.getElementById('symbols-container');

            if (!symbols || symbols.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-slate-500">No symbols data available</div>';
                return;
            }

            // Filter out symbols without valid data (futures/options without prices or tier)
            const validSymbols = symbols.filter(sym => {
                // Must have current price
                if (!sym.currentPrice || sym.currentPrice === 0) return false;
                // Must have tier (not 'unknown')
                if (!sym.tier || sym.tier === 'unknown') return false;
                // Must have some feature data
                if (!sym.imbalance && !sym.flow && !sym.volatility) return false;
                return true;
            });

            if (validSymbols.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-slate-500">No valid symbols data available</div>';
                return;
            }

            // Sort by risk score descending
            const sorted = validSymbols.sort((a, b) => (b.overallRiskScore || 0) - (a.overallRiskScore || 0));
            const top20 = sorted.slice(0, 20);

            container.innerHTML = top20.map(sym => `
                <div class="feature-card p-4 rounded-lg border border-slate-700 bg-slate-800/50 hover:border-violet-600">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <span class="text-lg font-bold text-slate-100">${sym.symbol}</span>
                            <span class="metric-badge ${getRiskClass(sym.overallRiskScore)}">
                                Risk: ${(sym.overallRiskScore || 0).toFixed(2)}
                            </span>
                            <span class="text-xs px-2 py-1 rounded bg-slate-700 text-slate-300">${sym.marketCondition || 'UNKNOWN'}</span>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium text-slate-300">$${sym.currentPrice?.toFixed(4) || 'N/A'}</p>
                            <p class="text-xs text-slate-500">Tier: ${sym.tier || 'unknown'}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 text-xs">
                        <div>
                            <p class="text-slate-500 mb-1">Imbalance</p>
                            <p class="font-semibold ${getImbalanceColor(sym.imbalance?.ratio)}">
                                ${(sym.imbalance?.ratio || 0).toFixed(2)}
                            </p>
                        </div>
                        <div>
                            <p class="text-slate-500 mb-1">Flow Score</p>
                            <p class="font-semibold text-blue-400">${(sym.flow?.flowScore || 0).toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-slate-500 mb-1">Volatility</p>
                            <p class="font-semibold text-amber-400">${(sym.volatility?.volatility || 0).toFixed(4)}</p>
                        </div>
                        <div>
                            <p class="text-slate-500 mb-1">Walls</p>
                            <p class="font-semibold ${sym.walls?.hasLargeWalls ? 'text-red-400' : 'text-slate-400'}">
                                ${sym.walls?.hasLargeWalls ? 'Yes' : 'No'}
                            </p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getRiskClass(score) {
            if (score > 0.7) return 'risk-high';
            if (score > 0.4) return 'risk-medium';
            return 'risk-low';
        }

        function getImbalanceColor(ratio) {
            if (ratio > 1.5) return 'text-green-400';
            if (ratio < 0.67) return 'text-red-400';
            return 'text-slate-300';
        }

        // Tier filter
        document.getElementById('filter-tier').addEventListener('change', async (e) => {
            const tier = e.target.value;
            const res = await fetch('/api/features/overview');
            const data = await res.json();

            if (data.status === 'success') {
                let filtered = data.data;
                if (tier !== 'all') {
                    filtered = filtered.filter(s => s.tier === tier);
                }
                updateSymbolsList(filtered);
            }
        });

        // Auto-refresh every 5 seconds
        loadFeatureData();
        setInterval(loadFeatureData, 5000);
    </script>

</body>
</html>
