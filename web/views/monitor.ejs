<!-- web/views/monitor.ejs -->

<div class="min-h-screen bg-[#0d1117] text-slate-100">
  <div class="max-w-6xl mx-auto p-6 space-y-6">

    <!-- NASLOV + OPIS STRANE -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-sky-400 flex items-center gap-2">
          <span>ğŸ“¡</span> System Monitor
        </h1>
        <p class="text-slate-400 mt-1 max-w-2xl">
          Pregled rada <span class="font-semibold text-sky-300">DTrade engine-a</span>,
          Bybit WebSocket konekcije i sistemskih resursa. Ovo je tvoja
          kontrolna tabla da vidiÅ¡ da li â€ispod haubeâ€œ sve radi kako treba.
        </p>
      </div>

      <div class="flex items-center gap-3">
        <form method="GET" action="/monitor">
          <button
            type="submit"
            class="px-4 py-2 rounded-md bg-sky-600 hover:bg-sky-500 text-sm font-semibold shadow-md transition"
          >
            ğŸ”„ OsveÅ¾i sada
          </button>
        </form>
        <div class="text-xs text-slate-500">
          Last update:<br />
          <span class="text-slate-300"><%= new Date(summary.timestamp).toLocaleString() %></span>
        </div>
      </div>
    </div>

    <!-- GRID: SYSTEM + WS + ENGINE -->
    <div class="grid gap-6 md:grid-cols-3">

      <!-- SYSTEM BOX -->
      <section class="bg-[#111827] rounded-xl border border-slate-800 p-5 shadow-lg">
        <h2 class="text-lg font-semibold text-sky-300 flex items-center gap-2 mb-2">
          ğŸ–¥ï¸ System
        </h2>
        <p class="text-xs text-slate-400 mb-4">
          Ovde pratiÅ¡ resurse servera (CPU load, memorija, uptime).
          Ako ovo polje â€pobegne u crvenoâ€œ, znaÅ¡ da treba da proveriÅ¡ server
          pre nego Å¡to trejderu daÅ¡ gas.
        </p>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-slate-400">Uptime:</span>
            <span class="font-mono text-slate-100"><%= summary.system.uptimeHuman %></span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Load (1m):</span>
            <span class="font-mono <%= summary.system.load1m > 3 ? 'text-amber-400' : 'text-emerald-400' %>">
              <%= summary.system.load1m %>
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">RSS memorija:</span>
            <span class="font-mono text-slate-100"><%= summary.system.memory.rssMB %> MB</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Heap used:</span>
            <span class="font-mono text-slate-100"><%= summary.system.memory.heapUsedMB %> MB</span>
          </div>
        </div>
      </section>

      <!-- BYBIT WS BOX -->
      <section class="bg-[#111827] rounded-xl border border-slate-800 p-5 shadow-lg">
        <h2 class="text-lg font-semibold text-sky-300 flex items-center gap-2 mb-2">
          ğŸŒ Bybit WS
        </h2>
        <p class="text-xs text-slate-400 mb-4">
          Status konekcije ka Bybit public WebSocket feed-u.
          Kada je sve u redu, oÄekujeÅ¡ da je status <span class="text-emerald-400 font-semibold">Connected</span>
          i da postoji normalan protok poruka (tick rate).
        </p>

        <div class="flex items-center justify-between mb-3">
          <span class="text-slate-400">Status:</span>
          <% if (summary.ws.connected) { %>
            <span class="inline-flex items-center gap-2 text-emerald-400 font-semibold">
              <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
              Connected
            </span>
          <% } else { %>
            <span class="inline-flex items-center gap-2 text-rose-400 font-semibold">
              <span class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></span>
              Disconnected
            </span>
          <% } %>
        </div>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-slate-400">Last connect:</span>
            <span class="font-mono text-slate-100">
              <%= summary.ws.lastConnectedAt ? new Date(summary.ws.lastConnectedAt).toLocaleTimeString() : 'â€”' %>
            </span>
          </div>

          <div class="flex justify-between">
            <span class="text-slate-400">Last message:</span>
            <span class="font-mono text-slate-100">
              <%= summary.ws.lastMessageAt ? new Date(summary.ws.lastMessageAt).toLocaleTimeString() : 'â€”' %>
            </span>
          </div>

          <div class="flex justify-between">
            <span class="text-slate-400">Reconnect attempts:</span>
            <span class="font-mono text-slate-100"><%= summary.ws.reconnectAttempts %></span>
          </div>

          <div class="flex justify-between">
            <span class="text-slate-400">Tick rate (msg/s):</span>
            <span class="font-mono text-slate-100">
              <%= summary.ws.messagesPerSec != null ? summary.ws.messagesPerSec : 'N/A' %>
            </span>
          </div>
        </div>

        <div class="mt-4">
          <h3 class="text-xs font-semibold text-slate-400 mb-1">
            Aktivni streamovi:
          </h3>
          <% if (summary.ws.streams && summary.ws.streams.length > 0) { %>
            <ul class="text-xs text-slate-300 space-y-1 max-h-24 overflow-y-auto">
              <% summary.ws.streams.forEach(function (s) { %>
                <li class="font-mono bg-slate-900/60 rounded px-2 py-1 border border-slate-800">
                  <%= s %>
                </li>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="text-xs text-slate-500 italic">Trenutno nema aktivnih WS streamova.</p>
          <% } %>
        </div>

        <% if (summary.ws.lastErrorMessage) { %>
          <div class="mt-3 text-xs text-rose-400 bg-rose-950/40 border border-rose-700/60 rounded px-3 py-2">
            <span class="font-semibold">Last error:</span>
            <div class="mt-1 font-mono break-words">
              <%= summary.ws.lastErrorMessage %>
            </div>
          </div>
        <% } %>
      </section>

      <!-- ENGINE BOX -->
      <section class="bg-[#111827] rounded-xl border border-slate-800 p-5 shadow-lg">
        <h2 class="text-lg font-semibold text-sky-300 flex items-center gap-2 mb-2">
          âš™ï¸ Engine
        </h2>
        <p class="text-xs text-slate-400 mb-4">
          Ovo opisuje unutraÅ¡nji AI / scalper engine. Za sada koriste se
          placeholder vrednosti (status / mode), a kasnije Ä‡emo vezati
          prave metrike iz core modula (<span class="font-mono text-sky-300">src/core/engine.js</span>).
        </p>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-slate-400">Status:</span>
            <span class="font-mono <%= summary.engine.status === 'running' ? 'text-emerald-400' : 'text-amber-400' %>">
              <%= summary.engine.status %>
            </span>
          </div>

          <div class="flex justify-between">
            <span class="text-slate-400">Mode:</span>
            <span class="font-mono text-slate-100"><%= summary.engine.mode %></span>
          </div>

          <div class="flex justify-between">
            <span class="text-slate-400">Decision rate (dec/s):</span>
            <span class="font-mono text-slate-100">
              <%= summary.engine.decisionRate != null ? summary.engine.decisionRate : 'N/A' %>
            </span>
          </div>

          <div class="flex justify-between">
            <span class="text-slate-400">Last decision:</span>
            <span class="font-mono text-slate-100">
              <%= summary.engine.lastDecisionAt ? summary.engine.lastDecisionAt : 'â€”' %>
            </span>
          </div>
        </div>
      </section>

    </div>

    <!-- GRID: EVENT METRICS + HEALTH -->
    <div class="grid gap-6 md:grid-cols-2">

      <!-- EVENT METRICS -->
      <section class="bg-[#111827] rounded-xl border border-slate-800 p-5 shadow-lg">
        <h2 class="text-lg font-semibold text-sky-300 flex items-center gap-2 mb-2">
          ğŸ“Š Event Metrics
        </h2>
        <p class="text-xs text-slate-400 mb-4">
          BrojaÄi bitnih dogaÄ‘aja u sistemu. Ovo ti daje oseÄ‡aj da li
          se neÅ¡to â€deÅ¡avaâ€œ ili je engine uspavan. Kasnije Ä‡emo ovde
          ubaciti prave vrednosti iz trade/execution sloja.
        </p>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-slate-400">WS messages total:</span>
            <span class="font-mono text-slate-100"><%= summary.events.wsMessagesTotal %></span>
          </div>

          <div class="flex justify-between">
            <span class="text-slate-400">WS errors total:</span>
            <span class="font-mono text-slate-100"><%= summary.events.wsErrorsTotal %></span>
          </div>

          <div class="flex justify-between">
            <span class="text-slate-400">Trades executed:</span>
            <span class="font-mono text-slate-100"><%= summary.events.tradesExecuted %></span>
          </div>

          <div class="flex justify-between">
            <span class="text-slate-400">Orders sent:</span>
            <span class="font-mono text-slate-100"><%= summary.events.ordersSent %></span>
          </div>
        </div>
      </section>

      <!-- HEALTH SUMMARY -->
      <section class="bg-[#111827] rounded-xl border border-slate-800 p-5 shadow-lg">
        <h2 class="text-lg font-semibold text-sky-300 flex items-center gap-2 mb-2">
          ğŸ§¬ Health Summary
        </h2>
        <p class="text-xs text-slate-400 mb-4">
          SaÅ¾etak stanja sistema â€“ kombinacija sistema, WS konekcije i
          engine statusa. Cilj je da ovde Å¡to ÄeÅ¡Ä‡e vidiÅ¡ status
          <span class="font-semibold text-emerald-400">OK</span>.
        </p>

        <div class="mb-3">
          <% if (summary.health.status === 'ok') { %>
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-900/40 border border-emerald-600 text-emerald-300 text-xs font-semibold">
              <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
              STATUS: OK
            </span>
          <% } else { %>
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-amber-900/40 border border-amber-600 text-amber-300 text-xs font-semibold">
              <span class="w-2 h-2 rounded-full bg-amber-400"></span>
              STATUS: <%= summary.health.status.toUpperCase() %>
            </span>
          <% } %>
        </div>

        <ul class="space-y-2 text-xs text-slate-300">
          <% summary.health.messages.forEach(function(msg) { %>
            <li class="flex items-start gap-2">
              <span class="mt-1 w-1.5 h-1.5 rounded-full bg-sky-400"></span>
              <span><%= msg %></span>
            </li>
          <% }) %>
        </ul>
      </section>

    </div>

    <!-- RAW JSON DEBUG -->
    <section class="bg-[#020617] rounded-xl border border-slate-800 p-5 shadow-inner">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-sm font-semibold text-slate-300 flex items-center gap-2">
          ğŸ“‹ Raw JSON snapshot
        </h2>
        <a
          href="/api/monitor/summary"
          target="_blank"
          class="text-xs text-sky-400 hover:text-sky-300 font-mono"
        >
          GET /api/monitor/summary
        </a>
      </div>

      <p class="text-xs text-slate-500 mb-3">
        Ovde moÅ¾eÅ¡ da vidiÅ¡ isti summary u JSON formatu â€“ idealno za debug,
        API klijente ili future frontend integracije.
      </p>

      <pre class="text-xs bg-[#020617] border border-slate-800 rounded-lg p-3 text-slate-200 overflow-x-auto">
<%= JSON.stringify(summary, null, 2) %>
      </pre>
    </section>
  </div>
</div>
