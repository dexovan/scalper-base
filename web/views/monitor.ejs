<section class="mb-6">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold text-slate-100">System Monitor</h1>
      <p class="text-sm text-slate-400">
        Pregled rada DTrade engine-a, Bybit WebSocket konekcije i sistema ispod hauve.
      </p>
    </div>

    <div class="flex items-center gap-3">
      <span id="monitor-timestamp" class="text-xs text-slate-500">‚Äì</span>
      <button
        id="btn-refresh-now"
        class="px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-500 text-xs font-medium text-white transition"
      >
        üîÑ Osve≈æi sada
      </button>
    </div>
  </div>
</section>

<div class="grid grid-cols-3 gap-4 mt-6">

  <!-- ENGINE STATUS -->
  <div class="bg-gray-900 p-4 rounded-xl shadow">
    <div class="text-sm text-gray-400">Engine</div>
    <div id="engine-status" class="text-xl font-bold text-yellow-300">LOADING...</div>
    <div class="text-gray-400 text-sm mt-2">Decision Rate: <span id="decision-rate">‚Äì</span></div>
    <div class="text-gray-400 text-sm">Decision Count: <span id="decision-count">‚Äì</span></div>
  </div>

  <!-- WS STATUS -->
  <div class="bg-gray-900 p-4 rounded-xl shadow">
    <div class="text-sm text-gray-400">WebSocket</div>
    <div id="ws-status" class="text-xl font-bold text-yellow-300">LOADING...</div>
    <div class="text-gray-400 text-sm mt-2">Messages: <span id="ws-messages">‚Äì</span></div>
  </div>

  <!-- MEMORY -->
  <div class="bg-gray-900 p-4 rounded-xl shadow">
    <div class="text-sm text-gray-400">System</div>
    <div class="text-gray-400 text-sm mt-2">RSS: <span id="memory-rss">‚Äì</span></div>
    <div class="text-gray-400 text-sm">Heap: <span id="memory-heap">‚Äì</span></div>
  </div>

</div>

<div class="grid lg:grid-cols-3 gap-6">
  <!-- LEVA STRANA: SYSTEM / ENGINE / WS -->
  <div class="lg:col-span-2 space-y-4">
    <!-- SYSTEM CARD -->
    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-sky-500/10 text-sky-400">
            üíª
          </div>
          <div>
            <h2 class="text-sm font-semibold text-slate-100">System status</h2>
            <p class="text-xs text-slate-400">Node proces na VPS-u (CPU, RAM, uptime)</p>
          </div>
        </div>
      </div>

      <div class="grid sm:grid-cols-4 gap-3 text-sm mt-2">
        <div>
          <div class="text-xs text-slate-400">Uptime</div>
          <div id="sys-uptime" class="font-semibold text-slate-100">‚Äì</div>
        </div>
        <div>
          <div class="text-xs text-slate-400">Load (1m)</div>
          <div id="sys-load" class="font-semibold text-slate-100">‚Äì</div>
        </div>
        <div>
          <div class="text-xs text-slate-400">RSS (MB)</div>
          <div id="sys-rss" class="font-semibold text-slate-100">‚Äì</div>
        </div>
        <div>
          <div class="text-xs text-slate-400">Heap used (MB)</div>
          <div id="sys-heap" class="font-semibold text-slate-100">‚Äì</div>
        </div>
      </div>
    </div>

    <!-- ENGINE CARD -->
    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-emerald-500/10 text-emerald-400">
            ‚öôÔ∏è
          </div>
          <div>
            <h2 class="text-sm font-semibold text-slate-100">Engine status</h2>
            <p class="text-xs text-slate-400">Glavni DTrade scalper core (decision loop)</p>
          </div>
        </div>
        <span id="engine-badge"
              class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/30">
          running
        </span>
      </div>

      <div class="grid sm:grid-cols-3 gap-3 text-sm mt-2">
        <div>
          <div class="text-xs text-slate-400">Mode</div>
          <div id="engine-mode" class="font-semibold text-slate-100">‚Äì</div>
        </div>
        <div>
          <div class="text-xs text-slate-400">Total decisions</div>
          <div id="engine-decisions" class="font-semibold text-slate-100">n/a</div>
        </div>
        <div>
          <div class="text-xs text-slate-400">Trades executed</div>
          <div id="engine-trades" class="font-semibold text-slate-100">n/a</div>
        </div>
      </div>

      <p class="mt-3 text-xs text-slate-500">
        ‚ûú Ovde prati≈° da li je engine *≈æiv*:
        ako status preƒëe u <span class="text-amber-400 font-semibold">stopped/error</span> ili nema odluka du≈æe vreme,
        znaƒçi da DTrade ne radi entry/exit odluke.
      </p>
    </div>

    <!-- WS CARD -->
    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-purple-500/10 text-purple-400">
            üåê
          </div>
          <div>
            <h2 class="text-sm font-semibold text-slate-100">Bybit WebSocket</h2>
            <p class="text-xs text-slate-400">Ticker, orderbook i trade stream konekcija</p>
          </div>
        </div>
        <div class="flex items-center gap-2 text-xs">
          <span id="ws-dot" class="w-2 h-2 rounded-full bg-slate-500"></span>
          <span id="ws-status-text" class="text-slate-300">Unknown</span>
        </div>
      </div>

      <div class="grid sm:grid-cols-3 gap-3 text-sm mt-2">
        <div>
          <div class="text-xs text-slate-400">Last message</div>
          <div id="ws-last-message" class="font-semibold text-slate-100 truncate">‚Äì</div>
        </div>
        <div>
          <div class="text-xs text-slate-400">Reconnect attempts</div>
          <div id="ws-reconnects" class="font-semibold text-slate-100">‚Äì</div>
        </div>
        <div>
          <div class="text-xs text-slate-400">Msg/60s (ako dostupno)</div>
          <div id="ws-msg-rate" class="font-semibold text-slate-100">n/a</div>
        </div>
      </div>

      <p class="mt-3 text-xs text-slate-500">
        ‚ûú Ako je WS status <span class="text-red-400 font-semibold">Disconnected</span>,
        engine ne vidi tr≈æi≈°te (nema tickera, orderbook-a, trade-ova) i ne bi trebalo da otvara nove pozicije.
      </p>
    </div>

    <!-- RAW JSON -->
    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-sm font-semibold text-slate-100">Raw JSON snapshot</h2>
        <code class="text-[11px] text-slate-500 break-all">/api/monitor/summary</code>
      </div>
      <pre id="raw-json"
           class="mt-2 text-xs bg-slate-950 border border-slate-800 rounded-lg p-3 overflow-x-auto max-h-64 text-slate-300">
Loading...
      </pre>
    </div>
  </div>

  <!-- DESNA STRANA: LIVE LOG VIEWER -->
  <div class="space-y-4">
    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 h-full flex flex-col">
      <div class="flex items-center justify-between mb-2">
        <div>
          <h2 class="text-sm font-semibold text-slate-100">Live engine logs</h2>
          <p class="text-xs text-slate-400">
            Poslednje linije iz <code class="text-[10px] text-slate-500">pm2-engine-out.log</code>.
          </p>
        </div>
      </div>
      <div class="mt-2 flex-1">
        <pre id="log-output"
             class="text-[11px] leading-snug bg-slate-950 border border-slate-800 rounded-lg p-3 overflow-y-auto max-h-[420px] text-slate-300">
Loading logs...
        </pre>
      </div>
      <p class="mt-2 text-[11px] text-slate-500">
        ‚ûú Ovde vidi≈° ≈°ta engine radi u realnom vremenu:
        koji simbol obraƒëuje, da li ima error-a, reconnect-ove, itd.
      </p>
    </div>
  </div>
</div>

<!-- OBJA≈†NjENjE METRIKA -->
<section class="mt-8 grid md:grid-cols-3 gap-6 text-xs text-slate-400">
  <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
    <h3 class="text-sm font-semibold text-slate-100 mb-2">System metrike</h3>
    <ul class="space-y-1.5 list-disc list-inside">
      <li><span class="font-semibold text-slate-200">Uptime</span> ‚Äì koliko dugo tvoj DTrade backend radi bez restart-a.</li>
      <li><span class="font-semibold text-slate-200">Load (1m)</span> ‚Äì optereƒáenje CPU-a (oko 0.3‚Äì1.0 je zdravo za jedan core).</li>
      <li><span class="font-semibold text-slate-200">RSS</span> ‚Äì ukupna memorija procesa (RAM koji Node zauzima).</li>
      <li><span class="font-semibold text-slate-200">Heap used</span> ‚Äì JS memorija (bitno za leak-ove).</li>
    </ul>
  </div>

  <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
    <h3 class="text-sm font-semibold text-slate-100 mb-2">Engine metrike</h3>
    <ul class="space-y-1.5 list-disc list-inside">
      <li><span class="font-semibold text-slate-200">Status</span> ‚Äì da li je core petlja aktivna (running / stopped / error).</li>
      <li><span class="font-semibold text-slate-200">Mode</span> ‚Äì npr. scalper-core, backtest, dry-run.</li>
      <li><span class="font-semibold text-slate-200">Total decisions</span> ‚Äì koliko je puta engine doneo odluku.</li>
      <li><span class="font-semibold text-slate-200">Trades executed</span> ‚Äì koliko realnih trade-ova je pro≈°lo kroz engine.</li>
    </ul>
  </div>

  <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
    <h3 class="text-sm font-semibold text-slate-100 mb-2">WS / market metrike</h3>
    <ul class="space-y-1.5 list-disc list-inside">
      <li><span class="font-semibold text-slate-200">Connected</span> ‚Äì da li smo spojeni na Bybit WS feed.</li>
      <li><span class="font-semibold text-slate-200">Last message</span> ‚Äì kada je poslednji put stigao ticker/orderbook/trade.</li>
      <li><span class="font-semibold text-slate-200">Reconnect attempts</span> ‚Äì koliko puta je WS morao da se vraƒáa.</li>
      <li><span class="font-semibold text-slate-200">Msg/60s</span> ‚Äì koliko poruka u zadnjih 60 sekundi (ako ga izraƒçunamo kasnije).</li>
    </ul>
  </div>
</section>



<script type="module">
  import { monitorAPI } from "/monitor-api.js";

  monitorAPI.onUpdate = (data) => {
    const ts = document.getElementById("monitor-timestamp");

    if (!data) {
      ts.textContent = "Last update: OFFLINE";

      // ENGINE
      document.getElementById("engine-status").innerText = "OFFLINE";
      document.getElementById("engine-status").className = "text-red-400";

      // WS
      document.getElementById("ws-status").innerText = "DISCONNECTED";
      document.getElementById("ws-messages").innerText = "‚Äì";

      // SYSTEM
      document.getElementById("memory-rss").innerText = "‚Äì";
      document.getElementById("memory-heap").innerText = "‚Äì";

      return;
    }

    // TIMESTAMP
    ts.textContent = "Last update: " + new Date().toLocaleTimeString();

    // ============================
    // ENGINE
    // ============================
    document.getElementById("engine-status").innerText = "ONLINE";
    document.getElementById("engine-status").className = "text-green-400";

    document.getElementById("decision-rate").innerText =
      data.engine.decisionRate;

    document.getElementById("decision-count").innerText =
      data.engine.decisionCount;

    document.getElementById("engine-mode").innerText = "scalper-core";
    document.getElementById("engine-decisions").innerText =
      data.engine.decisionCount;
    document.getElementById("engine-trades").innerText =
      data.engine.tradesExecuted;

    // ============================
    // WS
    // ============================
    const wsOK = data.ws.status === "connected";

    document.getElementById("ws-status").innerText =
      wsOK ? "CONNECTED" : "DISCONNECTED";

    document.getElementById("ws-status-text").innerText =
      wsOK ? "Connected" : "Disconnected";

    const dot = document.getElementById("ws-dot");
    dot.classList.remove("bg-slate-500", "bg-emerald-400", "bg-red-500");
    dot.classList.add(wsOK ? "bg-emerald-400" : "bg-red-500");

    document.getElementById("ws-messages").innerText =
      data.ws.messageCount;

    document.getElementById("ws-last-message").innerText =
      data.ws.lastMessageAt;

    document.getElementById("ws-reconnects").innerText =
      data.ws.reconnectAttempts;

    // ============================
    // SYSTEM
    // ============================
    document.getElementById("memory-rss").innerText =
      (data.system.rss / 1024 / 1024).toFixed(1) + " MB";

    document.getElementById("memory-heap").innerText =
      (data.system.heap / 1024 / 1024).toFixed(1) + " MB";

    // RAW JSON
    document.getElementById("raw-json").textContent =
      JSON.stringify(data, null, 2);
  };

  monitorAPI.start(1000);
</script>
