<!-- Scalp Scanner Custom Styles -->
<style>
.metric-badge {
  @apply inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium;
}
.metric-pass { @apply bg-emerald-500/20 text-emerald-300 border border-emerald-500/30; }
.metric-fail { @apply bg-slate-700/50 text-slate-400 border border-slate-600; }
.signal-card {
  @apply rounded-lg border border-slate-800 bg-slate-900/60 p-4 hover:border-slate-700 transition-colors;
}

/* Advanced Table Styles */
.signals-table {
  @apply w-full border-collapse text-sm;
}
.signals-table thead {
  @apply bg-slate-800/50 border-b border-slate-700;
}
.signals-table th {
  @apply px-3 py-2 text-left text-xs font-semibold text-slate-300 cursor-pointer hover:bg-slate-700/50 transition;
}
.signals-table th.sortable::after {
  content: ' ‚Üï';
  @apply text-slate-500;
}
.signals-table th.sorted-asc::after {
  content: ' ‚Üë';
  @apply text-blue-400;
}
.signals-table th.sorted-desc::after {
  content: ' ‚Üì';
  @apply text-blue-400;
}
.signals-table tbody tr {
  @apply border-b border-slate-700/50 hover:bg-slate-800/30 transition;
}
.signals-table td {
  @apply px-3 py-2;
}

/* Signal Quality Badge */
.quality-badge {
  @apply inline-flex items-center px-2 py-1 rounded text-xs font-medium;
}
.quality-excellent { @apply bg-emerald-500/20 text-emerald-300 border border-emerald-500/30; }
.quality-good { @apply bg-blue-500/20 text-blue-300 border border-blue-500/30; }
.quality-fair { @apply bg-yellow-500/20 text-yellow-300 border border-yellow-500/30; }
.quality-poor { @apply bg-red-500/20 text-red-300 border border-red-500/30; }

/* Filter Controls */
.filter-controls {
  @apply bg-slate-900/60 rounded-lg border border-slate-800 p-4 space-y-3;
}
.filter-group {
  @apply flex flex-col gap-2;
}
.filter-group label {
  @apply text-xs font-semibold text-slate-300;
}
.filter-input {
  @apply w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-blue-500 focus:outline-none transition;
}
.filter-range {
  @apply flex items-center gap-2;
}
.filter-range input {
  @apply flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-slate-100 focus:border-blue-500 focus:outline-none;
}
</style>

<div class="space-y-4">

  <!-- Header Section -->
  <section class="rounded-lg border border-slate-800 bg-slate-900/80 px-4 py-3">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div class="flex items-center gap-4">
        <h2 class="text-xl font-bold tracking-tight text-slate-100">‚ö° Scalp Scanner</h2>
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md bg-emerald-500/10 border border-emerald-500/30 text-emerald-300 text-xs font-medium" id="scanner-status">
            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
            Aktivno
          </span>
          <span class="inline-flex items-center px-2 py-1 rounded-md bg-slate-800 border border-slate-700 text-slate-300 text-xs font-medium" id="scan-interval">
            Skenira svakih 60s
          </span>
        </div>
      </div>
      <div class="flex items-center gap-4 text-xs text-slate-400">
        <span id="last-scan-time">Poslednje: -</span>
        <span>|</span>
        <button onclick="refreshData()" class="text-blue-400 hover:text-blue-300 transition">üîÑ Refresh</button>
      </div>
    </div>
  </section>

  <!-- Execution Monitoring Section -->
  <section class="rounded-lg border border-amber-600/30 bg-gradient-to-r from-amber-900/20 to-orange-900/20 p-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-semibold text-amber-300 flex items-center gap-2">
        üöÄ Live Execution Monitor
      </h3>
      <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md bg-amber-500/10 border border-amber-500/30 text-amber-300 text-xs font-medium" id="execution-mode">
        <span class="w-1.5 h-1.5 rounded-full bg-amber-400"></span>
        DRY-RUN MODE
      </span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3">
      <!-- Active Positions -->
      <div class="bg-slate-900/60 rounded-lg p-3 border border-slate-700">
        <div class="text-xs text-slate-400 mb-1">Active Positions</div>
        <div class="text-2xl font-bold text-blue-400" id="exec-active-positions">-</div>
        <div class="text-xs text-slate-500 mt-1">Open trades</div>
      </div>

      <!-- Total Executions -->
      <div class="bg-slate-900/60 rounded-lg p-3 border border-slate-700">
        <div class="text-xs text-slate-400 mb-1">Total Executions</div>
        <div class="text-2xl font-bold text-emerald-400" id="exec-total">-</div>
        <div class="text-xs text-slate-500 mt-1">All attempts</div>
      </div>

      <!-- Success Rate -->
      <div class="bg-slate-900/60 rounded-lg p-3 border border-slate-700">
        <div class="text-xs text-slate-400 mb-1">Success Rate</div>
        <div class="text-2xl font-bold text-green-400" id="exec-success-rate">-%</div>
        <div class="text-xs text-slate-500 mt-1">Successful fills</div>
      </div>

      <!-- Failed Attempts -->
      <div class="bg-slate-900/60 rounded-lg p-3 border border-slate-700">
        <div class="text-xs text-slate-400 mb-1">Failed Attempts</div>
        <div class="text-2xl font-bold text-red-400" id="exec-failed">-</div>
        <div class="text-xs text-slate-500 mt-1">Rejected/errors</div>
      </div>
    </div>

    <!-- Recent Trades -->
    <div class="bg-slate-900/40 rounded-lg p-3 border border-slate-700">
      <h4 class="text-xs font-semibold text-slate-300 mb-2">üìú Recent Executions (Last 10)</h4>
      <div class="space-y-1.5" id="recent-trades-list">
        <div class="text-xs text-slate-500 text-center py-2">No executions yet</div>
      </div>
    </div>
  </section>

  <!-- Stats Cards -->
  <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <!-- Total Symbols Scanned -->
    <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-slate-400 uppercase tracking-wide">Skenirano</p>
          <p class="mt-1 text-3xl font-bold tracking-tight text-slate-100" id="stat-total-symbols">-</p>
          <p class="mt-1 text-xs text-slate-500">Simbola</p>
        </div>
        <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-xl">üìä</div>
      </div>
    </div>

    <!-- Signals Found -->
    <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-slate-400 uppercase tracking-wide">Signala</p>
          <p class="mt-1 text-3xl font-bold tracking-tight text-emerald-400" id="stat-signals-found">-</p>
          <p class="mt-1 text-xs text-slate-500">Detektovano</p>
        </div>
        <div class="w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center text-xl">üéØ</div>
      </div>
    </div>

    <!-- Pass Rate -->
    <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-slate-400 uppercase tracking-wide">Prolaznost</p>
          <p class="mt-1 text-3xl font-bold tracking-tight text-amber-400" id="stat-pass-rate">-%</p>
          <p class="mt-1 text-xs text-slate-500">Simbola kvalifikuje</p>
        </div>
        <div class="w-10 h-10 rounded-full bg-amber-500/10 flex items-center justify-center text-xl">üìà</div>
      </div>
    </div>

    <!-- Scanner Health -->
    <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-slate-400 uppercase tracking-wide">Status</p>
          <p class="mt-1 text-3xl font-bold tracking-tight text-green-400" id="stat-health">‚úì</p>
          <p class="mt-1 text-xs text-emerald-400" id="stat-health-text">Svi sistemi OK</p>
        </div>
        <div class="w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center">
          <div class="w-3 h-3 rounded-full bg-green-400 animate-pulse"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Advanced Filter & Table Section -->
  <section class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-sm font-semibold text-slate-100">üìä Detaljni Pregled Signala</h3>
      <div class="flex items-center gap-2">
        <button onclick="toggleAdvancedFilters()" class="px-3 py-1 text-xs bg-blue-500/10 border border-blue-500/30 text-blue-300 rounded hover:bg-blue-500/20 transition">
          ‚öôÔ∏è Filteri
        </button>
        <button onclick="clearAllFilters()" class="px-3 py-1 text-xs bg-slate-700 text-slate-300 rounded hover:bg-slate-600 transition">
          ‚Ü∫ Reset
        </button>
      </div>
    </div>

    <!-- Advanced Filters (Togglable) -->
    <div id="advanced-filters" class="filter-controls mb-4 hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Search by Symbol -->
        <div class="filter-group">
          <label>üîç Simbol</label>
          <input type="text" id="filter-symbol" class="filter-input" placeholder="npr. BTCUSDT" onkeyup="applyFilters()">
        </div>

        <!-- Filter by Side -->
        <div class="filter-group">
          <label>üìà Tip Signala</label>
          <select id="filter-side" class="filter-input" onchange="applyFilters()">
            <option value="">Svi</option>
            <option value="LONG">LONG</option>
            <option value="SHORT">SHORT</option>
          </select>
        </div>

        <!-- Volatility Range -->
        <div class="filter-group">
          <label>üìä Volatilnost (%) min-max</label>
          <div class="filter-range">
            <input type="number" id="filter-vol-min" class="filter-input" placeholder="Min" step="0.01" onchange="applyFilters()">
            <span>-</span>
            <input type="number" id="filter-vol-max" class="filter-input" placeholder="Max" step="0.01" onchange="applyFilters()">
          </div>
        </div>

        <!-- Velocity Range -->
        <div class="filter-group">
          <label>‚ö° Velocity (%) min-max</label>
          <div class="filter-range">
            <input type="number" id="filter-vel-min" class="filter-input" placeholder="Min" step="0.0001" onchange="applyFilters()">
            <span>-</span>
            <input type="number" id="filter-vel-max" class="filter-input" placeholder="Max" step="0.01" onchange="applyFilters()">
          </div>
        </div>

        <!-- Momentum Range -->
        <div class="filter-group">
          <label>üí´ Momentum (%) min-max</label>
          <div class="filter-range">
            <input type="number" id="filter-mom-min" class="filter-input" placeholder="Min" step="0.01" onchange="applyFilters()">
            <span>-</span>
            <input type="number" id="filter-mom-max" class="filter-input" placeholder="Max" step="0.1" onchange="applyFilters()">
          </div>
        </div>

        <!-- Imbalance Range -->
        <div class="filter-group">
          <label>‚öñÔ∏è Imbalance min-max</label>
          <div class="filter-range">
            <input type="number" id="filter-imb-min" class="filter-input" placeholder="Min" step="0.01" onchange="applyFilters()">
            <span>-</span>
            <input type="number" id="filter-imb-max" class="filter-input" placeholder="Max" step="0.01" onchange="applyFilters()">
          </div>
        </div>

        <!-- Confidence Range -->
        <div class="filter-group">
          <label>‚úÖ Confidence (%) min-max</label>
          <div class="filter-range">
            <input type="number" id="filter-conf-min" class="filter-input" placeholder="Min" step="1" min="0" max="100" onchange="applyFilters()">
            <span>-</span>
            <input type="number" id="filter-conf-max" class="filter-input" placeholder="Max" step="1" min="0" max="100" onchange="applyFilters()">
          </div>
        </div>
      </div>
    </div>

    <!-- Signals Table -->
    <div class="overflow-x-auto">
      <table class="signals-table" id="signals-table">
        <thead>
          <tr>
            <th class="sortable w-20" onclick="sortTable('symbol')">Simbol</th>
            <th class="sortable w-16" onclick="sortTable('side')">Tip</th>
            <th class="sortable w-20" onclick="sortTable('confidence')">Confidence</th>
            <th class="sortable w-20" onclick="sortTable('entry')">Entry</th>
            <th class="sortable w-20" onclick="sortTable('tp')">TP</th>
            <th class="sortable w-20" onclick="sortTable('sl')">SL</th>
            <th class="sortable w-24" onclick="sortTable('volatility')">Vol (%)</th>
            <th class="sortable w-20" onclick="sortTable('volumeSpike')">Spike (x)</th>
            <th class="sortable w-20" onclick="sortTable('velocity')">Vel (%)</th>
            <th class="sortable w-20" onclick="sortTable('momentum')">Mom (%)</th>
            <th class="sortable w-24" onclick="sortTable('imbalance')">Imbalance</th>
            <th class="sortable w-20" onclick="sortTable('spread')">Spread (%)</th>
            <th class="sortable w-24" onclick="sortTable('quality')">Kvalitet</th>
          </tr>
        </thead>
        <tbody id="signals-tbody">
          <tr>
            <td colspan="13" class="text-center py-8 text-slate-500">
              üîç Uƒçitavanje signala...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Table Info -->
    <div class="mt-3 flex items-center justify-between text-xs text-slate-400">
      <span id="table-info">0 signala</span>
      <span>Klikni na kolonu za sortiranje ‚Üï</span>
    </div>
  </section>

  <!-- Filter Status -->
  <section class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
    <h3 class="text-sm font-semibold text-slate-100 mb-3">üìã Aktivni Filteri</h3>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
      <div class="bg-slate-800/50 rounded-lg p-3">
        <div class="text-xs text-slate-400 mb-1">Volatilnost</div>
        <div class="text-lg font-bold text-blue-400">‚â• 0.15%</div>
        <div class="text-xs text-slate-500 mt-1" id="filter-volatility-pass">- prolazi</div>
      </div>
      <div class="bg-slate-800/50 rounded-lg p-3">
        <div class="text-xs text-slate-400 mb-1">Volume Spike</div>
        <div class="text-lg font-bold text-purple-400">‚â• 1.5x</div>
        <div class="text-xs text-slate-500 mt-1" id="filter-volume-pass">- prolazi</div>
      </div>
      <div class="bg-slate-800/50 rounded-lg p-3">
        <div class="text-xs text-slate-400 mb-1">Velocity</div>
        <div class="text-lg font-bold text-cyan-400">‚â• 0.03%/min</div>
        <div class="text-xs text-slate-500 mt-1" id="filter-velocity-pass">- prolazi</div>
      </div>
      <div class="bg-slate-800/50 rounded-lg p-3">
        <div class="text-xs text-slate-400 mb-1">Momentum</div>
        <div class="text-lg font-bold text-green-400">‚â• 0.1%</div>
        <div class="text-xs text-slate-500 mt-1" id="filter-momentum-pass">- prolazi</div>
      </div>
      <div class="bg-slate-800/50 rounded-lg p-3">
        <div class="text-xs text-slate-400 mb-1">Imbalance</div>
        <div class="text-lg font-bold text-amber-400">‚â• 1.5</div>
        <div class="text-xs text-slate-500 mt-1" id="filter-imbalance-pass">- prolazi</div>
      </div>
      <div class="bg-slate-800/50 rounded-lg p-3">
        <div class="text-xs text-slate-400 mb-1">Spread</div>
        <div class="text-lg font-bold text-rose-400">‚â§ 0.1%</div>
        <div class="text-xs text-slate-500 mt-1" id="filter-spread-pass">- prolazi</div>
      </div>
    </div>
  </section>

  <!-- Signals List (Card View) -->
  <section class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-sm font-semibold text-slate-100">üéØ Detektovani Signali</h3>
      <div class="flex items-center gap-2">
        <button onclick="clearSignals()" class="px-3 py-1 text-xs bg-red-500/10 border border-red-500/30 text-red-300 rounded hover:bg-red-500/20 transition">
          üóëÔ∏è Oƒçisti sve
        </button>
      </div>
    </div>

    <div id="signals-container" class="space-y-3">
      <!-- Signals will be rendered here -->
      <div class="text-center py-12 text-slate-500">
        <div class="text-4xl mb-2">üîç</div>
        <div>Uƒçitavanje signala...</div>
      </div>
    </div>
  </section>

  <!-- Top Candidates (Close to qualifying) -->
  <section class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
    <h3 class="text-sm font-semibold text-slate-100 mb-3">üî• Top Kandidati (Blizu praga)</h3>
    <div id="top-candidates-container" class="space-y-2">
      <!-- Top candidates will be rendered here -->
      <div class="text-center py-8 text-slate-500 text-sm">
        Uƒçitavanje...
      </div>
    </div>
  </section>

</div>

<script>
let scannerData = null;

// Format time
function formatTime(timestamp) {
  if (!timestamp) return '-';
  const date = new Date(timestamp);
  return date.toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

// Get Bybit-style precision based on price magnitude
function getPrecisionForPrice(price) {
  if (!price || price === 0) return 2;
  const absPrice = Math.abs(price);

  if (absPrice >= 1000) return 2;      // BTC/ETH
  if (absPrice >= 100) return 2;
  if (absPrice >= 10) return 3;        // $10-99
  if (absPrice >= 1) return 4;         // $1-9
  if (absPrice >= 0.1) return 4;       // $0.1-0.99
  if (absPrice >= 0.01) return 5;      // $0.01-0.099
  if (absPrice >= 0.001) return 5;
  if (absPrice >= 0.0001) return 6;
  if (absPrice >= 0.00001) return 7;
  if (absPrice >= 0.000001) return 8;
  return 10;                           // Meme coins
}

// Format number with adaptive decimals (Bybit-style)
function fmt(num) {
  if (num == null || num === 'N/A') return 'N/A';
  if (typeof num !== 'number') return num;

  const precision = getPrecisionForPrice(num);
  return Number(num.toFixed(precision));
}

// =============== ADVANCED TABLE FUNCTIONS ===============

// Calculate signal quality score
function getSignalQuality(signal) {
  let score = 0;
  let qualityLevel = 'poor';

  // Strong velocity
  if (signal.velocity > 1) score += 3;
  else if (signal.velocity > 0.5) score += 2;
  else if (signal.velocity > 0.05) score += 1;

  // Strong volatility
  if (signal.volatility > 5) score += 3;
  else if (signal.volatility > 1) score += 2;
  else if (signal.volatility > 0.15) score += 1;

  // Strong volume spike
  if (signal.volumeSpike > 3) score += 2;
  else if (signal.volumeSpike > 1.5) score += 1;

  // Strong momentum
  if (signal.momentum > 0.5) score += 2;
  else if (signal.momentum > 0.1) score += 1;

  // Determine quality level
  if (score >= 8) qualityLevel = 'excellent';
  else if (score >= 5) qualityLevel = 'good';
  else if (score >= 2) qualityLevel = 'fair';

  return { score, qualityLevel };
}

// Toggle filter panel
function toggleAdvancedFilters() {
  const filters = document.getElementById('advanced-filters');
  filters.classList.toggle('hidden');
}

// Clear all filters
function clearAllFilters() {
  document.getElementById('filter-symbol').value = '';
  document.getElementById('filter-side').value = '';
  document.getElementById('filter-vol-min').value = '';
  document.getElementById('filter-vol-max').value = '';
  document.getElementById('filter-vel-min').value = '';
  document.getElementById('filter-vel-max').value = '';
  document.getElementById('filter-mom-min').value = '';
  document.getElementById('filter-mom-max').value = '';
  document.getElementById('filter-imb-min').value = '';
  document.getElementById('filter-imb-max').value = '';
  document.getElementById('filter-conf-min').value = '';
  document.getElementById('filter-conf-max').value = '';
  applyFilters();
}

// Apply filters and render table
function applyFilters() {
  if (!scannerData || !scannerData.signals) return;

  const symbol = document.getElementById('filter-symbol').value.toUpperCase();
  const side = document.getElementById('filter-side').value;
  const volMin = parseFloat(document.getElementById('filter-vol-min').value) || 0;
  const volMax = parseFloat(document.getElementById('filter-vol-max').value) || 100;
  const velMin = parseFloat(document.getElementById('filter-vel-min').value) || 0;
  const velMax = parseFloat(document.getElementById('filter-vel-max').value) || 1000;
  const momMin = parseFloat(document.getElementById('filter-mom-min').value) || 0;
  const momMax = parseFloat(document.getElementById('filter-mom-max').value) || 1000;
  const imbMin = parseFloat(document.getElementById('filter-imb-min').value) || 0;
  const imbMax = parseFloat(document.getElementById('filter-imb-max').value) || 10;
  const confMin = parseFloat(document.getElementById('filter-conf-min').value) || 0;
  const confMax = parseFloat(document.getElementById('filter-conf-max').value) || 100;

  // Filter signals
  let filtered = scannerData.signals.filter(signal => {
    if (symbol && !signal.symbol.includes(symbol)) return false;
    if (side && signal.side !== side) return false;
    if (signal.volatility < volMin || signal.volatility > volMax) return false;
    if (signal.velocity < velMin || signal.velocity > velMax) return false;
    if (signal.momentum < momMin || signal.momentum > momMax) return false;
    if (signal.imbalance < imbMin || signal.imbalance > imbMax) return false;
    if (signal.confidence < confMin || signal.confidence > confMax) return false;
    return true;
  });

  // Render filtered signals
  renderSignalsTable(filtered);
}

// Sort table by column
let currentSort = { column: 'symbol', direction: 'asc' };
function sortTable(column) {
  const headers = document.querySelectorAll('.signals-table th.sortable');
  headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));

  if (currentSort.column === column) {
    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.column = column;
    currentSort.direction = 'asc';
  }

  const header = Array.from(headers).find(h => h.textContent.toLowerCase().includes(column.toLowerCase()));
  if (header) {
    header.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
  }

  applyFilters();
}

// Render signals in table
function renderSignalsTable(signals) {
  const tbody = document.getElementById('signals-tbody');

  if (!signals || signals.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="13" class="text-center py-8 text-slate-500">
          ‚è≥ Nema signala koji zadovoljavaju filtre
        </td>
      </tr>
    `;
    document.getElementById('table-info').textContent = '0 signala';
    return;
  }

  // Sort signals
  const sorted = [...signals].sort((a, b) => {
    let aVal = a[currentSort.column];
    let bVal = b[currentSort.column];

    if (aVal === null || aVal === undefined) aVal = '';
    if (bVal === null || bVal === undefined) bVal = '';

    const comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
    return currentSort.direction === 'asc' ? comparison : -comparison;
  });

  // Render rows
  tbody.innerHTML = sorted.map(signal => {
    const { qualityLevel } = getSignalQuality(signal);
    const qualityEmoji = {
      'excellent': '‚≠ê‚≠ê‚≠ê',
      'good': '‚≠ê‚≠ê',
      'fair': '‚≠ê',
      'poor': '‚óã'
    }[qualityLevel];

    return `
      <tr>
        <td class="font-semibold text-blue-400">${signal.symbol}</td>
        <td>
          <span class="px-2 py-1 rounded text-xs font-semibold ${
            signal.side === 'LONG' ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'
          }">
            ${signal.side}
          </span>
        </td>
        <td class="font-semibold text-emerald-400">${signal.confidence}%</td>
        <td class="font-mono text-sm">$${fmt(signal.entry)}</td>
        <td class="font-mono text-sm text-emerald-400">$${fmt(signal.takeProfit)}</td>
        <td class="font-mono text-sm text-red-400">$${fmt(signal.stopLoss)}</td>
        <td class="${signal.volatility >= 0.15 ? 'text-green-400' : 'text-slate-400'} font-semibold">${fmt(signal.volatility)}%</td>
        <td class="${signal.volumeSpike >= 1.5 ? 'text-green-400' : 'text-slate-400'} font-semibold">${fmt(signal.volumeSpike)}x</td>
        <td class="${signal.velocity >= 0.05 ? 'text-green-400' : 'text-slate-400'} font-semibold">${fmt(signal.velocity)}%</td>
        <td class="${signal.momentum >= 0.1 ? 'text-green-400' : 'text-slate-400'} font-semibold">${fmt(signal.momentum)}%</td>
        <td class="${(signal.side === 'LONG' && signal.imbalance >= 1.05) || (signal.side === 'SHORT' && signal.imbalance <= 0.95) ? 'text-green-400' : 'text-slate-400'} font-semibold">${fmt(signal.imbalance)}</td>
        <td class="${signal.spread <= 0.1 ? 'text-green-400' : 'text-slate-400'} font-semibold">${fmt(signal.spread)}%</td>
        <td>
          <span class="quality-badge quality-${qualityLevel}">
            ${qualityEmoji}
          </span>
        </td>
      </tr>
    `;
  }).join('');

  document.getElementById('table-info').textContent = `${sorted.length} signala`;
}

// ============================================================

function renderSignal(signal) {
  const passCount = [
    signal.volatility >= 0.15,
    signal.volumeSpike >= 1.5,
    signal.velocity >= 0.03,
    signal.momentum >= 0.1,
    signal.imbalance >= 1.5,
    signal.spread <= 0.1
  ].filter(Boolean).length;

  return `
    <div class="signal-card">
      <div class="flex items-start justify-between mb-3">
        <div>
          <div class="flex items-center gap-2">
            <span class="text-lg font-bold text-slate-100">${signal.symbol}</span>
            <span class="px-2 py-0.5 bg-emerald-500/20 text-emerald-300 text-xs font-semibold rounded border border-emerald-500/30">
              ${signal.side}
            </span>
            <span class="px-2 py-0.5 bg-blue-500/20 text-blue-300 text-xs rounded">
              Confidence: ${signal.confidence}%
            </span>
          </div>
          <div class="text-xs text-slate-400 mt-1">
            ${formatTime(signal.timestamp)} ‚Ä¢ Prolazi ${passCount}/6 filtera
          </div>
        </div>
        <div class="text-right">
          <div class="text-xs text-slate-400 mb-1">Entry Zone</div>
          ${signal.entryZone ? `
            <div class="text-xs text-slate-500 font-mono mb-0.5">
              ${fmt(signal.entryZone.min)} ‚Äî ${fmt(signal.entryZone.max)}
            </div>
            <div class="text-base font-bold text-blue-400">
              Ideal: $${fmt(signal.entryZone.ideal)}
            </div>
          ` : `
            <div class="text-lg font-bold text-blue-400">$${fmt(signal.entry)}</div>
          `}
        </div>
      </div>

      <!-- Entry Status Indicator (NEW) -->
      ${signal.entryStatus ? `
        <div class="mb-3 px-3 py-2 rounded-lg border ${
          signal.entryStatus.inZone
            ? 'bg-green-500/10 border-green-500/30'
            : 'bg-amber-500/10 border-amber-500/30'
        }">
          <div class="flex items-center justify-between text-xs">
            <div class="flex items-center gap-2">
              ${signal.entryStatus.inZone
                ? '<span class="text-green-400 font-bold">‚úÖ READY FOR ENTRY</span>'
                : `<span class="text-amber-400">‚è≥ Waiting (${signal.entryStatus.direction} ${fmt(signal.entryStatus.distancePercent)}%)</span>`
              }
            </div>
            <div class="text-slate-400">
              Current: <span class="text-slate-200 font-semibold">$${fmt(signal.live?.price || signal.entry)}</span>
            </div>
          </div>
        </div>
      ` : ''}

      <div class="grid grid-cols-3 gap-2 mb-3 text-xs">
        <div>
          <div class="text-slate-400">TP (+0.22%)</div>
          <div class="text-green-400 font-semibold">$${fmt(signal.takeProfit)}</div>
        </div>
        <div>
          <div class="text-slate-400">SL (-0.15%)</div>
          <div class="text-red-400 font-semibold">$${fmt(signal.stopLoss)}</div>
        </div>
        <div>
          <div class="text-slate-400">Oƒçekivani Profit</div>
          <div class="text-amber-400 font-semibold">$${fmt(signal.expectedProfit)}</div>
        </div>
      </div>

      <div class="flex flex-wrap gap-2">
        <span class="${signal.volatility >= 0.15 ? 'metric-pass' : 'metric-fail'}">
          Vol: ${fmt(signal.volatility)}%
        </span>
        <span class="${signal.volumeSpike >= 1.5 ? 'metric-pass' : 'metric-fail'}">
          Spike: ${fmt(signal.volumeSpike)}x
        </span>
        <span class="${signal.velocity >= 0.03 ? 'metric-pass' : 'metric-fail'}">
          Vel: ${fmt(signal.velocity)}%/m
        </span>
        <span class="${signal.momentum >= 0.1 ? 'metric-pass' : 'metric-fail'}">
          Mom: ${fmt(signal.momentum)}%
        </span>
        <span class="${signal.imbalance >= 1.5 ? 'metric-pass' : 'metric-fail'}">
          Imb: ${fmt(signal.imbalance)}
        </span>
        <span class="${signal.spread <= 0.1 ? 'metric-pass' : 'metric-fail'}">
          Spr: ${fmt(signal.spread)}%
        </span>
      </div>
    </div>
  `;
}

// Render top candidate
function renderCandidate(candidate) {
  const passCount = [
    candidate.volatility >= 0.15,
    candidate.volumeSpike >= 1.5,
    candidate.velocity >= 0.03,
    candidate.momentum >= 0.1,
    candidate.imbalance >= 1.5,
    candidate.spread <= 0.1
  ].filter(Boolean).length;

  return `
    <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg hover:bg-slate-800 transition">
      <div class="flex items-center gap-3">
        <span class="text-sm font-semibold text-slate-100">${candidate.symbol}</span>
        <span class="text-xs text-slate-400">${passCount}/6 filtera</span>
      </div>
      <div class="flex gap-2 text-xs">
        <span class="${candidate.volatility >= 0.15 ? 'metric-pass' : 'metric-fail'}">
          Vol: ${fmt(candidate.volatility)}%
        </span>
        <span class="${candidate.volumeSpike >= 1.5 ? 'metric-pass' : 'metric-fail'}">
          Spike: ${fmt(candidate.volumeSpike)}x
        </span>
        <span class="${candidate.imbalance >= 1.5 ? 'metric-pass' : 'metric-fail'}">
          Imb: ${fmt(candidate.imbalance)}
        </span>
      </div>
    </div>
  `;
}

// Fetch scanner data
async function fetchScannerData() {
  try {
    const response = await fetch('/api/scalp-scanner');
    const data = await response.json();

    if (data.ok) {
      scannerData = data;
      updateUI(data);
    } else {
      console.error('Failed to fetch scanner data:', data.error);
      showError(data.error);
    }
  } catch (error) {
    console.error('Error fetching scanner data:', error);
    showError('Gre≈°ka pri uƒçitavanju podataka');
  }
}

// Update UI with scanner data
function updateUI(data) {
  // Update stats
  document.getElementById('stat-total-symbols').textContent = data.stats.totalScanned || '-';
  document.getElementById('stat-signals-found').textContent = data.stats.signalsFound || '0';

  const passRate = data.stats.totalScanned > 0
    ? ((data.stats.signalsFound / data.stats.totalScanned) * 100).toFixed(1)
    : '0';
  document.getElementById('stat-pass-rate').textContent = passRate + '%';

  // Update last scan time
  document.getElementById('last-scan-time').textContent = 'Poslednje: ' + formatTime(data.lastScan);

  // Update filter stats
  if (data.filterStats) {
    document.getElementById('filter-volatility-pass').textContent = `${data.filterStats.volatility || 0} prolazi`;
    document.getElementById('filter-volume-pass').textContent = `${data.filterStats.volumeSpike || 0} prolazi`;
    document.getElementById('filter-velocity-pass').textContent = `${data.filterStats.velocity || 0} prolazi`;
    document.getElementById('filter-momentum-pass').textContent = `${data.filterStats.momentum || 0} prolazi`;
    document.getElementById('filter-imbalance-pass').textContent = `${data.filterStats.imbalance || 0} prolazi`;
    document.getElementById('filter-spread-pass').textContent = `${data.filterStats.spread || 0} prolazi`;
  }

  // Render signals
  const signalsContainer = document.getElementById('signals-container');
  if (data.signals && data.signals.length > 0) {
    signalsContainer.innerHTML = data.signals.map(renderSignal).join('');
  } else {
    signalsContainer.innerHTML = `
      <div class="text-center py-12 text-slate-500">
        <div class="text-4xl mb-2">‚è≥</div>
        <div>Nema signala u poslednjem skeniranju</div>
        <div class="text-xs text-slate-600 mt-2">Scanner radi i detektovaƒáe signale kad se uslovi poklope</div>
      </div>
    `;
  }

  // Render top candidates
  const candidatesContainer = document.getElementById('top-candidates-container');
  if (data.topCandidates && data.topCandidates.length > 0) {
    candidatesContainer.innerHTML = data.topCandidates.map(renderCandidate).join('');
  } else {
    candidatesContainer.innerHTML = `
      <div class="text-center py-8 text-slate-500 text-sm">
        Nema kandidata blizu praga
      </div>
    `;
  }

  // Update advanced table view with filters applied
  applyFilters();
}

// Show error message
function showError(message) {
  const signalsContainer = document.getElementById('signals-container');
  signalsContainer.innerHTML = `
    <div class="text-center py-12 text-red-400">
      <div class="text-4xl mb-2">‚ö†Ô∏è</div>
      <div>${message}</div>
    </div>
  `;
}

// Clear all signals
async function clearSignals() {
  if (!confirm('Da li ste sigurni da ≈æelite da obri≈°ete sve signale?')) return;

  try {
    const response = await fetch('/api/scalp-scanner/clear', { method: 'POST' });
    const data = await response.json();

    if (data.ok) {
      await refreshData();
    } else {
      alert('Gre≈°ka: ' + data.error);
    }
  } catch (error) {
    console.error('Error clearing signals:', error);
    alert('Gre≈°ka pri brisanju signala');
  }
}

// Refresh data
async function refreshData() {
  await fetchScannerData();
  await fetchExecutionStats();
}

// Fetch execution statistics
async function fetchExecutionStats() {
  try {
    // Fetch execution stats
    const statsResponse = await fetch('/api/execution/stats');
    const statsData = await statsResponse.json();

    // Fetch active positions
    const positionsResponse = await fetch('/api/execution/positions');
    const positionsData = await positionsResponse.json();

    if (statsData.ok) {
      // Update stats
      document.getElementById('exec-total').textContent = statsData.stats.totalExecutions || 0;
      document.getElementById('exec-success-rate').textContent = statsData.stats.successRate + '%' || '0%';
      document.getElementById('exec-failed').textContent = statsData.stats.failedExecutions || 0;

      // Update recent trades
      const tradesList = document.getElementById('recent-trades-list');
      if (statsData.recentTrades && statsData.recentTrades.length > 0) {
        tradesList.innerHTML = statsData.recentTrades.slice(0, 10).map(trade => {
          const statusIcon = trade.success ? '‚úÖ' : '‚ùå';
          const statusClass = trade.success ? 'text-emerald-400' : 'text-red-400';
          const modeLabel = trade.dryRun ? 'üîí DRY-RUN' : 'üí∞ LIVE';
          const time = new Date(trade.timestamp).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

          return `
            <div class="flex items-center justify-between text-xs bg-slate-800/40 rounded px-2 py-1.5">
              <div class="flex items-center gap-2">
                <span class="${statusClass}">${statusIcon}</span>
                <span class="font-mono text-slate-300">${trade.symbol}</span>
                <span class="text-slate-400">${trade.direction}</span>
                <span class="text-slate-500">@ ${trade.entry}</span>
              </div>
              <div class="flex items-center gap-2 text-slate-500">
                <span>${modeLabel}</span>
                <span>${time}</span>
              </div>
            </div>
          `;
        }).join('');
      } else {
        tradesList.innerHTML = '<div class="text-xs text-slate-500 text-center py-2">No executions yet</div>';
      }
    }

    if (positionsData.ok) {
      document.getElementById('exec-active-positions').textContent = positionsData.count || 0;
    }

  } catch (error) {
    console.error('Error fetching execution stats:', error);
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  fetchScannerData();
  fetchExecutionStats();

  // Auto-refresh every 10 seconds
  setInterval(() => {
    fetchScannerData();
    fetchExecutionStats();
  }, 10000);
});
</script>
