<!-- Scalp Scanner Custom Styles -->
<style>
.metric-badge {
  @apply inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium;
}
.metric-pass { @apply bg-emerald-500/20 text-emerald-300 border border-emerald-500/30; }
.metric-fail { @apply bg-slate-700/50 text-slate-400 border border-slate-600; }
.signal-card {
  @apply rounded-lg border border-slate-800 bg-slate-900/60 p-4 hover:border-slate-700 transition-colors;
}

/* Advanced Table Styles */
.signals-table {
  @apply w-full border-collapse text-sm table-fixed;
  background-color: #0f172a;
}
.signals-table thead {
  @apply bg-gradient-to-r from-slate-800 to-slate-700;
  position: sticky;
  top: 0;
  z-index: 10;
  border-bottom: 4px solid #3b82f6;
  box-shadow: 0 4px 0 -2px rgba(59, 130, 246, 0.5);
}
.signals-table th {
  @apply px-6 py-5 text-right text-xs font-bold text-slate-50 cursor-pointer transition;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-right: 1px solid rgba(100, 116, 139, 0.4);
  background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
}
.signals-table th:last-child {
  border-right: none;
}
.signals-table th:first-child {
  @apply text-left;
}
.signals-table th:nth-child(2) {
  @apply text-center;
}
.signals-table th:hover {
  @apply bg-slate-700 text-blue-200;
}
.signals-table th.sortable::after {
  content: ' ‚Üï';
  @apply text-slate-400;
  font-weight: bold;
}
.signals-table th.sorted-asc::after {
  content: ' ‚Üë';
  @apply text-blue-300;
  font-weight: bold;
}
.signals-table th.sorted-desc::after {
  content: ' ‚Üì';
  @apply text-blue-300;
  font-weight: bold;
}
.signals-table tbody tr {
  @apply hover:bg-slate-700/30 transition;
  border-bottom: 1px solid rgba(71, 85, 105, 0.3);
}
.signals-table tbody tr:last-child {
  border-bottom: none;
}
.signals-table td {
  @apply px-6 py-4 text-slate-200 text-right;
  word-wrap: break-word;
  overflow-wrap: break-word;
  border-right: 1px solid rgba(71, 85, 105, 0.3);
}
.signals-table td:last-child {
  border-right: none;
}
.signals-table td:first-child {
  @apply text-left font-semibold text-blue-400;
}
.signals-table td:nth-child(2) {
  @apply text-center;
}

/* Signal Quality Badge */
.quality-badge {
  @apply inline-flex items-center px-2 py-1 rounded text-xs font-medium;
}
.quality-excellent { @apply bg-emerald-500/20 text-emerald-300 border border-emerald-500/30; }
.quality-good { @apply bg-blue-500/20 text-blue-300 border border-blue-500/30; }
.quality-fair { @apply bg-yellow-500/20 text-yellow-300 border border-yellow-500/30; }
.quality-poor { @apply bg-red-500/20 text-red-300 border border-red-500/30; }

/* Filter Controls */
.filter-controls {
  @apply bg-slate-950/80 rounded-lg border border-slate-700 p-4 space-y-3;
}
.filter-group {
  @apply flex flex-col gap-2;
}
.filter-group label {
  @apply text-xs font-bold text-slate-200 uppercase tracking-wide;
}
.filter-input {
  @apply w-full bg-slate-800 border border-slate-600 rounded px-3 py-2.5 text-sm text-slate-100 placeholder-slate-400 focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400 transition;
}
.filter-input select,
select.filter-input {
  @apply bg-slate-800 text-slate-100 border-slate-600;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3E%3C/svg%3E");
  background-position: right 0.5rem center;
  background-repeat: no-repeat;
  background-size: 1.5em 1.5em;
  padding-right: 2.5rem;
  color: #e2e8f0 !important;
}
.filter-input option,
select.filter-input option {
  background-color: #1e293b !important;
  color: #e2e8f0 !important;
  padding: 8px 10px;
  border: none;
}

/* Modal Styles */
.modal {
  @apply fixed inset-0 bg-black/60 backdrop-blur-sm z-50 items-center justify-center;
  display: none;
}
.modal.active {
  display: flex;
}
.modal-content {
  @apply bg-slate-900 border border-slate-700 rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto;
}
.modal-header {
  @apply sticky top-0 bg-gradient-to-r from-slate-800 to-slate-700 border-b border-slate-700 p-6 flex items-center justify-between;
}
.modal-close {
  @apply text-slate-400 hover:text-slate-100 text-2xl cursor-pointer transition;
}
.modal-body {
  @apply p-6;
}
.modal-section {
  @apply mb-6 pb-6 border-b border-slate-700 last:border-b-0;
}
.modal-section h3 {
  @apply text-lg font-semibold text-slate-100 mb-4;
}
.modal-grid {
  @apply grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4;
}
.modal-stat {
  @apply bg-slate-800/50 rounded-lg p-4;
}
.modal-stat-label {
  @apply text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2;
}
.modal-stat-value {
  @apply text-lg font-bold text-slate-100;
}
.modal-stat.warning {
  @apply border border-yellow-500/30 bg-yellow-500/5;
}
.modal-stat.success {
  @apply border border-emerald-500/30 bg-emerald-500/5;
}
.modal-stat.danger {
  @apply border border-red-500/30 bg-red-500/5;
}

/* Candle Chart Styles */
.candle-chart {
  @apply bg-slate-800/50 rounded-lg p-4 border border-slate-700;
  overflow-x: auto;
}
.candle-row {
  @apply flex items-center gap-1 py-1 text-xs border-b border-slate-700/30 last:border-b-0 hover:bg-slate-700/30 transition;
}
.candle-time {
  @apply font-mono text-slate-400 w-20;
}
.candle-bar {
  @apply flex items-center justify-center relative h-8;
  width: 80px;
}
.candle-bar-bg {
  @apply absolute left-0 right-0 h-full rounded transition;
}
.candle-value {
  @apply relative z-10 font-mono text-slate-200 text-xs font-semibold;
}
.filter-input option:hover,
select.filter-input option:hover {
  background-color: #334155 !important;
  color: #f1f5f9 !important;
}
.filter-input option:checked,
select.filter-input option:checked {
  background: linear-gradient(#3b82f6, #3b82f6) !important;
  background-color: #3b82f6 !important;
  color: #ffffff !important;
}
.filter-input:disabled {
  @apply bg-slate-900 text-slate-500 cursor-not-allowed;
}
.filter-range {
  @apply flex items-center gap-2;
}
.filter-range input {
  @apply flex-1 bg-slate-800 border border-slate-600 rounded px-3 py-2 text-xs text-slate-100 placeholder-slate-400 focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-400 transition;
}
</style>

<div class="space-y-4">

  <!-- Header Section -->
  <section class="rounded-lg border border-slate-800 bg-slate-900/80 px-4 py-3">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div class="flex items-center gap-4">
        <h2 class="text-xl font-bold tracking-tight text-slate-100">‚ö° Scalp Scanner</h2>
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md bg-emerald-500/10 border border-emerald-500/30 text-emerald-300 text-xs font-medium" id="scanner-status">
            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
            Aktivno
          </span>
          <span class="inline-flex items-center px-2 py-1 rounded-md bg-slate-800 border border-slate-700 text-slate-300 text-xs font-medium" id="scan-interval">
            Skenira svakih 60s
          </span>
        </div>
      </div>
      <div class="flex items-center gap-4 text-xs text-slate-400">
        <span id="last-scan-time">Poslednje: -</span>
        <span>|</span>
        <button onclick="refreshData()" class="text-blue-400 hover:text-blue-300 transition">üîÑ Refresh</button>
      </div>
    </div>
  </section>

  <!-- Execution Monitoring Section -->
  <section class="rounded-lg border border-amber-600/30 bg-gradient-to-r from-amber-900/20 to-orange-900/20 p-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-semibold text-amber-300 flex items-center gap-2">
        üöÄ Live Execution Monitor
      </h3>
      <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md bg-amber-500/10 border border-amber-500/30 text-amber-300 text-xs font-medium" id="execution-mode">
        <span class="w-1.5 h-1.5 rounded-full bg-amber-400"></span>
        DRY-RUN MODE
      </span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3">
      <!-- Active Positions -->
      <div class="bg-slate-900/60 rounded-lg p-3 border border-slate-700">
        <div class="text-xs text-slate-400 mb-1">Active Positions</div>
        <div class="text-2xl font-bold text-blue-400" id="exec-active-positions">-</div>
        <div class="text-xs text-slate-500 mt-1">Open trades</div>
      </div>

      <!-- Total Executions -->
      <div class="bg-slate-900/60 rounded-lg p-3 border border-slate-700">
        <div class="text-xs text-slate-400 mb-1">Total Executions</div>
        <div class="text-2xl font-bold text-emerald-400" id="exec-total">-</div>
        <div class="text-xs text-slate-500 mt-1">All attempts</div>
      </div>

      <!-- Success Rate -->
      <div class="bg-slate-900/60 rounded-lg p-3 border border-slate-700">
        <div class="text-xs text-slate-400 mb-1">Success Rate</div>
        <div class="text-2xl font-bold text-green-400" id="exec-success-rate">-%</div>
        <div class="text-xs text-slate-500 mt-1">Successful fills</div>
      </div>

      <!-- Failed Attempts -->
      <div class="bg-slate-900/60 rounded-lg p-3 border border-slate-700">
        <div class="text-xs text-slate-400 mb-1">Failed Attempts</div>
        <div class="text-2xl font-bold text-red-400" id="exec-failed">-</div>
        <div class="text-xs text-slate-500 mt-1">Rejected/errors</div>
      </div>
    </div>

    <!-- Recent Trades -->
    <div class="bg-slate-900/40 rounded-lg p-3 border border-slate-700">
      <h4 class="text-xs font-semibold text-slate-300 mb-2">üìú Recent Executions (Last 10)</h4>
      <div class="space-y-1.5" id="recent-trades-list">
        <div class="text-xs text-slate-500 text-center py-2">No executions yet</div>
      </div>
    </div>
  </section>

  <!-- Stats Cards -->
  <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <!-- Total Symbols Scanned -->
    <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-slate-400 uppercase tracking-wide">Skenirano</p>
          <p class="mt-1 text-3xl font-bold tracking-tight text-slate-100" id="stat-total-symbols">-</p>
          <p class="mt-1 text-xs text-slate-500">Simbola</p>
        </div>
        <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-xl">üìä</div>
      </div>
    </div>

    <!-- Signals Found -->
    <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-slate-400 uppercase tracking-wide">Signala</p>
          <p class="mt-1 text-3xl font-bold tracking-tight text-emerald-400" id="stat-signals-found">-</p>
          <p class="mt-1 text-xs text-slate-500">Detektovano</p>
        </div>
        <div class="w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center text-xl">üéØ</div>
      </div>
    </div>

    <!-- Pass Rate -->
    <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-slate-400 uppercase tracking-wide">Prolaznost</p>
          <p class="mt-1 text-3xl font-bold tracking-tight text-amber-400" id="stat-pass-rate">-%</p>
          <p class="mt-1 text-xs text-slate-500">Simbola kvalifikuje</p>
        </div>
        <div class="w-10 h-10 rounded-full bg-amber-500/10 flex items-center justify-center text-xl">üìà</div>
      </div>
    </div>

    <!-- Scanner Health -->
    <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-slate-400 uppercase tracking-wide">Status</p>
          <p class="mt-1 text-3xl font-bold tracking-tight text-green-400" id="stat-health">‚úì</p>
          <p class="mt-1 text-xs text-emerald-400" id="stat-health-text">Svi sistemi OK</p>
        </div>
        <div class="w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center">
          <div class="w-3 h-3 rounded-full bg-green-400 animate-pulse"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Advanced Filter & Table Section -->
  <section class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-sm font-semibold text-slate-100">üìä Detaljni Pregled Signala</h3>
      <div class="flex items-center gap-2">
        <button onclick="toggleAdvancedFilters()" class="px-3 py-1 text-xs bg-blue-500/10 border border-blue-500/30 text-blue-300 rounded hover:bg-blue-500/20 transition">
          ‚öôÔ∏è Filteri
        </button>
        <button onclick="clearAllFilters()" class="px-3 py-1 text-xs bg-slate-700 text-slate-300 rounded hover:bg-slate-600 transition">
          ‚Ü∫ Reset
        </button>
      </div>
    </div>

    <!-- Advanced Filters (Togglable) -->
    <div id="advanced-filters" class="filter-controls mb-4 hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Search by Symbol -->
        <div class="filter-group">
          <label>üîç Simbol</label>
          <input type="text" id="filter-symbol" class="filter-input" placeholder="npr. BTCUSDT" onkeyup="applyFilters()">
        </div>

        <!-- Filter by Side -->
        <div class="filter-group">
          <label>üìà Tip Signala</label>
          <select id="filter-side" class="filter-input" onchange="applyFilters()">
            <option value="">Svi</option>
            <option value="LONG">LONG</option>
            <option value="SHORT">SHORT</option>
          </select>
        </div>

        <!-- Volatility Range -->
        <div class="filter-group">
          <label>üìä Volatilnost (%) min-max</label>
          <div class="filter-range">
            <input type="number" id="filter-vol-min" class="filter-input" placeholder="Min" step="0.01" onchange="applyFilters()">
            <span>-</span>
            <input type="number" id="filter-vol-max" class="filter-input" placeholder="Max" step="0.01" onchange="applyFilters()">
          </div>
        </div>

        <!-- Velocity Range -->
        <div class="filter-group">
          <label>‚ö° Velocity (%) min-max</label>
          <div class="filter-range">
            <input type="number" id="filter-vel-min" class="filter-input" placeholder="Min" step="0.0001" onchange="applyFilters()">
            <span>-</span>
            <input type="number" id="filter-vel-max" class="filter-input" placeholder="Max" step="0.01" onchange="applyFilters()">
          </div>
        </div>

        <!-- Momentum Range -->
        <div class="filter-group">
          <label>üí´ Momentum (%) min-max</label>
          <div class="filter-range">
            <input type="number" id="filter-mom-min" class="filter-input" placeholder="Min" step="0.01" onchange="applyFilters()">
            <span>-</span>
            <input type="number" id="filter-mom-max" class="filter-input" placeholder="Max" step="0.1" onchange="applyFilters()">
          </div>
        </div>

        <!-- Imbalance Range -->
        <div class="filter-group">
          <label>‚öñÔ∏è Imbalance min-max</label>
          <div class="filter-range">
            <input type="number" id="filter-imb-min" class="filter-input" placeholder="Min" step="0.01" onchange="applyFilters()">
            <span>-</span>
            <input type="number" id="filter-imb-max" class="filter-input" placeholder="Max" step="0.01" onchange="applyFilters()">
          </div>
        </div>

        <!-- Confidence Range -->
        <div class="filter-group">
          <label>‚úÖ Confidence (%) min-max</label>
          <div class="filter-range">
            <input type="number" id="filter-conf-min" class="filter-input" placeholder="Min" step="1" min="0" max="100" onchange="applyFilters()">
            <span>-</span>
            <input type="number" id="filter-conf-max" class="filter-input" placeholder="Max" step="1" min="0" max="100" onchange="applyFilters()">
          </div>
        </div>
      </div>
    </div>

    <!-- Signals Table -->
    <div class="overflow-x-auto border border-slate-700 rounded-lg">
      <table class="signals-table w-full" id="signals-table">
        <thead>
          <tr>
            <th class="sortable" onclick="sortTable('symbol')" style="width: 100px; text-align: left;">Simbol</th>
            <th class="sortable" onclick="sortTable('side')" style="width: 70px; text-align: center;">Tip</th>
            <th class="sortable" onclick="sortTable('confidence')" style="width: 90px;">Conf %</th>
            <th class="sortable" onclick="sortTable('entry')" style="width: 90px;">Entry</th>
            <th class="sortable" onclick="sortTable('tp')" style="width: 90px;">TP</th>
            <th class="sortable" onclick="sortTable('sl')" style="width: 90px;">SL</th>
            <th class="sortable" onclick="sortTable('volatility')" style="width: 80px;">Vol %</th>
            <th class="sortable" onclick="sortTable('volumeSpike')" style="width: 80px;">Spike x</th>
            <th class="sortable" onclick="sortTable('velocity')" style="width: 80px;">Vel %</th>
            <th class="sortable" onclick="sortTable('momentum')" style="width: 80px;">Mom %</th>
            <th class="sortable" onclick="sortTable('imbalance')" style="width: 90px;">Imbalance</th>
            <th class="sortable" onclick="sortTable('spread')" style="width: 80px;">Spread %</th>
            <th class="sortable" onclick="sortTable('quality')" style="width: 100px;">Kvalitet</th>
          </tr>
        </thead>
        <tbody id="signals-tbody">
          <tr>
            <td colspan="13" class="text-center py-8 text-slate-500">
              üîç Uƒçitavanje signala...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Table Info -->
    <div class="mt-3 flex items-center justify-between text-xs text-slate-400">
      <span id="table-info">0 signala</span>
      <span>Klikni na kolonu za sortiranje ‚Üï</span>
    </div>
  </section>

  <!-- Filter Status -->
  <section class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
    <h3 class="text-sm font-semibold text-slate-100 mb-3">üìã Aktivni Filteri</h3>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
      <div class="bg-slate-800/50 rounded-lg p-3">
        <div class="text-xs text-slate-400 mb-1">Volatilnost</div>
        <div class="text-lg font-bold text-blue-400">‚â• 0.15%</div>
        <div class="text-xs text-slate-500 mt-1" id="filter-volatility-pass">- prolazi</div>
      </div>
      <div class="bg-slate-800/50 rounded-lg p-3">
        <div class="text-xs text-slate-400 mb-1">Volume Spike</div>
        <div class="text-lg font-bold text-purple-400">‚â• 1.5x</div>
        <div class="text-xs text-slate-500 mt-1" id="filter-volume-pass">- prolazi</div>
      </div>
      <div class="bg-slate-800/50 rounded-lg p-3">
        <div class="text-xs text-slate-400 mb-1">Velocity</div>
        <div class="text-lg font-bold text-cyan-400">‚â• 0.03%/min</div>
        <div class="text-xs text-slate-500 mt-1" id="filter-velocity-pass">- prolazi</div>
      </div>
      <div class="bg-slate-800/50 rounded-lg p-3">
        <div class="text-xs text-slate-400 mb-1">Momentum</div>
        <div class="text-lg font-bold text-green-400">‚â• 0.1%</div>
        <div class="text-xs text-slate-500 mt-1" id="filter-momentum-pass">- prolazi</div>
      </div>
      <div class="bg-slate-800/50 rounded-lg p-3">
        <div class="text-xs text-slate-400 mb-1">Imbalance</div>
        <div class="text-lg font-bold text-amber-400">‚â• 1.5</div>
        <div class="text-xs text-slate-500 mt-1" id="filter-imbalance-pass">- prolazi</div>
      </div>
      <div class="bg-slate-800/50 rounded-lg p-3">
        <div class="text-xs text-slate-400 mb-1">Spread</div>
        <div class="text-lg font-bold text-rose-400">‚â§ 0.1%</div>
        <div class="text-xs text-slate-500 mt-1" id="filter-spread-pass">- prolazi</div>
      </div>
    </div>
  </section>

  <!-- Signals List (Card View) -->
  <section class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-sm font-semibold text-slate-100">üéØ Detektovani Signali</h3>
      <div class="flex items-center gap-2">
        <button onclick="clearSignals()" class="px-3 py-1 text-xs bg-red-500/10 border border-red-500/30 text-red-300 rounded hover:bg-red-500/20 transition">
          üóëÔ∏è Oƒçisti sve
        </button>
      </div>
    </div>

    <div id="signals-container" class="space-y-3">
      <!-- Signals will be rendered here -->
      <div class="text-center py-12 text-slate-500">
        <div class="text-4xl mb-2">üîç</div>
        <div>Uƒçitavanje signala...</div>
      </div>
    </div>
  </section>

  <!-- Top Candidates (Close to qualifying) -->
  <section class="rounded-lg border border-slate-800 bg-slate-900/60 p-4">
    <h3 class="text-sm font-semibold text-slate-100 mb-3">üî• Top Kandidati (Blizu praga)</h3>
    <div id="top-candidates-container" class="space-y-2">
      <!-- Top candidates will be rendered here -->
      <div class="text-center py-8 text-slate-500 text-sm">
        Uƒçitavanje...
      </div>
    </div>
  </section>

</div>

<script>
let scannerData = null;

// Format time
function formatTime(timestamp) {
  if (!timestamp) return '-';
  const date = new Date(timestamp);
  return date.toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

// Get Bybit-style precision based on price magnitude
function getPrecisionForPrice(price) {
  if (!price || price === 0) return 2;
  const absPrice = Math.abs(price);

  if (absPrice >= 1000) return 2;      // BTC/ETH
  if (absPrice >= 100) return 2;
  if (absPrice >= 10) return 3;        // $10-99
  if (absPrice >= 1) return 4;         // $1-9
  if (absPrice >= 0.1) return 4;       // $0.1-0.99
  if (absPrice >= 0.01) return 5;      // $0.01-0.099
  if (absPrice >= 0.001) return 5;
  if (absPrice >= 0.0001) return 6;
  if (absPrice >= 0.00001) return 7;
  if (absPrice >= 0.000001) return 8;
  return 10;                           // Meme coins
}

// Format number with adaptive decimals (Bybit-style)
function fmt(num) {
  if (num == null || num === 'N/A') return 'N/A';
  if (typeof num !== 'number') return num;

  const precision = getPrecisionForPrice(num);
  return Number(num.toFixed(precision));
}

// =============== ADVANCED TABLE FUNCTIONS ===============

// Calculate signal quality score
function getSignalQuality(signal) {
  let score = 0;
  let qualityLevel = 'poor';

  // Strong velocity
  if (signal.velocity > 1) score += 3;
  else if (signal.velocity > 0.5) score += 2;
  else if (signal.velocity > 0.05) score += 1;

  // Strong volatility
  if (signal.volatility > 5) score += 3;
  else if (signal.volatility > 1) score += 2;
  else if (signal.volatility > 0.15) score += 1;

  // Strong volume spike
  if (signal.volumeSpike > 3) score += 2;
  else if (signal.volumeSpike > 1.5) score += 1;

  // Strong momentum
  if (signal.momentum > 0.5) score += 2;
  else if (signal.momentum > 0.1) score += 1;

  // Determine quality level
  if (score >= 8) qualityLevel = 'excellent';
  else if (score >= 5) qualityLevel = 'good';
  else if (score >= 2) qualityLevel = 'fair';

  return { score, qualityLevel };
}

// Toggle filter panel
function toggleAdvancedFilters() {
  const filters = document.getElementById('advanced-filters');
  filters.classList.toggle('hidden');
}

// Clear all filters
function clearAllFilters() {
  document.getElementById('filter-symbol').value = '';
  document.getElementById('filter-side').value = '';
  document.getElementById('filter-vol-min').value = '';
  document.getElementById('filter-vol-max').value = '';
  document.getElementById('filter-vel-min').value = '';
  document.getElementById('filter-vel-max').value = '';
  document.getElementById('filter-mom-min').value = '';
  document.getElementById('filter-mom-max').value = '';
  document.getElementById('filter-imb-min').value = '';
  document.getElementById('filter-imb-max').value = '';
  document.getElementById('filter-conf-min').value = '';
  document.getElementById('filter-conf-max').value = '';
  applyFilters();
}

// Apply filters and render table
function applyFilters() {
  if (!scannerData || !scannerData.signals) return;

  const symbol = document.getElementById('filter-symbol').value.toUpperCase();
  const side = document.getElementById('filter-side').value;
  const volMin = parseFloat(document.getElementById('filter-vol-min').value) || 0;
  const volMax = parseFloat(document.getElementById('filter-vol-max').value) || 100;
  const velMin = parseFloat(document.getElementById('filter-vel-min').value) || 0;
  const velMax = parseFloat(document.getElementById('filter-vel-max').value) || 1000;
  const momMin = parseFloat(document.getElementById('filter-mom-min').value) || 0;
  const momMax = parseFloat(document.getElementById('filter-mom-max').value) || 1000;
  const imbMin = parseFloat(document.getElementById('filter-imb-min').value) || 0;
  const imbMax = parseFloat(document.getElementById('filter-imb-max').value) || 10;
  const confMin = parseFloat(document.getElementById('filter-conf-min').value) || 0;
  const confMax = parseFloat(document.getElementById('filter-conf-max').value) || 100;

  // Filter signals
  let filtered = scannerData.signals.filter(signal => {
    if (symbol && !signal.symbol.includes(symbol)) return false;
    if (side && signal.side !== side) return false;
    if (signal.volatility < volMin || signal.volatility > volMax) return false;
    if (signal.velocity < velMin || signal.velocity > velMax) return false;
    if (signal.momentum < momMin || signal.momentum > momMax) return false;
    if (signal.imbalance < imbMin || signal.imbalance > imbMax) return false;
    if (signal.confidence < confMin || signal.confidence > confMax) return false;
    return true;
  });

  // Render filtered signals
  renderSignalsTable(filtered);
}

// Sort table by column
let currentSort = { column: 'symbol', direction: 'asc' };
function sortTable(column) {
  const headers = document.querySelectorAll('.signals-table th.sortable');
  headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));

  if (currentSort.column === column) {
    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.column = column;
    currentSort.direction = 'asc';
  }

  const header = Array.from(headers).find(h => h.textContent.toLowerCase().includes(column.toLowerCase()));
  if (header) {
    header.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
  }

  applyFilters();
}

// Render signals in table
function renderSignalsTable(signals) {
  const tbody = document.getElementById('signals-tbody');

  if (!signals || signals.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="13" class="text-center py-8 text-slate-500">
          ‚è≥ Nema signala koji zadovoljavaju filtre
        </td>
      </tr>
    `;
    document.getElementById('table-info').textContent = '0 signala';
    return;
  }

  // Sort signals
  const sorted = [...signals].sort((a, b) => {
    let aVal = a[currentSort.column];
    let bVal = b[currentSort.column];

    if (aVal === null || aVal === undefined) aVal = '';
    if (bVal === null || bVal === undefined) bVal = '';

    const comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
    return currentSort.direction === 'asc' ? comparison : -comparison;
  });

  // Render rows
  tbody.innerHTML = sorted.map(signal => {
    const { qualityLevel } = getSignalQuality(signal);
    const qualityEmoji = {
      'excellent': '‚≠ê‚≠ê‚≠ê',
      'good': '‚≠ê‚≠ê',
      'fair': '‚≠ê',
      'poor': '‚óã'
    }[qualityLevel];

    return `
      <tr onclick="openSignalModal('${signal.symbol}')" style="cursor: pointer;">
        <td class="font-semibold text-blue-400 px-6 py-4" style="text-align: left;">${signal.symbol}</td>
        <td class="px-6 py-4" style="text-align: center;">
          <span class="px-2 py-1 rounded text-xs font-semibold ${
            signal.side === 'LONG' ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'
          }">
            ${signal.side}
          </span>
        </td>
        <td class="font-semibold text-emerald-400 px-6 py-4">${signal.confidence}%</td>
        <td class="font-mono text-sm px-6 py-4">$${fmt(signal.entry)}</td>
        <td class="font-mono text-sm text-emerald-400 px-6 py-4">$${fmt(signal.takeProfit)}</td>
        <td class="font-mono text-sm text-red-400 px-6 py-4">$${fmt(signal.stopLoss)}</td>
        <td class="${signal.volatility >= 0.15 ? 'text-green-400' : 'text-slate-400'} font-semibold px-6 py-4">${fmt(signal.volatility)}%</td>
        <td class="${signal.volumeSpike >= 1.5 ? 'text-green-400' : 'text-slate-400'} font-semibold px-6 py-4">${fmt(signal.volumeSpike)}x</td>
        <td class="${signal.velocity >= 0.05 ? 'text-green-400' : 'text-slate-400'} font-semibold px-6 py-4">${fmt(signal.velocity)}%</td>
        <td class="${signal.momentum >= 0.1 ? 'text-green-400' : 'text-slate-400'} font-semibold px-6 py-4">${fmt(signal.momentum)}%</td>
        <td class="${(signal.side === 'LONG' && signal.imbalance >= 1.05) || (signal.side === 'SHORT' && signal.imbalance <= 0.95) ? 'text-green-400' : 'text-slate-400'} font-semibold px-6 py-4">${fmt(signal.imbalance)}</td>
        <td class="${signal.spread <= 0.1 ? 'text-green-400' : 'text-slate-400'} font-semibold px-6 py-4">${fmt(signal.spread)}%</td>
        <td class="px-6 py-4">
          <span class="quality-badge quality-${qualityLevel}">
            ${qualityEmoji}
          </span>
        </td>
      </tr>
    `;
  }).join('');

  document.getElementById('table-info').textContent = `${sorted.length} signala`;
}

// ============================================================

function renderSignal(signal) {
  const passCount = [
    signal.volatility >= 0.15,
    signal.volumeSpike >= 1.5,
    signal.velocity >= 0.03,
    signal.momentum >= 0.1,
    signal.imbalance >= 1.5,
    signal.spread <= 0.1
  ].filter(Boolean).length;

  return `
    <div class="signal-card">
      <div class="flex items-start justify-between mb-3">
        <div>
          <div class="flex items-center gap-2">
            <span class="text-lg font-bold text-slate-100">${signal.symbol}</span>
            <span class="px-2 py-0.5 bg-emerald-500/20 text-emerald-300 text-xs font-semibold rounded border border-emerald-500/30">
              ${signal.side}
            </span>
            <span class="px-2 py-0.5 bg-blue-500/20 text-blue-300 text-xs rounded">
              Confidence: ${signal.confidence}%
            </span>
          </div>
          <div class="text-xs text-slate-400 mt-1">
            ${formatTime(signal.timestamp)} ‚Ä¢ Prolazi ${passCount}/6 filtera
          </div>
        </div>
        <div class="text-right">
          <div class="text-xs text-slate-400 mb-1">Entry Zone</div>
          ${signal.entryZone ? `
            <div class="text-xs text-slate-500 font-mono mb-0.5">
              ${fmt(signal.entryZone.min)} ‚Äî ${fmt(signal.entryZone.max)}
            </div>
            <div class="text-base font-bold text-blue-400">
              Ideal: $${fmt(signal.entryZone.ideal)}
            </div>
          ` : `
            <div class="text-lg font-bold text-blue-400">$${fmt(signal.entry)}</div>
          `}
        </div>
      </div>

      <!-- Entry Status Indicator (NEW) -->
      ${signal.entryStatus ? `
        <div class="mb-3 px-3 py-2 rounded-lg border ${
          signal.entryStatus.inZone
            ? 'bg-green-500/10 border-green-500/30'
            : 'bg-amber-500/10 border-amber-500/30'
        }">
          <div class="flex items-center justify-between text-xs">
            <div class="flex items-center gap-2">
              ${signal.entryStatus.inZone
                ? '<span class="text-green-400 font-bold">‚úÖ READY FOR ENTRY</span>'
                : `<span class="text-amber-400">‚è≥ Waiting (${signal.entryStatus.direction} ${fmt(signal.entryStatus.distancePercent)}%)</span>`
              }
            </div>
            <div class="text-slate-400">
              Current: <span class="text-slate-200 font-semibold">$${fmt(signal.live?.price || signal.entry)}</span>
            </div>
          </div>
        </div>
      ` : ''}

      <div class="grid grid-cols-3 gap-2 mb-3 text-xs">
        <div>
          <div class="text-slate-400">TP (+0.22%)</div>
          <div class="text-green-400 font-semibold">$${fmt(signal.takeProfit)}</div>
        </div>
        <div>
          <div class="text-slate-400">SL (-0.15%)</div>
          <div class="text-red-400 font-semibold">$${fmt(signal.stopLoss)}</div>
        </div>
        <div>
          <div class="text-slate-400">Oƒçekivani Profit</div>
          <div class="text-amber-400 font-semibold">$${fmt(signal.expectedProfit)}</div>
        </div>
      </div>

      <div class="flex flex-wrap gap-2">
        <span class="${signal.volatility >= 0.15 ? 'metric-pass' : 'metric-fail'}">
          Vol: ${fmt(signal.volatility)}%
        </span>
        <span class="${signal.volumeSpike >= 1.5 ? 'metric-pass' : 'metric-fail'}">
          Spike: ${fmt(signal.volumeSpike)}x
        </span>
        <span class="${signal.velocity >= 0.03 ? 'metric-pass' : 'metric-fail'}">
          Vel: ${fmt(signal.velocity)}%/m
        </span>
        <span class="${signal.momentum >= 0.1 ? 'metric-pass' : 'metric-fail'}">
          Mom: ${fmt(signal.momentum)}%
        </span>
        <span class="${signal.imbalance >= 1.5 ? 'metric-pass' : 'metric-fail'}">
          Imb: ${fmt(signal.imbalance)}
        </span>
        <span class="${signal.spread <= 0.1 ? 'metric-pass' : 'metric-fail'}">
          Spr: ${fmt(signal.spread)}%
        </span>
      </div>
    </div>
  `;
}

// Render top candidate
function renderCandidate(candidate) {
  const passCount = [
    candidate.volatility >= 0.15,
    candidate.volumeSpike >= 1.5,
    candidate.velocity >= 0.03,
    candidate.momentum >= 0.1,
    candidate.imbalance >= 1.5,
    candidate.spread <= 0.1
  ].filter(Boolean).length;

  return `
    <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg hover:bg-slate-800 transition">
      <div class="flex items-center gap-3">
        <span class="text-sm font-semibold text-slate-100">${candidate.symbol}</span>
        <span class="text-xs text-slate-400">${passCount}/6 filtera</span>
      </div>
      <div class="flex gap-2 text-xs">
        <span class="${candidate.volatility >= 0.15 ? 'metric-pass' : 'metric-fail'}">
          Vol: ${fmt(candidate.volatility)}%
        </span>
        <span class="${candidate.volumeSpike >= 1.5 ? 'metric-pass' : 'metric-fail'}">
          Spike: ${fmt(candidate.volumeSpike)}x
        </span>
        <span class="${candidate.imbalance >= 1.5 ? 'metric-pass' : 'metric-fail'}">
          Imb: ${fmt(candidate.imbalance)}
        </span>
      </div>
    </div>
  `;
}

// Fetch scanner data
async function fetchScannerData() {
  try {
    const response = await fetch('/api/scalp-scanner');
    const data = await response.json();

    if (data.ok) {
      scannerData = data;
      updateUI(data);
    } else {
      console.error('Failed to fetch scanner data:', data.error);
      showError(data.error);
    }
  } catch (error) {
    console.error('Error fetching scanner data:', error);
    showError('Gre≈°ka pri uƒçitavanju podataka');
  }
}

// Update UI with scanner data
function updateUI(data) {
  // Update stats
  document.getElementById('stat-total-symbols').textContent = data.stats.totalScanned || '-';
  document.getElementById('stat-signals-found').textContent = data.stats.signalsFound || '0';

  const passRate = data.stats.totalScanned > 0
    ? ((data.stats.signalsFound / data.stats.totalScanned) * 100).toFixed(1)
    : '0';
  document.getElementById('stat-pass-rate').textContent = passRate + '%';

  // Update last scan time
  document.getElementById('last-scan-time').textContent = 'Poslednje: ' + formatTime(data.lastScan);

  // Update filter stats
  if (data.filterStats) {
    document.getElementById('filter-volatility-pass').textContent = `${data.filterStats.volatility || 0} prolazi`;
    document.getElementById('filter-volume-pass').textContent = `${data.filterStats.volumeSpike || 0} prolazi`;
    document.getElementById('filter-velocity-pass').textContent = `${data.filterStats.velocity || 0} prolazi`;
    document.getElementById('filter-momentum-pass').textContent = `${data.filterStats.momentum || 0} prolazi`;
    document.getElementById('filter-imbalance-pass').textContent = `${data.filterStats.imbalance || 0} prolazi`;
    document.getElementById('filter-spread-pass').textContent = `${data.filterStats.spread || 0} prolazi`;
  }

  // Render signals
  const signalsContainer = document.getElementById('signals-container');
  if (data.signals && data.signals.length > 0) {
    signalsContainer.innerHTML = data.signals.map(renderSignal).join('');
  } else {
    signalsContainer.innerHTML = `
      <div class="text-center py-12 text-slate-500">
        <div class="text-4xl mb-2">‚è≥</div>
        <div>Nema signala u poslednjem skeniranju</div>
        <div class="text-xs text-slate-600 mt-2">Scanner radi i detektovaƒáe signale kad se uslovi poklope</div>
      </div>
    `;
  }

  // Render top candidates
  const candidatesContainer = document.getElementById('top-candidates-container');
  if (data.topCandidates && data.topCandidates.length > 0) {
    candidatesContainer.innerHTML = data.topCandidates.map(renderCandidate).join('');
  } else {
    candidatesContainer.innerHTML = `
      <div class="text-center py-8 text-slate-500 text-sm">
        Nema kandidata blizu praga
      </div>
    `;
  }

  // Update advanced table view with filters applied
  applyFilters();
}

// Show error message
function showError(message) {
  const signalsContainer = document.getElementById('signals-container');
  signalsContainer.innerHTML = `
    <div class="text-center py-12 text-red-400">
      <div class="text-4xl mb-2">‚ö†Ô∏è</div>
      <div>${message}</div>
    </div>
  `;
}

// Clear all signals
async function clearSignals() {
  if (!confirm('Da li ste sigurni da ≈æelite da obri≈°ete sve signale?')) return;

  try {
    const response = await fetch('/api/scalp-scanner/clear', { method: 'POST' });
    const data = await response.json();

    if (data.ok) {
      await refreshData();
    } else {
      alert('Gre≈°ka: ' + data.error);
    }
  } catch (error) {
    console.error('Error clearing signals:', error);
    alert('Gre≈°ka pri brisanju signala');
  }
}

// Refresh data
async function refreshData() {
  await fetchScannerData();
  await fetchExecutionStats();
}

// Fetch execution statistics
async function fetchExecutionStats() {
  try {
    // Fetch execution stats
    const statsResponse = await fetch('/api/execution/stats');
    const statsData = await statsResponse.json();

    // Fetch active positions
    const positionsResponse = await fetch('/api/execution/positions');
    const positionsData = await positionsResponse.json();

    if (statsData.ok) {
      // Update stats
      document.getElementById('exec-total').textContent = statsData.stats.totalExecutions || 0;
      document.getElementById('exec-success-rate').textContent = statsData.stats.successRate + '%' || '0%';
      document.getElementById('exec-failed').textContent = statsData.stats.failedExecutions || 0;

      // Update recent trades
      const tradesList = document.getElementById('recent-trades-list');
      if (statsData.recentTrades && statsData.recentTrades.length > 0) {
        tradesList.innerHTML = statsData.recentTrades.slice(0, 10).map(trade => {
          const statusIcon = trade.success ? '‚úÖ' : '‚ùå';
          const statusClass = trade.success ? 'text-emerald-400' : 'text-red-400';
          const modeLabel = trade.dryRun ? 'üîí DRY-RUN' : 'üí∞ LIVE';
          const time = new Date(trade.timestamp).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

          return `
            <div class="flex items-center justify-between text-xs bg-slate-800/40 rounded px-2 py-1.5">
              <div class="flex items-center gap-2">
                <span class="${statusClass}">${statusIcon}</span>
                <span class="font-mono text-slate-300">${trade.symbol}</span>
                <span class="text-slate-400">${trade.direction}</span>
                <span class="text-slate-500">@ ${trade.entry}</span>
              </div>
              <div class="flex items-center gap-2 text-slate-500">
                <span>${modeLabel}</span>
                <span>${time}</span>
              </div>
            </div>
          `;
        }).join('');
      } else {
        tradesList.innerHTML = '<div class="text-xs text-slate-500 text-center py-2">No executions yet</div>';
      }
    }

    if (positionsData.ok) {
      document.getElementById('exec-active-positions').textContent = positionsData.count || 0;
    }

  } catch (error) {
    console.error('Error fetching execution stats:', error);
  }
}

// Close modal on ESC key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeSignalModal();
});

// Global state for dynamic entry calculation
window.modalState = {
  symbol: null,
  currentPrice: null,
  support: null,
  resistance: null,
  atr: null,
  trendDirection: null,
  trendIsBullish: false,
  trendIsBearish: false
};

// Modal Functions
function openSignalModal(symbol) {
  console.log('üîì Opening modal for symbol:', symbol);
  const modal = document.getElementById('signal-modal');
  if (!modal) {
    console.error('‚ùå Modal element not found!');
    return;
  }
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
  console.log('‚úÖ Modal opened, loading details...');
  loadSignalDetails(symbol);

  // Start auto-refresh of market data every 500ms while modal is open
  if (window.modalRefreshInterval) clearInterval(window.modalRefreshInterval);
  window.modalRefreshInterval = setInterval(() => {
    const modal = document.getElementById('signal-modal');
    if (modal && modal.style.display === 'flex') {
      loadMarketDataQuick(symbol);
      updateDynamicEntry(); // Update entry/TP/SL every 500ms
    } else {
      clearInterval(window.modalRefreshInterval);
    }
  }, 500);
}

function closeSignalModal() {
  const modal = document.getElementById('signal-modal');
  modal.style.display = 'none';

  // Stop auto-refresh when modal closes
  if (window.modalRefreshInterval) {
    clearInterval(window.modalRefreshInterval);
    window.modalRefreshInterval = null;
  }
}

async function loadSignalDetails(symbol) {
  try {
    // Get current signals
    const response = await fetch('/api/scalp-scanner');
    const data = await response.json();
    const signal = data.signals.find(s => s.symbol === symbol);

    if (!signal) {
      console.error('Signal not found:', symbol);
      return;
    }

    // Update modal header
    document.getElementById('modal-symbol').textContent = symbol;
    const timestamp = new Date().toLocaleString('sr-RS');
    document.getElementById('modal-timestamp').textContent = timestamp;

    // Store symbol in modal state
    window.modalState.symbol = symbol;

    // Store wall analysis (if available from signal)
    if (signal.wallAnalysis) {
      window.modalState.wallAnalysis = signal.wallAnalysis;
      console.log('üß± Wall analysis loaded:', signal.wallAnalysis);
    }

    // Load live market data
    await loadMarketData(symbol);

    // Load candle data and analysis
    await loadCandleData(symbol);

    // Load quality assessment
    loadQualityAssessment(signal);

  } catch (error) {
    console.error('Error loading signal details:', error);
    document.getElementById('modal-market-data').innerHTML = `
      <div class="text-center py-8 text-red-400">
        ‚ùå Gre≈°ka pri uƒçitavanju podataka
      </div>
    `;
  }
}

async function loadMarketData(symbol) {
  try {
    // Fetch ticker data from Bybit API
    const response = await fetch(`https://api.bybit.com/v5/market/tickers?category=linear&symbol=${symbol}`);
    const data = await response.json();

    console.log('üîç Bybit API Response:', data);
    console.log('üìä Full Ticker Data:', data.result?.list[0]);

    const ticker = data.result?.list[0];
    if (ticker) {
      console.log(`lastPrice type: ${typeof ticker.lastPrice}, value: "${ticker.lastPrice}"`);
      console.log(`highPrice24h type: ${typeof ticker.highPrice24h}, value: "${ticker.highPrice24h}"`);
      console.log(`lowPrice24h type: ${typeof ticker.lowPrice24h}, value: "${ticker.lowPrice24h}"`);
      console.log(`indexPrice type: ${typeof ticker.indexPrice}, value: "${ticker.indexPrice}"`);
      console.log(`markPrice type: ${typeof ticker.markPrice}, value: "${ticker.markPrice}"`);
    }

    if (data.retCode !== 0 || !data.result || !data.result.list || data.result.list.length === 0) {
      document.getElementById('modal-market-data').innerHTML = `
        <div class="text-center py-4 text-slate-500">
          ‚ö†Ô∏è Nije moguƒáe uƒçitati tr≈æi≈°ne podatke
        </div>
      `;
      return;
    }

    console.log('üìä Raw ticker lastPrice:', ticker.lastPrice, typeof ticker.lastPrice);

    // Simply use the price string exactly as Bybit provides it
    const formatPrice = (priceValue) => {
      if (priceValue === null || priceValue === undefined) return '0';

      // Convert to string if it's a number (to preserve decimals)
      const str = String(priceValue);
      console.log(`üí∞ formatPrice("${priceValue}") ‚Üí "${str}"`);

      return str;
    };    const marketHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
        <!-- Current Price -->
        <div style="background-color: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem;">
          <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Trenutna Cijena</div>
          <div id="debug-price-display" data-price-type="lastPrice" style="font-size: 1.5rem; font-weight: bold; color: #f1f5f9; font-family: monospace; letter-spacing: 0.05em;">$${formatPrice(ticker.lastPrice)}</div>
          <div data-price-type="change24h" style="font-size: 0.75rem; color: ${ticker.price24hPcnt > 0 ? '#10b981' : '#ef4444'}; margin-top: 0.25rem;">
            ${ticker.price24hPcnt > 0 ? 'üìà' : 'üìâ'} ${(ticker.price24hPcnt * 100).toFixed(2)}%
          </div>
          <div style="font-size: 0.6rem; color: #64748b; margin-top: 0.25rem; font-family: monospace;">Raw: ${ticker.lastPrice}</div>
        </div>

        <!-- 24H High -->
        <div style="background-color: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem;">
          <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">24H High</div>
          <div data-price-type="highPrice24h" style="font-size: 1.5rem; font-weight: bold; color: #10b981;">$${formatPrice(ticker.highPrice24h)}</div>
          <div style="font-size: 0.6rem; color: #64748b; margin-top: 0.25rem; font-family: monospace;">Raw: ${ticker.highPrice24h}</div>
        </div>

        <!-- 24H Low -->
        <div style="background-color: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem;">
          <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">24H Low</div>
          <div data-price-type="lowPrice24h" style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">$${formatPrice(ticker.lowPrice24h)}</div>
          <div style="font-size: 0.6rem; color: #64748b; margin-top: 0.25rem; font-family: monospace;">Raw: ${ticker.lowPrice24h}</div>
        </div>

        <!-- Index Price -->
        <div style="background-color: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem;">
          <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Index Price</div>
          <div data-price-type="indexPrice" style="font-size: 1.5rem; font-weight: bold; color: #0ea5e9;">$${formatPrice(ticker.indexPrice)}</div>
          <div style="font-size: 0.6rem; color: #64748b; margin-top: 0.25rem; font-family: monospace;">Raw: ${ticker.indexPrice}</div>
        </div>

        <!-- 24H Volume -->
        <div style="background-color: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem;">
          <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">24H Turnover</div>
          <div data-price-type="turnover24h" style="font-size: 1rem; font-weight: bold; color: #f1f5f9;">$${(parseFloat(ticker.turnover24h) / 1e6).toFixed(2)}M</div>
        </div>

        <!-- Funding Rate -->
        <div style="background-color: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem;">
          <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Funding Rate</div>
          <div data-price-type="fundingRate" style="font-size: 1.5rem; font-weight: bold; color: ${ticker.fundingRate > 0 ? '#10b981' : '#ef4444'};">${(ticker.fundingRate * 100).toFixed(4)}%</div>
        </div>

        <!-- Open Interest -->
        <div style="background-color: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem;">
          <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Open Interest</div>
          <div data-price-type="openInterest" style="font-size: 1rem; font-weight: bold; color: #f1f5f9;">${(parseFloat(ticker.openInterest) / 1e6).toFixed(2)}M</div>
        </div>

        <!-- Mark Price -->
        <div style="background-color: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem;">
          <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Mark Price</div>
          <div data-price-type="markPrice" style="font-size: 1.5rem; font-weight: bold; color: #0ea5e9;">$${formatPrice(ticker.markPrice)}</div>
          <div style="font-size: 0.6rem; color: #64748b; margin-top: 0.25rem; font-family: monospace;">Raw: ${ticker.markPrice}</div>
        </div>
      </div>
    `;

    document.getElementById('modal-market-data').innerHTML = marketHTML;

  } catch (error) {
    console.error('Error loading market data:', error);
    document.getElementById('modal-market-data').innerHTML = `
      <div class="text-center py-4 text-red-400">
        ‚ùå Gre≈°ka pri uƒçitavanju tr≈æi≈°nih podataka
      </div>
    `;
  }
}

// Quick market data refresh - updates only the price values without reloading entire HTML
async function loadMarketDataQuick(symbol) {
  try {
    const response = await fetch(`https://api.bybit.com/v5/market/tickers?category=linear&symbol=${symbol}`);
    const data = await response.json();

    if (data.retCode !== 0 || !data.result || !data.result.list || data.result.list.length === 0) {
      return; // Silent fail - don't break the display
    }

    const ticker = data.result.list[0];

    // Update current price
    const formatPrice = (priceValue) => {
      if (priceValue === null || priceValue === undefined) return '0';
      const str = String(priceValue);
      return str;
    };

    // Update price elements if they exist
    const priceElements = document.querySelectorAll('[data-price-type="lastPrice"]');
    if (priceElements.length > 0) {
      priceElements.forEach(el => {
        el.textContent = '$' + formatPrice(ticker.lastPrice);
      });
    }

    // Update 24h change
    const changeElements = document.querySelectorAll('[data-price-type="change24h"]');
    if (changeElements.length > 0) {
      changeElements.forEach(el => {
        const changePercent = (ticker.price24hPcnt * 100).toFixed(2);
        const emoji = ticker.price24hPcnt > 0 ? 'üìà' : 'üìâ';
        const color = ticker.price24hPcnt > 0 ? '#10b981' : '#ef4444';
        el.style.color = color;
        el.textContent = `${emoji} ${changePercent}%`;
      });
    }

    // Update high/low/index/mark prices
    const updatePrice = (dataAttribute, newPrice) => {
      const elements = document.querySelectorAll(`[data-price-type="${dataAttribute}"]`);
      elements.forEach(el => {
        el.textContent = '$' + formatPrice(newPrice);
      });
    };

    updatePrice('highPrice24h', ticker.highPrice24h);
    updatePrice('lowPrice24h', ticker.lowPrice24h);
    updatePrice('indexPrice', ticker.indexPrice);
    updatePrice('markPrice', ticker.markPrice);
    updatePrice('fundingRate', ticker.fundingRate * 100);
    updatePrice('turnover24h', (parseFloat(ticker.turnover24h) / 1e6).toFixed(2));
    updatePrice('openInterest', (parseFloat(ticker.openInterest) / 1e6).toFixed(2));

    console.log(`‚úÖ Quick refresh for ${symbol}: ${formatPrice(ticker.lastPrice)}`);

  } catch (error) {
    console.warn('Quick refresh failed (silent):', error);
    // Silent fail - don't break the modal
  }
}

// ========================================
// EXECUTION CONFIG CONSTANTS
// (Synced from bybitOrderExecutor.js)
// ========================================
const EXECUTION_CONFIG = {
  leverage: 3,
  marginPerTrade: 18,
  tpDistance: 0.0035,   // 0.35% TP
  slDistance: 0.0030,   // 0.30% SL
  minMomentumPercent: 50 // 50% minimum momentum
};

// Calculated position size
const POSITION_SIZE = EXECUTION_CONFIG.marginPerTrade * EXECUTION_CONFIG.leverage; // $54

// Dynamic entry calculation - updates every 500ms
function updateDynamicEntry() {
  if (!window.modalState.support || !window.modalState.resistance || !window.modalState.atr) {
    return; // Not ready yet
  }

  try {
    // Get current price from DOM
    const priceElement = document.querySelector('[data-price-type="lastPrice"]');
    if (!priceElement) return;

    const currentPriceText = priceElement.textContent.replace('$', '').trim();
    const currentPrice = parseFloat(currentPriceText);

    if (!currentPrice || isNaN(currentPrice)) return;

    window.modalState.currentPrice = currentPrice;

    const support = window.modalState.support;
    const resistance = window.modalState.resistance;
    const atr = window.modalState.atr;
    const isBullish = window.modalState.trendIsBullish;
    const isBearish = window.modalState.trendIsBearish;

    let entry, tp, sl, profitPotential, profitPercent, entryStatus;

    if (isBearish) {
      // SHORT strategy - Follow price DOWN
      // Entry se pomjera dolje kako cijena pada, prateƒái je sa manjim offset-om
      const minEntryPrice = support; // Ne smije iƒái ispod ovoga (support)
      entry = Math.max(resistance - (atr * 0.3) - (resistance - currentPrice) * 0.25, minEntryPrice);
      entry = Math.min(entry, resistance); // Osiguraj maksimum (resistance)

      tp = support;
      sl = resistance + atr;
      profitPotential = entry - tp;
      profitPercent = ((profitPotential / entry) * 100).toFixed(2);

      // Status message - prati gdje je cijena u odnosu na entry
      const priceVsEntry = ((entry - currentPrice) / entry * 100).toFixed(2);

      if (currentPrice > resistance * 0.98) {
        entryStatus = 'üéØ ODLIƒåAN ENTRY ZONE (Blizu resistance-a) - ULAZAK SADA!';
      } else if (currentPrice > resistance * 0.95) {
        entryStatus = '‚úÖ DOBAR ENTRY ZONE - Mo≈æe≈° uƒái';
      } else if (currentPrice > resistance * 0.90) {
        entryStatus = `‚è≥ ƒåekaj pullback gore... (Cijena je ${priceVsEntry}% ispod entry-a)`;
      } else if (currentPrice > support * 1.02) {
        entryStatus = `üìâ Trend je jak! Praƒáenje cijene... (${priceVsEntry}% ispod entry-a)`;
      } else {
        entryStatus = '‚ö†Ô∏è Blizu support-a - Razmisli o izlasku ili lock-in profit';
      }
    } else if (isBullish) {
      // LONG strategy - Follow price UP
      // Entry se pomjera gore kako cijena raste, prateƒái je sa manjim offset-om
      const maxEntryPrice = resistance; // Ne smije iƒái iznad ovoga
      entry = Math.min(support + (atr * 0.3) + (currentPrice - support) * 0.25, maxEntryPrice);
      entry = Math.max(entry, support); // Osiguraj minimum (support)

      tp = resistance;
      sl = support - atr;
      profitPotential = tp - entry;
      profitPercent = ((profitPotential / entry) * 100).toFixed(2);

      // Status message - prati gdje je cijena u odnosu na entry
      const priceVsEntry = ((currentPrice - entry) / entry * 100).toFixed(2);

      if (currentPrice < support * 1.02) {
        entryStatus = 'üéØ ODLIƒåAN ENTRY ZONE (Blizu support-a) - ULAZAK SADA!';
      } else if (currentPrice < support * 1.05) {
        entryStatus = '‚úÖ DOBAR ENTRY ZONE - Mo≈æe≈° uƒái';
      } else if (currentPrice < support * 1.10) {
        entryStatus = `‚è≥ ƒåekaj pullback... (Cijena je ${priceVsEntry}% iznad entry-a)`;
      } else if (currentPrice < resistance * 0.98) {
        entryStatus = `üìà Trend je jak! Praƒáenje cijene... (${priceVsEntry}% iznad entry-a)`;
      } else {
        entryStatus = '‚ö†Ô∏è Blizu resistance-a - Razmisli o izlasku ili lock-in profit';
      }
    } else {
      // NEUTRAL
      entry = currentPrice;
      tp = resistance;

      sl = support;
      profitPotential = 0;
      profitPercent = 0;
      entryStatus = '‚è∏Ô∏è ƒåEKAJ BREAKOUT';
    }

    // Update DOM elements
    const updateElement = (selector, text) => {
      const el = document.querySelector(selector);
      if (el) el.textContent = text;
    };

    // Calculate difference between current price and entry
    const priceDifference = currentPrice - entry;
    const priceDifferencePercent = ((priceDifference / entry) * 100).toFixed(2);
    const differenceText = priceDifference > 0
      ? `+$${priceDifference.toFixed(8)} (+${priceDifferencePercent}%)`
      : `$${priceDifference.toFixed(8)} (${priceDifferencePercent}%)`;

    updateElement('[data-dynamic="current-price"]', '$' + currentPrice.toFixed(8));
    updateElement('[data-dynamic="current-price-trading"]', '$' + currentPrice.toFixed(8));
    updateElement('[data-dynamic="price-difference"]', differenceText);
    updateElement('[data-dynamic="entry"]', '$' + entry.toFixed(8));
    updateElement('[data-dynamic="tp"]', '$' + tp.toFixed(8));
    updateElement('[data-dynamic="sl"]', '$' + sl.toFixed(8));
    updateElement('[data-dynamic="profit"]', '$' + profitPotential.toFixed(8));
    updateElement('[data-dynamic="roi"]', profitPercent + '%');
    updateElement('[data-dynamic="status"]', entryStatus);

    // ========================================
    // WIN RATE CALCULATION
    // ========================================
    // R/R Ratio = SL Distance / TP Distance
    const tpDistance = Math.abs(tp - entry);
    const slDistance = Math.abs(entry - sl);
    const riskRewardRatio = slDistance / tpDistance;
    const positionSize = POSITION_SIZE; // $18 √ó 3x leverage (from EXECUTION_CONFIG)

    // Calculate win rate based on multiple factors
    let winRate = 50; // Baseline 50%
    let factors = {};

    // Factor 1: Risk/Reward Ratio (¬±25 points)
    if (riskRewardRatio > 2) {
      factors.rrRatio = 25;
    } else if (riskRewardRatio > 1) {
      factors.rrRatio = 15;
    } else if (riskRewardRatio > 0.5) {
      factors.rrRatio = 5;
    } else {
      factors.rrRatio = -15;
    }

    // Factor 2: Entry Position vs Support/Resistance (¬±20 points)
    let entryVsSR;
    if (isBullish) {
      entryVsSR = (entry - support) / (resistance - support);
    } else {
      entryVsSR = (resistance - entry) / (resistance - support);
    }

    if (entryVsSR > 0.7) {
      factors.entryPosition = -20; // Bad entry (too close to resistance for LONG, support for SHORT)
    } else if (entryVsSR > 0.5) {
      factors.entryPosition = 0;
    } else if (entryVsSR > 0.3) {
      factors.entryPosition = 15;
    } else {
      factors.entryPosition = 20; // Good entry (close to support for LONG, resistance for SHORT)
    }

    // Factor 3: Trend Strength (¬±25 points)
    const trendStrength = window.modalState.trendStrength || 50;
    if (trendStrength > 70) {
      factors.trendStrength = 25;
    } else if (trendStrength > 60) {
      factors.trendStrength = 15;
    } else if (trendStrength > 50) {
      factors.trendStrength = 5;
    } else {
      factors.trendStrength = -20;
    }

    // Factor 4: Imbalance Alignment (¬±15 points)
    // This would come from live data
    factors.imbalance = isBullish ? 10 : -5; // Simplified - can be enhanced

    // Factor 5: Volatility (¬±15 points)
    // Lower volatility = more predictable = better
    // Higher volatility = more risk = worse
    const atrPercent = (atr / currentPrice) * 100;
    if (atrPercent < 0.3) {
      factors.volatility = 15; // Very low vol - predictable
    } else if (atrPercent < 0.5) {
      factors.volatility = 10;
    } else if (atrPercent < 1.0) {
      factors.volatility = 0;
    } else {
      factors.volatility = -10; // High vol - risky
    }

    // Factor 6: Momentum/Velocity (¬±20 points)
    const priceMomentum = isBullish ? (currentPrice - entry) : (entry - currentPrice);
    if (Math.abs(priceMomentum / entry) > 0.01) {
      factors.momentum = 20; // Strong momentum
    } else if (Math.abs(priceMomentum / entry) > 0.005) {
      factors.momentum = 10;
    } else if (Math.abs(priceMomentum / entry) > 0) {
      factors.momentum = 5;
    } else {
      factors.momentum = -15; // Against trend
    }

    // Factor 7: Wall Status Validation (¬±20 points)
    let wallStatus = window.modalState.wallAnalysis?.wallStatus || 'NO_DATA';
    let wallConfidence = window.modalState.wallAnalysis?.confidenceScore || 0;

    if (wallStatus === 'BROKEN') {
      factors.wallStatus = 20 * (wallConfidence / 100);
    } else if (wallStatus === 'ABSORBING') {
      factors.wallStatus = 15 * (wallConfidence / 100);
    } else if (wallStatus === 'STRONG') {
      factors.wallStatus = -5 * (wallConfidence / 100);
    } else {
      factors.wallStatus = 0; // NO_DATA
    }

    // Calculate final win rate
    winRate = 50 +
      (factors.rrRatio || 0) +
      (factors.entryPosition || 0) +
      (factors.trendStrength || 0) +
      (factors.imbalance || 0) +
      (factors.volatility || 0) +
      (factors.momentum || 0) +
      (factors.wallStatus || 0);

    // Clamp between 20% and 95%
    winRate = Math.max(20, Math.min(95, winRate));

    // Calculate Expected Value (in percentage terms)
    // EV% = (Win% √ó Profit%) - (Loss% √ó Loss%)
    const tpProfitPercent = ((tp - entry) / entry) * 100;
    const slLossPercent = ((entry - sl) / entry) * 100;
    const winProbability = winRate / 100;
    const lossProbability = 1 - winProbability;

    const expectedValuePercent = (winProbability * tpProfitPercent - lossProbability * slLossPercent).toFixed(2);

    // Determine Risk Level
    let riskLevel = 'MODERATE';
    if (winRate > 70) {
      riskLevel = '‚úÖ NISKA RISK';
    } else if (winRate > 60) {
      riskLevel = '‚ö†Ô∏è SREDNJA RISK';
    } else if (winRate > 50) {
      riskLevel = '‚ö†Ô∏è POVEƒÜANA RISK';
    } else {
      riskLevel = '‚ùå VISOKA RISK';
    }

    // Update win rate display
    updateElement('[data-dynamic="win-rate"]', Math.round(winRate) + '%');
    updateElement('[data-dynamic="rr-ratio"]', riskRewardRatio.toFixed(2) + ':1');
    updateElement('[data-dynamic="expected-value"]', expectedValuePercent + '%');
    updateElement('[data-dynamic="risk-level"]', riskLevel);

    // Show breakdown
    const breakdownEl = document.querySelector('[data-dynamic="win-rate-breakdown"]');
    if (breakdownEl) {
      breakdownEl.style.display = 'block';

      const updateBreakdown = (selector, text) => {
        const el = breakdownEl.querySelector(selector);
        if (el) el.textContent = text;
      };

      updateBreakdown('[data-breakdown-item="rr-ratio"]',
        `üìä Risk/Reward: ${riskRewardRatio.toFixed(2)}:1 (${factors.rrRatio > 0 ? '+' : ''}${factors.rrRatio} pts) ${riskRewardRatio > 2 ? 'üü¢' : riskRewardRatio > 1 ? 'üü°' : 'üî¥'}`);
      updateBreakdown('[data-breakdown-item="entry-position"]',
        `Entry Position: ${(entryVsSR * 100).toFixed(0)}% (${factors.entryPosition > 0 ? '+' : ''}${factors.entryPosition} pts)`);
      updateBreakdown('[data-breakdown-item="trend-strength"]',
        `Trend Strength: ${trendStrength}% (${factors.trendStrength > 0 ? '+' : ''}${factors.trendStrength} pts)`);
      updateBreakdown('[data-breakdown-item="imbalance"]',
        `Imbalance Alignment: ${factors.imbalance > 0 ? '‚úÖ' : '‚ùå'} (${factors.imbalance > 0 ? '+' : ''}${factors.imbalance} pts)`);
      updateBreakdown('[data-breakdown-item="volatility"]',
        `Volatility: ${atrPercent.toFixed(3)}% (${factors.volatility > 0 ? '+' : ''}${factors.volatility} pts)`);
      updateBreakdown('[data-breakdown-item="momentum"]',
        `Momentum: ${(Math.abs(priceMomentum / entry) * 100).toFixed(2)}% (${factors.momentum > 0 ? '+' : ''}${factors.momentum} pts)`);
      updateBreakdown('[data-breakdown-item="wall-status"]',
        `Wall Status: ${wallStatus} ${wallConfidence}% (${factors.wallStatus > 0 ? '+' : ''}${factors.wallStatus.toFixed(0)} pts)`);
    }

    // ========================================
    // END WIN RATE CALCULATION
    // ========================================

    // ========================================
    // POSITION SIZING CALCULATOR
    // ========================================
    // Use POSITION_SIZE constant from execution config
    const positionSizeForCalc = POSITION_SIZE; // $18 √ó 3x leverage = $54

    // Calculate % price change needed for specific profit targets
    const calcPricePercentNeeded = (profitTarget) => {
      return (profitTarget / positionSizeForCalc) * 100;
    };

    const percent1Dollar = calcPricePercentNeeded(1);
    const percent5Dollar = calcPricePercentNeeded(5);
    const percent10Dollar = calcPricePercentNeeded(10);
    const percentTP = ((tp - entry) / entry) * 100;

    // Update position calculator display
    const updateCalc = (selector, text) => {
      const el = document.querySelector(selector);
      if (el) el.textContent = text;
    };

    updateCalc('[data-calc="profit-1"]', percent1Dollar.toFixed(3) + '%');
    updateCalc('[data-calc="profit-5"]', percent5Dollar.toFixed(3) + '%');
    updateCalc('[data-calc="profit-10"]', percent10Dollar.toFixed(3) + '%');
    updateCalc('[data-calc="profit-tp"]', percentTP.toFixed(3) + '%');

    // ========================================
    // END POSITION SIZING CALCULATOR
    // ========================================

    // Update wall analysis display (if available)
    if (window.modalState.wallAnalysis) {
      const wallStatus = window.modalState.wallAnalysis.wallStatus || 'NO DATA';
      const buyWallStatus = window.modalState.wallAnalysis.buyWallStatus || '-';
      const sellWallStatus = window.modalState.wallAnalysis.sellWallStatus || '-';
      const wallConfidence = window.modalState.wallAnalysis.confidenceScore || 0;

      updateElement('[data-dynamic="wall-status"]', wallStatus);
      updateElement('[data-dynamic="buy-wall-status"]', buyWallStatus);
      updateElement('[data-dynamic="sell-wall-status"]', sellWallStatus);
      updateElement('[data-dynamic="wall-confidence"]', wallConfidence + '%');
    }

    // Debug logging
    console.log(`üí° updateDynamicEntry() called:`);
    console.log(`   Current Price: $${currentPrice.toFixed(8)}`);
    console.log(`   Support: $${support.toFixed(8)}, Resistance: $${resistance.toFixed(8)}, ATR: $${atr.toFixed(8)}`);
    console.log(`   Entry Calculated: $${entry.toFixed(8)}`);
    console.log(`   Status: ${entryStatus}`);
    console.log(`   Bullish: ${isBullish}, Bearish: ${isBearish}`);

  } catch (error) {
    console.warn('Dynamic entry update failed:', error);
  }
}

async function loadCandleData(symbol) {
  try {
    const response = await fetch(`/api/symbol/${symbol}/candles/1m?limit=360`);
    const data = await response.json();

    console.log('üìä Candle data response:', data);

    if (!data.ok && !data.success) {
      throw new Error('API returned error: ' + (data.error || 'unknown error'));
    }

    if (!data.candles || data.candles.length === 0) {
      console.warn('‚ö†Ô∏è No candles found for', symbol);
      document.getElementById('modal-candles').innerHTML = `
        <div class="text-center py-8 text-slate-500">
          ‚ö†Ô∏è Nema dostupnih candle podataka za ovaj simbol (${data.count || 0} candles received)
        </div>
      `;
      return;
    }

    console.log(`‚úÖ Received ${data.candles.length} candles for ${symbol}`);
    const candles = data.candles;
    const analysis = analyzeCandlesTrend(candles);

    // Store analysis data in modal state for dynamic entry updates
    window.modalState.support = analysis.support;
    window.modalState.resistance = analysis.resistance;
    window.modalState.atr = analysis.atr;
    window.modalState.trendDirection = analysis.trendDirection;
    window.modalState.trendIsBullish = analysis.trendDirection === 'BULLISH ‚¨ÜÔ∏è';
    window.modalState.trendIsBearish = analysis.trendDirection === 'BEARISH ‚¨áÔ∏è';

    console.log('üìä Modal state updated:', window.modalState);

    // Render analysis report
    const analysisHTML = `
      <div class="space-y-4">
        <!-- Trend Direction -->
        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 2px solid ${analysis.trendColor}; border-radius: 0.75rem; padding: 1.5rem;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <div style="font-size: 3rem;">${analysis.trendEmoji}</div>
            <div>
              <div style="font-size: 1.5rem; font-weight: bold; color: ${analysis.trendColor};">${analysis.trendDirection}</div>
              <div style="font-size: 0.875rem; color: #cbd5e1; margin-top: 0.25rem;">Trend snaga: <strong>${analysis.trendStrength}%</strong></div>
            </div>
          </div>
          <div style="color: #e2e8f0; font-size: 0.95rem; line-height: 1.6;">${analysis.trendDescription}</div>
        </div>

        <!-- Key Metrics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div style="background-color: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem;">
            <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Trenutna Cijena</div>
            <div style="font-size: 1.5rem; font-weight: bold; color: #f1f5f9;">$${analysis.currentPrice}</div>
          </div>
          <div style="background-color: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem;">
            <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">6h Promjena</div>
            <div style="font-size: 1.5rem; font-weight: bold; color: ${analysis.sixHourChange > 0 ? '#10b981' : '#ef4444'};">${analysis.sixHourChange > 0 ? '+' : ''}${analysis.sixHourChange.toFixed(3)}%</div>
          </div>
          <div style="background-color: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem;">
            <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Support/Resistance</div>
            <div style="font-size: 0.875rem; color: #cbd5e1;">
              <div>S: $${analysis.support.toFixed(8)}</div>
              <div>R: $${analysis.resistance.toFixed(8)}</div>
            </div>
          </div>
        </div>

        <!-- Multi-Timeframe Analysis Section -->
        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 2px solid #0ea5e9; border-radius: 0.75rem; padding: 1.5rem;">
          <div style="font-size: 1.1rem; font-weight: bold; color: #f1f5f9; margin-bottom: 1rem;">üìä Multi-vremenski Horizont Analiza</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
            <!-- 5-minute -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border: 2px solid ${analysis.predictions[0]?.color || '#6b7280'}; border-radius: 0.5rem; padding: 1rem; text-align: center;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">5 MINUTA</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: ${analysis.predictions[0]?.color || '#6b7280'};">${analysis.predictions[0]?.direction || '‚ùì'}</div>
              <div style="font-size: 0.75rem; color: #cbd5e1; margin-top: 0.5rem;">üî¥ PRIORITET!</div>
            </div>

            <!-- 15-minute -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border: 1px solid ${analysis.predictions[1]?.color || '#6b7280'}; border-radius: 0.5rem; padding: 1rem; text-align: center;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">15 MINUTA</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: ${analysis.predictions[1]?.color || '#6b7280'};">${analysis.predictions[1]?.direction || '‚ùì'}</div>
              <div style="font-size: 0.75rem; color: #cbd5e1; margin-top: 0.5rem;">Potvrda</div>
            </div>

            <!-- 60-minute -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border: 1px solid ${analysis.predictions[2]?.color || '#6b7280'}; border-radius: 0.5rem; padding: 1rem; text-align: center;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">60 MINUTA</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: ${analysis.predictions[2]?.color || '#6b7280'};">${analysis.predictions[2]?.direction || '‚ùì'}</div>
              <div style="font-size: 0.75rem; color: #cbd5e1; margin-top: 0.5rem;">SL Referenca</div>
            </div>

            <!-- Final Recommendation -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border: 2px solid ${analysis.trendColor}; border-radius: 0.5rem; padding: 1rem; text-align: center; grid-column: span 1;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">KONAƒåNA PREPORUKA</div>
              <div style="font-size: 1.2rem; font-weight: bold; color: ${analysis.trendColor};">${analysis.trendDirection}</div>
              <div style="font-size: 0.75rem; color: #10b981; margin-top: 0.5rem;">Pouzdanost: ${analysis.trendStrength}%</div>
            </div>
          </div>

          <!-- Explanation -->
          <div style="background-color: rgba(15, 23, 42, 0.4); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem;">
            <div style="font-size: 0.875rem; color: #cbd5e1; line-height: 1.6;">
              <div style="margin-bottom: 0.5rem;">
                <strong>‚ö° Kako ƒçitati ovu analizu:</strong>
              </div>
              <ul style="margin-left: 1rem; margin-bottom: 0;">
                <li>üî¥ <strong>5 MINUTA (PRIORITET)</strong> - Koristi ovo za ulazak! Ako je BEARISH, mo≈æe biti SHORT signal.</li>
                <li><strong>15 MINUTA (Potvrda)</strong> - Trebala bi da bude ista kao 5m za jaƒçi signal.</li>
                <li><strong>60 MINUTA (SL Referenca)</strong> - Koristi za postavljanje stop-loss-a, ne za ulazak.</li>
                <li>‚úÖ <strong>KONAƒåNA PREPORUKA</strong> - Kombinovani rezultat svih horizonata.</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Prediction Section -->
        <div style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%); border: 1px solid #4b5563; border-radius: 0.75rem; padding: 1.5rem;">
          <div style="font-size: 1.1rem; font-weight: bold; color: #f1f5f9; margin-bottom: 1rem;">üîÆ Detaljne Predikcije</div>
          <div style="space: 1rem;">
            ${analysis.predictions.map(pred => `
              <div style="margin-bottom: 1rem; padding: 1rem; background-color: rgba(15, 23, 42, 0.6); border-left: 3px solid ${pred.color}; border-radius: 0.25rem;">
                <div style="font-weight: bold; color: #f1f5f9;">${pred.timeframe}</div>
                <div style="color: ${pred.color}; font-weight: bold; font-size: 1.1rem; margin-top: 0.25rem;">${pred.direction}</div>
                <div style="color: #cbd5e1; font-size: 0.875rem; margin-top: 0.5rem;">${pred.description}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Volatility & Risk Assessment -->
        <div style="background-color: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 0.75rem; padding: 1.5rem;">
          <div style="font-size: 1rem; font-weight: bold; color: #f1f5f9; margin-bottom: 1rem;">‚ö†Ô∏è Rizik & Volatilnost</div>
          <div style="display: grid; gap: 0.75rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #cbd5e1;">ATR (Average True Range):</span>
              <span style="color: #10b981; font-weight: bold;">$${analysis.atr.toFixed(8)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #cbd5e1;">Momentum:</span>
              <span style="color: ${analysis.momentum > 0 ? '#10b981' : '#ef4444'}; font-weight: bold;">${analysis.momentum > 0 ? 'üìà' : 'üìâ'} ${Math.abs(analysis.momentum).toFixed(4)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #cbd5e1;">Volatilnost Ocjena:</span>
              <span style="color: ${analysis.volatilityLevel === 'Visoka' ? '#ef4444' : analysis.volatilityLevel === 'Srednja' ? '#f59e0b' : '#10b981'}; font-weight: bold;">${analysis.volatilityLevel}</span>
            </div>
          </div>
        </div>

        <!-- Live Price Comparison Section -->
        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 2px solid #06b6d4; border-radius: 0.75rem; padding: 1.5rem;">
          <div style="font-size: 1.1rem; font-weight: bold; color: #f1f5f9; margin-bottom: 1rem;">üìà Live Cijena vs Entry (Real-time Comparison)</div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <!-- Trenutna (Live) Cijena -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border: 2px solid #06b6d4; border-radius: 0.5rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">üìä Trenutna Cijena (LIVE)</div>
              <div data-dynamic="current-price" style="font-size: 1.5rem; font-weight: bold; color: #06b6d4; font-family: monospace;">$${analysis.currentPrice}</div>
              <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">Osvje≈æava se svako 500ms</div>
            </div>

            <!-- ENTRY Cijena (Dynamic) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border: 2px solid #0ea5e9; border-radius: 0.5rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">üéØ ENTRY Cijena (DYNAMIC)</div>
              <div data-dynamic="entry" style="font-size: 1.5rem; font-weight: bold; color: #0ea5e9; font-family: monospace;">$${analysis.entry}</div>
              <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">Mijenja se sa trend–æ–º</div>
            </div>

            <!-- Razlika (Difference) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border: 2px solid #f59e0b; border-radius: 0.5rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">üìä Razlika (Live - Entry)</div>
              <div data-dynamic="price-difference" style="font-size: 1.1rem; font-weight: bold; color: #f59e0b; font-family: monospace;">+$0.00000000</div>
              <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">Ako je + trebam PULLBACK</div>
            </div>
          </div>

          <!-- Explanation -->
          <div style="background-color: rgba(15, 23, 42, 0.4); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem;">
            <div style="font-size: 0.875rem; color: #cbd5e1; line-height: 1.6;">
              <strong>‚ö° Kako koristiti:</strong><br>
              Ako je razlika <strong>NEGATIVNA</strong> (-$0.10): Cijena je ispod ENTRY = <span style="color: #10b981;">‚úÖ ULAZAK SADA!</span><br>
              Ako je razlika <strong>POZITIVNA</strong> (+$0.10): Cijena je gore od ENTRY = <span style="color: #ef4444;">‚è≥ ƒåEKAJ PULLBACK</span><br>
              Prati razliku - trebam da vidim kako se mijenja!
            </div>
          </div>
        </div>

        <!-- Order Book Wall Analysis Section -->
        <div style="background: linear-gradient(135deg, #2d1b69 0%, #1a0f3a 100%); border: 2px solid #a855f7; border-radius: 0.75rem; padding: 1.5rem;">
          <div style="font-size: 1.1rem; font-weight: bold; color: #f1f5f9; margin-bottom: 1rem;">üß± Order Book Wall Analysis</div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <!-- Wall Status -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border: 2px solid #a855f7; border-radius: 0.5rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">üìä Wall Status</div>
              <div data-dynamic="wall-status" style="font-size: 1.25rem; font-weight: bold; color: #a855f7; font-family: monospace;">NO DATA</div>
              <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">STRONG | ABSORBING | BROKEN</div>
            </div>

            <!-- Buy Wall Status -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border: 2px solid #10b981; border-radius: 0.5rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">üí∞ Buy Wall (Support)</div>
              <div data-dynamic="buy-wall-status" style="font-size: 1.1rem; font-weight: bold; color: #10b981; font-family: monospace;">-</div>
              <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">Podr≈°ka na ni≈æoj cijeni</div>
            </div>

            <!-- Sell Wall Status -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border: 2px solid #ef4444; border-radius: 0.5rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">üìà Sell Wall (Resistance)</div>
              <div data-dynamic="sell-wall-status" style="font-size: 1.1rem; font-weight: bold; color: #ef4444; font-family: monospace;">-</div>
              <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">Otpor na vi≈°oj cijeni</div>
            </div>

            <!-- Wall Confidence Score -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border: 2px solid #fbbf24; border-radius: 0.5rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">‚ö° Wall Confidence</div>
              <div data-dynamic="wall-confidence" style="font-size: 1.5rem; font-weight: bold; color: #fbbf24; font-family: monospace;">0%</div>
              <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">Jaƒçina signala iz wall-ova</div>
            </div>
          </div>

          <!-- Wall Interpretation Guide -->
          <div style="background-color: rgba(15, 23, 42, 0.4); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem;">
            <div style="font-size: 0.875rem; color: #cbd5e1; line-height: 1.6;">
              <strong>üéØ Kako ƒçitati wall-ove:</strong><br>
              <strong>STRONG:</strong> Wall je ƒçvrst - cijena ƒáe se odbiti od njega<br>
              <strong>ABSORBING:</strong> Veliki volume prolazi kroz wall - signal jaƒçine trenda<br>
              <strong>BROKEN:</strong> Wall je slomljen - trend ƒáe nastaviti - üöÄ ULAZAK<br>
              <strong>BUY WALL (Support):</strong> Veliki buy orderi dolje - podr≈°ka trenda<br>
              <strong>SELL WALL (Resistance):</strong> Veliki sell orderi gore - otpor trenda
            </div>
          </div>
        </div>

        <!-- Trading Recommendation Section -->
        <div style="background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%); border: 2px solid ${analysis.tradeType === 'LONG üî∫' ? '#10b981' : analysis.tradeType === 'SHORT üîª' ? '#ef4444' : '#f59e0b'}; border-radius: 0.75rem; padding: 1.5rem;">
          <div style="font-size: 1.25rem; font-weight: bold; color: #f1f5f9; margin-bottom: 1rem;">üí∞ Preporuka za Trgovanje</div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <!-- Trade Type -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border-left: 4px solid ${analysis.tradeType === 'LONG üî∫' ? '#10b981' : analysis.tradeType === 'SHORT üîª' ? '#ef4444' : '#f59e0b'}; border-radius: 0.25rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Tip Trgovanja</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: ${analysis.tradeType === 'LONG üî∫' ? '#10b981' : analysis.tradeType === 'SHORT üîª' ? '#ef4444' : '#f59e0b'};">${analysis.tradeType}</div>
            </div>

            <!-- Live Cijena (Real-time) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border-left: 4px solid #06b6d4; border-radius: 0.25rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">üí∞ Live Cijena (SADA)</div>
              <div data-dynamic="current-price-trading" style="font-size: 1.25rem; font-weight: bold; color: #06b6d4; font-family: monospace;">$${analysis.currentPrice}</div>
              <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">Osvje≈æava se svako 500ms</div>
            </div>

            <!-- Entry Status (Dynamic) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border-left: 4px solid #fbbf24; border-radius: 0.25rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Status Ulaska</div>
              <div data-dynamic="status" style="font-size: 0.9rem; font-weight: bold; color: #fbbf24; font-family: monospace;">‚è≥ Osvje≈æavanje...</div>
            </div>

            <!-- Entry Price (Dynamic) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border-left: 4px solid #0ea5e9; border-radius: 0.25rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">ENTRY Cijena</div>
              <div data-dynamic="entry" style="font-size: 1.25rem; font-weight: bold; color: #0ea5e9; font-family: monospace;">$${analysis.entry}</div>
            </div>

            <!-- Take Profit (Dynamic) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border-left: 4px solid #10b981; border-radius: 0.25rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Take Profit (TP)</div>
              <div data-dynamic="tp" style="font-size: 1.25rem; font-weight: bold; color: #10b981; font-family: monospace;">$${analysis.tp}</div>
            </div>

            <!-- Stop Loss (Dynamic) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border-left: 4px solid #ef4444; border-radius: 0.25rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Stop Loss (SL)</div>
              <div data-dynamic="sl" style="font-size: 1.25rem; font-weight: bold; color: #ef4444; font-family: monospace;">$${analysis.sl}</div>
            </div>

            <!-- Profit Potential (Dynamic) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border-left: 4px solid #f59e0b; border-radius: 0.25rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Potencijalni Profit</div>
              <div data-dynamic="profit" style="font-size: 1.25rem; font-weight: bold; color: #f59e0b; font-family: monospace;">$${analysis.profitPotential}</div>
            </div>

            <!-- Profit Percentage (Dynamic) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border-left: 4px solid #06b6d4; border-radius: 0.25rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">ROI %</div>
              <div data-dynamic="roi" style="font-size: 1.25rem; font-weight: bold; color: #06b6d4; font-family: monospace;">${analysis.profitPercent}%</div>
            </div>

            <!-- Risk/Reward Ratio (Dynamic) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border-left: 4px solid #f59e0b; border-radius: 0.25rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">üìä Risk/Reward Ratio</div>
              <div data-dynamic="rr-ratio" style="font-size: 1.25rem; font-weight: bold; color: #f59e0b; font-family: monospace;">--</div>
              <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">Profit vs Loss odnos</div>
            </div>

            <!-- Win Rate Probability (Dynamic) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border-left: 4px solid #8b5cf6; border-radius: 0.25rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">üé≤ Win Rate ≈†ansa</div>
              <div data-dynamic="win-rate" style="font-size: 1.25rem; font-weight: bold; color: #8b5cf6; font-family: monospace;">--</div>
              <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">Osnovna na svim faktorima</div>
            </div>

            <!-- Expected Value (Dynamic) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border-left: 4px solid #ec4899; border-radius: 0.25rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">üìä Expected Value</div>
              <div data-dynamic="expected-value" style="font-size: 1.25rem; font-weight: bold; color: #ec4899; font-family: monospace;">--</div>
              <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">Proseƒçna oƒçekivana vrijednost</div>
            </div>

            <!-- Risk Level (Dynamic) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border-left: 4px solid #06b6d4; border-radius: 0.25rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">‚ö†Ô∏è Risk Level</div>
              <div data-dynamic="risk-level" style="font-size: 1.1rem; font-weight: bold; color: #06b6d4; font-family: monospace;">--</div>
              <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">Procjena rizika</div>
            </div>

            <!-- Position Sizing (Dynamic) -->
            <div style="background-color: rgba(15, 23, 42, 0.6); border-left: 4px solid #10b981; border-radius: 0.25rem; padding: 1rem;">
              <div style="font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">üí∞ Pozicija Veliƒçina</div>
              <div data-dynamic="position-size" style="font-size: 1.1rem; font-weight: bold; color: #10b981; font-family: monospace;">$54 (18√ó3x)</div>
              <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">$18 margin √ó 3x leverage</div>
            </div>
          </div>

          <!-- Win Rate Breakdown (Dynamic) -->
          <div data-dynamic="win-rate-breakdown" style="background-color: rgba(139, 92, 246, 0.1); border: 1px solid #8b5cf6; border-radius: 0.5rem; padding: 1rem; margin-top: 1.5rem; display: none;">
            <div style="font-size: 0.875rem; color: #cbd5e1; line-height: 1.6;">
              <strong>üìä Kako se Win Rate Raƒçuna:</strong><br>
              <div style="margin-top: 0.75rem; font-size: 0.8rem;">
                <div data-breakdown-item="rr-ratio" style="margin-bottom: 0.5rem; padding: 0.5rem; background-color: rgba(15, 23, 42, 0.6); border-radius: 0.25rem; border-left: 3px solid #f59e0b;">üìä <strong>Risk/Reward Ratio:</strong> --</div>
                <div data-breakdown-item="entry-position" style="margin-bottom: 0.5rem;">Entry Position: --</div>
                <div data-breakdown-item="trend-strength" style="margin-bottom: 0.5rem;">Trend Strength: --</div>
                <div data-breakdown-item="imbalance" style="margin-bottom: 0.5rem;">Imbalance Alignment: --</div>
                <div data-breakdown-item="volatility" style="margin-bottom: 0.5rem;">Volatility: --</div>
                <div data-breakdown-item="momentum" style="margin-bottom: 0.5rem;">Momentum: --</div>
                <div data-breakdown-item="wall-status" style="margin-bottom: 0;">Wall Status: --</div>
              </div>
            </div>
          </div>

          <!-- Position Sizing Calculator (Dynamic) -->
          <div data-dynamic="position-calculator" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%); border: 2px solid #10b981; border-radius: 0.5rem; padding: 1rem; margin-top: 1.5rem;">
            <div style="font-size: 0.95rem; color: #f1f5f9; font-weight: bold; margin-bottom: 1rem;">üí∞ Koliko % Trebam Pomaknuti Cijenu za Profit?</div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
              <!-- For $1 profit -->
              <div style="background-color: rgba(15, 23, 42, 0.8); border: 1px solid #10b981; border-radius: 0.5rem; padding: 1rem; text-align: center;">
                <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">Za <strong>$1</strong> Profit</div>
                <div data-calc="profit-1" style="font-size: 1.5rem; font-weight: bold; color: #10b981; font-family: monospace;">--</div>
                <div style="font-size: 0.7rem; color: #cbd5e1; margin-top: 0.5rem;">% Cijena Gore (LONG) / Dolje (SHORT)</div>
              </div>

              <!-- For $5 profit -->
              <div style="background-color: rgba(15, 23, 42, 0.8); border: 1px solid #06b6d4; border-radius: 0.5rem; padding: 1rem; text-align: center;">
                <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">Za <strong>$5</strong> Profit</div>
                <div data-calc="profit-5" style="font-size: 1.5rem; font-weight: bold; color: #06b6d4; font-family: monospace;">--</div>
                <div style="font-size: 0.7rem; color: #cbd5e1; margin-top: 0.5rem;">% Cijena Gore (LONG) / Dolje (SHORT)</div>
              </div>

              <!-- For $10 profit -->
              <div style="background-color: rgba(15, 23, 42, 0.8); border: 1px solid #f59e0b; border-radius: 0.5rem; padding: 1rem; text-align: center;">
                <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">Za <strong>$10</strong> Profit</div>
                <div data-calc="profit-10" style="font-size: 1.5rem; font-weight: bold; color: #f59e0b; font-family: monospace;">--</div>
                <div style="font-size: 0.7rem; color: #cbd5e1; margin-top: 0.5rem;">% Cijena Gore (LONG) / Dolje (SHORT)</div>
              </div>

              <!-- For full TP -->
              <div style="background-color: rgba(15, 23, 42, 0.8); border: 1px solid #8b5cf6; border-radius: 0.5rem; padding: 1rem; text-align: center;">
                <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">Za <strong>TP</strong> Profit</div>
                <div data-calc="profit-tp" style="font-size: 1.5rem; font-weight: bold; color: #8b5cf6; font-family: monospace;">--</div>
                <div style="font-size: 0.7rem; color: #cbd5e1; margin-top: 0.5rem;">% Cijena do Take Profit-a</div>
              </div>
            </div>

            <div style="background-color: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 0.5rem; padding: 0.75rem; margin-top: 1rem; font-size: 0.8rem; color: #cbd5e1;">
              <strong>üìù Kako ƒçitati:</strong> Ako vidi≈° <strong>+0.18%</strong> - trebam da cijena poraste za samo 0.18% (LONG) ili padne za 0.18% (SHORT) da bih zaradio $1. ≈†to je manji %, to je lak≈°i target! üéØ
            </div>
          </div>

          <!-- Trading Strategy Explanation -->
          <div style="background-color: rgba(15, 23, 42, 0.4); border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem;">
            <div style="font-size: 0.875rem; color: #cbd5e1; line-height: 1.6;">
              <div style="margin-bottom: 0.75rem;">
                <strong>üìå Strategija:</strong><br>
                ${analysis.tradeType === 'SHORT üîª' ?
                  `Prodaj na ENTRY cijeni ($${analysis.entry}). Oƒçekuje se pad prema support-u ($${analysis.tp}). Ako cijena ide prema resistance-u ($${analysis.sl}), izaƒëi sa gubitkom.` :
                analysis.tradeType === 'LONG üî∫' ?
                  `Kupi na ENTRY cijeni ($${analysis.entry}). Oƒçekuje se rast prema resistance-u ($${analysis.tp}). Ako cijena pada prema support-u ($${analysis.sl}), izaƒëi sa gubitkom.` :
                  `Trend nije jasan. ƒåekaj breakout-a prije nego ≈°to uƒëe≈°. ƒåini se da je trend izmeƒëu support ($${analysis.sl}) i resistance ($${analysis.tp}).`
                }
              </div>
              <div style="margin-bottom: 0.75rem;">
                <strong>‚è±Ô∏è Timing:</strong> Narednih 15 minuta su kritiƒçni - cijena bi trebala da ide u smjeru ${analysis.trendDirection}
              </div>
              <div>
                <strong>‚ö†Ô∏è Risk Management:</strong> Ulazi sa pozicijom gde je R:R (Risk to Reward) minimalno 1:1, idealno 1:2
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    document.getElementById('modal-candles').innerHTML = analysisHTML;

  } catch (error) {
    console.error('Error loading candle data:', error);
    document.getElementById('modal-candles').innerHTML = `
      <div class="text-center py-8 text-red-400">
        ‚ùå Gre≈°ka pri uƒçitavanju candle podataka
      </div>
    `;
  }
}

function analyzeCandlesTrend(candles) {
  if (!candles || candles.length === 0) {
    return {
      trendDirection: 'N/A',
      trendEmoji: '‚ùì',
      trendColor: '#6b7280',
      trendStrength: 0,
      trendDescription: 'Nema podataka za analizu'
    };
  }

  // Multi-timeframe analysis
  const calculateTrendForPeriod = (period) => {
    if (candles.length < period) return null;
    const slice = candles.slice(-period);
    const startPrice = slice[0].open;
    const endPrice = slice[slice.length - 1].close;
    const change = ((endPrice - startPrice) / startPrice) * 100;
    return {
      change,
      direction: change > 0.05 ? 'BULLISH' : change < -0.05 ? 'BEARISH' : 'FLAT',
      strength: Math.abs(change)
    };
  };

  // Calculate trends for multiple timeframes
  const trend5m = calculateTrendForPeriod(5);
  const trend15m = calculateTrendForPeriod(15);
  const trend30m = calculateTrendForPeriod(30);
  const trend60m = calculateTrendForPeriod(60);
  const trend360m = calculateTrendForPeriod(360); // Full 6 hours

  console.log('üìä Multi-timeframe analysis:');
  console.log(`   5m: ${trend5m?.direction} (${trend5m?.change.toFixed(3)}%)`);
  console.log(`   15m: ${trend15m?.direction} (${trend15m?.change.toFixed(3)}%)`);
  console.log(`   30m: ${trend30m?.direction} (${trend30m?.change.toFixed(3)}%)`);
  console.log(`   60m: ${trend60m?.direction} (${trend60m?.change.toFixed(3)}%)`);
  console.log(`   360m: ${trend360m?.direction} (${trend360m?.change.toFixed(3)}%)`);

  // Vote-based trend determination
  let bullishVotes = 0;
  let bearishVotes = 0;
  const trendWeights = [
    { trend: trend5m, weight: 3 },  // 5m je 3x va≈ænije (najsve≈æije)
    { trend: trend15m, weight: 2.5 },
    { trend: trend30m, weight: 2 },
    { trend: trend60m, weight: 1.5 },
    { trend: trend360m, weight: 1 }  // 6h je najmanje va≈æno
  ];

  trendWeights.forEach(({ trend, weight }) => {
    if (trend) {
      if (trend.direction === 'BULLISH') bullishVotes += weight;
      else if (trend.direction === 'BEARISH') bearishVotes += weight;
    }
  });

  // Determine final trend
  let finalTrendDirection, finalEmoji, finalColor, confidence;
  const voteDifference = Math.abs(bullishVotes - bearishVotes);
  confidence = Math.min((voteDifference / (bullishVotes + bearishVotes)) * 100, 100);

  if (bullishVotes > bearishVotes) {
    finalTrendDirection = 'BULLISH ‚¨ÜÔ∏è';
    finalEmoji = 'üöÄ';
    finalColor = '#10b981';
  } else if (bearishVotes > bullishVotes) {
    finalTrendDirection = 'BEARISH ‚¨áÔ∏è';
    finalEmoji = 'üìâ';
    finalColor = '#ef4444';
  } else {
    finalTrendDirection = 'NEUTRALNO ‚û°Ô∏è';
    finalEmoji = '‚è∏Ô∏è';
    finalColor = '#f59e0b';
  }

  // Standard calculations for other metrics
  const recent = candles.slice(-60);
  const currentPrice = recent[recent.length - 1]?.close || 0;
  const openPrice = candles[0]?.open || currentPrice;
  const highestPrice = Math.max(...candles.map(c => c.high));
  const lowestPrice = Math.min(...candles.map(c => c.low));

  const sixHourChange = ((currentPrice - openPrice) / openPrice) * 100;

  // Support & Resistance
  const support = lowestPrice;
  const resistance = highestPrice;

  // ATR (Average True Range)
  let trueRanges = [];
  for (let i = 1; i < candles.length; i++) {
    const tr = Math.max(
      candles[i].high - candles[i].low,
      Math.abs(candles[i].high - candles[i - 1].close),
      Math.abs(candles[i].low - candles[i - 1].close)
    );
    trueRanges.push(tr);
  }
  const atr = trueRanges.slice(-14).reduce((a, b) => a + b, 0) / Math.min(14, trueRanges.length);

  // Momentum from current timeframe
  const momentum = ((recent[recent.length - 1]?.close - recent[0]?.open) / recent[0]?.open) * 100;

  // Volatilnost
  const closes = recent.map(c => c.close);
  const avg = closes.reduce((a, b) => a + b) / closes.length;
  const variance = closes.reduce((sum, c) => sum + Math.pow(c - avg, 2), 0) / closes.length;
  const stdDev = Math.sqrt(variance);
  const volatilityPercent = (stdDev / avg) * 100;
  const volatilityLevel = volatilityPercent > 0.2 ? 'Visoka' : volatilityPercent > 0.1 ? 'Srednja' : 'Niska';

  // Intelligent predictions based on multi-timeframe analysis
  const predictions = [
    {
      timeframe: '5 minuta (Immediate)',
      direction: trend5m?.direction === 'BULLISH' ? 'üìà BULLISH' : trend5m?.direction === 'BEARISH' ? 'üìâ BEARISH' : '‚û°Ô∏è FLAT',
      color: trend5m?.direction === 'BULLISH' ? '#10b981' : trend5m?.direction === 'BEARISH' ? '#ef4444' : '#f59e0b',
      description: trend5m ? `Trenutni momentum je ${trend5m.direction.toLowerCase()} (${trend5m.change.toFixed(3)}%). PRIORITET - koristi ovo za ulazak!` : 'Nema podataka'
    },
    {
      timeframe: '15 minuta (Short-term)',
      direction: trend15m?.direction === 'BULLISH' ? 'üìà BULLISH' : trend15m?.direction === 'BEARISH' ? 'üìâ BEARISH' : '‚û°Ô∏è FLAT',
      color: trend15m?.direction === 'BULLISH' ? '#10b981' : trend15m?.direction === 'BEARISH' ? '#ef4444' : '#f59e0b',
      description: trend15m ? `15-minute trend je ${trend15m.direction.toLowerCase()} (${trend15m.change.toFixed(3)}%). Potvrdi sa 5m prije ulaska.` : 'Nema podataka'
    },
    {
      timeframe: '60 minuta (Medium-term)',
      direction: trend60m?.direction === 'BULLISH' ? 'üìà BULLISH' : trend60m?.direction === 'BEARISH' ? 'üìâ BEARISH' : '‚û°Ô∏è FLAT',
      color: trend60m?.direction === 'BULLISH' ? '#10b981' : trend60m?.direction === 'BEARISH' ? '#ef4444' : '#f59e0b',
      description: trend60m ? `Satni trend je ${trend60m.direction.toLowerCase()} (${trend60m.change.toFixed(3)}%). Koristi za SL pozicije.` : 'Nema podataka'
    },
    {
      timeframe: 'üéØ Konaƒçna Preporuka',
      direction: finalTrendDirection,
      color: finalColor,
      description: `Pouzdanost: ${confidence.toFixed(0)}% | Svi vremenski horizont se sla≈æu da je trend ${finalTrendDirection}. Treba≈° ulaziti u smjeru ${finalTrendDirection} sa striktnim stop-loss-om!`
    }
  ];

  // Calculate trading recommendation
  const trendIsBullish = finalTrendDirection === 'BULLISH ‚¨ÜÔ∏è';
  const trendIsBearish = finalTrendDirection === 'BEARISH ‚¨áÔ∏è';

  let entry, tp, sl, profitPotential, tradeType, profitPercent;

  if (trendIsBearish) {
    // SHORT trade
    tradeType = 'SHORT üîª';
    entry = currentPrice - (atr * 0.5); // Enter below current price
    tp = support; // Take profit at support
    sl = resistance; // Stop loss at resistance
    profitPotential = entry - tp;
    profitPercent = ((profitPotential / entry) * 100).toFixed(2);
  } else if (trendIsBullish) {
    // LONG trade
    tradeType = 'LONG üî∫';
    entry = currentPrice + (atr * 0.5); // Enter above current price
    tp = resistance; // Take profit at resistance
    sl = support; // Stop loss at support
    profitPotential = tp - entry;
    profitPercent = ((profitPotential / entry) * 100).toFixed(2);
  } else {
    // NEUTRAL - wait for breakout
    tradeType = 'ƒåEKAJ ‚û°Ô∏è';
    entry = currentPrice;
    tp = resistance;
    sl = support;
    profitPotential = 0;
    profitPercent = 0;
  }

  return {
    trendDirection: finalTrendDirection,
    trendEmoji: finalEmoji,
    trendColor: finalColor,
    trendStrength: Math.round(confidence),
    trendDescription: `Inteligentna predikcija je ${finalTrendDirection} sa pouzdano≈°ƒáu od ${confidence.toFixed(0)}%. Ovo je bazirana na analizi 5m, 15m, 30m, 60m i 360m vremenskih horizonta. Trenutni 5m trend je KRITIƒåAN - to je tvoj ulazak!`,
    currentPrice: currentPrice.toFixed(8),
    sixHourChange,
    support,
    resistance,
    atr,
    momentum,
    volatilityLevel,
    predictions,
    // Trading recommendation
    entry: entry.toFixed(8),
    tp: tp.toFixed(8),
    sl: sl.toFixed(8),
    tradeType,
    profitPotential: profitPotential.toFixed(8),
    profitPercent
  };
}

function loadQualityAssessment(signal) {
  const checks = [
    {
      name: 'Volatilnost',
      check: signal.volatility >= 0.15,
      value: `${fmt(signal.volatility)}%`,
      threshold: '>= 0.15%'
    },
    {
      name: 'Volume Spike',
      check: signal.volumeSpike >= 1.5,
      value: `${fmt(signal.volumeSpike)}x`,
      threshold: '>= 1.5x'
    },
    {
      name: 'Velocity',
      check: signal.velocity >= 0.05,
      value: `${fmt(signal.velocity)}%`,
      threshold: '>= 0.05%'
    },
    {
      name: 'Momentum',
      check: signal.momentum >= 0.1,
      value: `${fmt(signal.momentum)}%`,
      threshold: '>= 0.1%'
    },
    {
      name: signal.side === 'LONG' ? 'Imbalance (LONG)' : 'Imbalance (SHORT)',
      check: signal.side === 'LONG' ? signal.imbalance >= 1.05 : signal.imbalance <= 0.95,
      value: fmt(signal.imbalance),
      threshold: signal.side === 'LONG' ? '>= 1.05' : '<= 0.95'
    },
    {
      name: 'Spread',
      check: signal.spread <= 0.1,
      value: `${fmt(signal.spread)}%`,
      threshold: '<= 0.1%'
    }
  ];

  const assessment = checks.map(check => {
    const icon = check.check ? '‚úÖ' : '‚ùå';
    const color = check.check ? 'text-emerald-300' : 'text-red-300';
    return `
      <div class="flex items-center justify-between py-2 px-3 bg-slate-700/20 rounded">
        <div class="flex items-center gap-2">
          <span class="${color}">${icon}</span>
          <span class="text-sm font-semibold text-slate-200">${check.name}</span>
        </div>
        <div class="text-right">
          <div class="text-sm text-slate-100 font-mono">${check.value}</div>
          <div class="text-xs text-slate-400">${check.threshold}</div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('modal-quality-assessment').innerHTML = assessment;
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  fetchScannerData();
  fetchExecutionStats();

  // Auto-refresh every 10 seconds
  setInterval(() => {
    fetchScannerData();
    fetchExecutionStats();
  }, 10000);
});
</script>

<!-- Signal Details Modal -->
<div id="signal-modal" class="modal" style="display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); z-index: 9999; backdrop-filter: blur(4px); align-items: center; justify-content: center;" onclick="if(event.target === this) closeSignalModal()">
  <div class="modal-content" style="background-color: #0f172a; border: 1px solid #334155; border-radius: 0.5rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); max-width: 56rem; width: 90%; max-height: 90vh; overflow-y: auto;">
    <div class="modal-header" style="position: sticky; top: 0; background: linear-gradient(to right, #1e293b, #0ea5e9); border-bottom: 1px solid #334155; padding: 1.5rem; display: flex; align-items: center; justify-content: space-between;">
      <div>
        <h2 class="text-2xl font-bold text-slate-100" id="modal-symbol">BTCUSDT</h2>
        <p class="text-sm text-slate-400 mt-1" id="modal-timestamp">Timestamp</p>
      </div>
      <button onclick="closeSignalModal()" style="color: #94a3b8; cursor: pointer; font-size: 2rem; background: none; border: none; padding: 0; hover-color: #f1f5f9;" onmouseover="this.style.color='#f1f5f9'" onmouseout="this.style.color='#94a3b8'">&times;</button>
    </div>

    <div class="modal-body" style="padding: 1.5rem;">
      <!-- Live Market Data Section -->
      <div class="modal-section">
        <h3>üí± Live Tr≈æi≈°ni Podaci</h3>
        <div id="modal-market-data" style="background-color: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 0.75rem; padding: 1.5rem;">
          <div class="text-center py-8 text-slate-500">
            ‚è≥ Uƒçitavanje tr≈æi≈°nih podataka...
          </div>
        </div>
      </div>

      <!-- Trend Analysis Section (Last 6 Hours) -->
      <div class="modal-section">
        <h3>üìä Analiza Trenda & Predikcija (Zadnjih 6 Sati)</h3>
        <div class="candle-chart" id="modal-candles" style="background-color: rgba(15, 23, 42, 0.8); border: 1px solid #334155;">
          <div class="text-center py-8 text-slate-500">
            ‚è≥ Analiza candle podataka...
          </div>
        </div>
      </div>

      <!-- Quality Assessment -->
      <div class="modal-section">
        <h3>‚úÖ Procjena Kvalitete</h3>
        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
          <div id="modal-quality-assessment" class="space-y-2">
            <div class="text-sm text-slate-300">Uƒçitavanje procjene...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
