## âœ… FAZA 13 â€” BACKTEST & STRATEGY SANDBOX

### **FINAL SPEC (ULTRA-DETALJNO, PRODUKCIJSKI, ISTI FORMAT KAO FAZE 7â€“12)**

*(Ovo je gotova, kompletna, profesionalna dokumentacija za implementaciju Faze 13.)*

---

# **PHASE 13 â€“ BACKTEST ENGINE & STRATEGY SANDBOX**

### *OFFLINE TESTIRANJE, PARAMETAR-SWEEP, REPORTING, ANALITIKA*

---

# **0. PREGLED â€” Å TA JE CILJ FAZE 13**

Phase 13 nadograÄ‘uje Replay Engine (Phase 12) i uvodi **najmoÄ‡niji modul tvog celog ekosistema**:

# **BACKTEST ENGINE**

koji omoguÄ‡ava:

### âœ… PuÅ¡tanje istorije kroz Äitav AI Scalper pipeline kao da je LIVE

### âœ… Izmenu parametara (risk, scoring, TP/SL, regimeâ€¦) bez rizika

### âœ… PoreÄ‘enje raznih strategijskih varijanti

### âœ… Generisanje jasnih reporta (winrate, expectancy, drawdownâ€¦)

### âœ… Snimanje kompletnog seta rezultata u svoj folder

### âœ… Brzo iteriranje strategija (jedan replay session â†’ 5, 20, 50 razliÄitih strategija)

### âœ… Dashboard UI za pokretanje i pregled backtestova

**FAZA 13 pretvara ceo tvoj sistem u laboratoriju za AI i kvantno istraÅ¾ivanje.**

---

# **1. FAJLOVI KOJE FAZA 13 UVODI**

## **1.1 Novi moduli**

```
src/backtest/backtestEngine.js
src/backtest/sandboxRunner.js
src/backtest/reportBuilder.js
src/backtest/strategyConfig.js
```

## **1.2 Novi web API**

```
web/routes/api-backtest.js
```

## **1.3 Novi dashboard JS**

```
web/public/js/dashboard-backtest.js
```

## **1.4 Novi data folderi**

```
data/backtests/
  runs/
    <runId>/
      config.json
      manifest.json
      report.json
      trades.jsonl
      equity_curve.json
```

---

# **2. Å TA JE BACKTEST RUN**

Jedna izvrÅ¡ena simulacija izgleda ovako:

1. Uzima istorijske ReplayEvents iz Phase 12.
2. PokreÄ‡e engine u *SIM_BACKTEST* reÅ¾imu.
3. Modul scoring/regime/state/risk/tpsl/execution radi 1:1 kao LIVE.
4. Logger NE upisuje globalne fajlove, veÄ‡ lokalne u folder run-a.
5. Na kraju se generiÅ¡e kompletan **BacktestReport**.

Backtest Run =
**Replay Session + StrategyConfig + Engine â†’ Rezultati (report).**

---

# **3. STRATEGY CONFIG â€” src/backtest/strategyConfig.js**

Ovo je *srce* sandbox-a.

Sve override vrednosti **optional**, sve brojÄane, sve prave razliku izmeÄ‘u dve strategije.

## **Structure**

```
StrategyConfig {
  name: string,
  description: string,

  riskOverrides?: {
    maxRiskPerTradePct?: number,
    maxPortfolioHeatPct?: number,
    maxDailyLossPct?: number,
    maxOpenPositions?: number,
    maxOpenPositionsPerSymbol?: number
  },

  scoringOverrides?: {
    watchThresholdLong?: number,
    watchThresholdShort?: number,
    armThresholdLong?: number,
    armThresholdShort?: number,
    minScoreToTrade?: number
  },

  tpslOverrides?: {
    tp1Factor?: number,
    tp2Factor?: number,
    breakEvenBufferPct?: number,
    trailingActivationPct?: number,
    trailingDistancePct?: number
  },

  regimeOverrides?: {
    allowNewEntriesInPump?: boolean,
    allowCountertrendInBlowoff?: boolean,
    riskMultiplierInNewsDriven?: number
  },

  executionOverrides?: {
    maxSlippagePct?: number,
    maxSpreadPct?: number,
    minNotionalUsd?: number,
    maxNotionalUsd?: number
  },

  tags?: string[]
}
```

U svakom run-u, ove vrednosti *override-uju* standardni CONFIG.

---

# **4. BACKTEST ENGINE â€” src/backtest/backtestEngine.js**

## **4.1 Svrha**

* Prima ReplayEvents.
* Predaje ih u engine (feature â†’ scoring â†’ regime â†’ state â†’ TPSL â†’ execution).
* BeleÅ¾i rezultate u izolovanom BacktestContext.
* GeneriÅ¡e:

  * tradeRecords
  * orderRecords
  * equityCurve
  * backtest report

## **4.2 BacktestContext struktura**

```
BacktestContext {
  runId: string,
  strategyConfig: StrategyConfig,
  replayManifest: ReplayManifest,

  eventCount: number,
  startTimestamp: string,
  endTimestamp: string,
  currentSimTime: string,

  equityCurve: EquityPoint[],
  tradeRecords: TradeLogRecord[],
  orderRecords: OrderLogRecord[],
  metrics: BacktestMetrics
}
```

## **EquityPoint**

```
{
  timestamp: string,
  equity: number,
  openPnl: number,
  balance: number
}
```

## **4.3 API BacktestEngine**

```
init(runId, strategyConfig, replayManifest)
onReplayEvent(event)
finalize()
```

## **Kako radi `onReplayEvent(event)`**

### TIPOVI REPLAY EVENT-OVA:

```
MARKET_TRADE â†’ market feed â†’ feature engine
MARKET_BOOK â†’ orderbook â†’ feature engine
FEATURE_SNAPSHOT â†’ scoring/regime
SCORING_UPDATE â†’ stateMachine event
REGIME_UPDATE â†’ stateMachine event
RISK_UPDATE â†’ stateMachine event
EXECUTION_* â†’ stateMachine event
```

### VAÅ½NO:

U backtest modu, execution engine koristi:
**simulatedExchange â†’ orderRecords â†’ tradeRecords**, NE globalne fajlove.

---

# **5. SANDBOX RUNNER â€” src/backtest/sandboxRunner.js**

Kontrolni modul koji:

* kreira runId,
* upisuje manifest.json,
* Äuva config.json,
* startuje ReplayEngine u â€BACKTESTâ€ modu,
* prati progress (koliko eventa je obraÄ‘eno),
* zavrÅ¡ava run â†’ generiÅ¡e report.

## **5.1 BacktestManifest**

```
{
  runId: string,
  createdAt: string,
  sessionId: string,
  strategyName: string,
  strategyDescription: string,
  source: "MANUAL" | "AUTO",
  status: "PENDING" | "RUNNING" | "DONE" | "FAILED",
  eventCount: number,
  symbols: string[],
  from: string,
  to: string,
  speedFactor: number,
  notes: string | null
}
```

## **5.2 API SandboxRunner**

```
createRun(sessionId, strategyConfig, options)
startRun(runId)
getRunStatus(runId)
listRuns()
```

---

# **6. REPORT BUILDER â€” src/backtest/reportBuilder.js**

Pretvara rezultate BacktestEngine-a u finalni SQL-grade report.

## **6.1 BacktestReport format**

```
{
  runId: string,
  sessionId: string,
  strategyName: string,
  from: string,
  to: string,
  symbols: string[],

  totalNetPnl: number,
  totalNetPnlPct: number,
  avgR: number,
  expectancyR: number,
  profitFactor: number,
  maxDrawdown: number,
  maxDrawdownPct: number,

  tradesCount: number,
  winningTrades: number,
  losingTrades: number,
  winRatePct: number,
  avgWin: number,
  avgLoss: number,
  bestTradePnl: number,
  worstTradePnl: number,

  perSymbol: { symbol â†’ stats },
  perRegime: { regime â†’ stats },

  equityCurve: EquityPoint[],

  configSnapshot: StrategyConfig
}
```

Sve brojÄane vrednosti za Excel/CSV-friendly analizu.

---

# **7. API ZA BACKTEST â€“ web/routes/api-backtest.js**

## **7.1 GET /api/backtest/runs**

VraÄ‡a sve manifest-e.

## **7.2 GET /api/backtest/runs/:runId**

Manifest + (ako postoji) report.json.

## **7.3 POST /api/backtest/runs**

Startuje novi run.

## **7.4 POST /api/backtest/runs/:runId/start**

Manual start.

## **7.5 GET /api/backtest/runs/:runId/report**

Full report.

## **7.6 GET /api/backtest/runs/:runId/equity**

PnL kriva.

---

# **8. DASHBOARD â€” BACKTEST SEKCIJA**

Dodaje se novi tab:

# **â€Backtest & Sandboxâ€œ**

## **8.1 3 panela u UI-u**

### **Panel 1 â€” Izbor Replay Session-a**

* lista o prethodnih sesija iz Phase 12
* prikaz range-a & broja eventova

### **Panel 2 â€” StrategyConfig forma**

* svi override parametri iz StrategyConfig
* slideri / input;

Klik â†’ **Pokreni Backtest Run**

### **Panel 3 â€” Runs lista**

* runId
* status
* sessionId
* totalNetPnl
* winRate
* maxDrawdown
* dugme â€Openâ€

### **Detail View**

* summary (Pnl, winrateâ€¦)
* equity chart
* per-symbol breakdown
* per-regime breakdown
* TP/SL metrics
* config snapshot

---

# **9. TEST SCENARIJI (PROFESIONALNI, QA-READY)**

### **Test 1 â€“ minimalni run**

â†’ replay od 10 minuta
â†’ config bez override
â†’ proveriti trades.jsonl i report.json

### **Test 2 â€“ parametar override**

â†’ tp1Factor Ã—2
â†’ oÄekivano: manje pogodaka, veÄ‡i avg win

### **Test 3 â€“ per-symbol breakdown**

â†’ viÅ¡e simbola u session-u

### **Test 4 â€“ per-regime breakdown**

â†’ pump vs normal performance

### **Test 5 â€“ dashboard**

â†’ UI render, graf, real-time loading

### **Test 6 â€“ failure scenario**

â†’ replay session ne postoji
â†’ status = FAILED

---

# **10. FINALNI REZULTAT FAZE 13**

Nakon implementacije ove faze:

---

## ğŸ”¥ ImaÅ¡ kompletan **Backtest Framework**:

* 100% offline
* 100% deterministiÄki
* koristi ceo engine
* koristi ReplayEvents umesto Bybit feeda
* pravi kompletne rezultate

---

## ğŸ”¥ ImaÅ¡ **Strategy Sandbox**:

* menjaj TP/SL parametre
* menjaj risk parametre
* menjaj scoring parametre
* testiraj 10 strategija u istom replay-u

---

## ğŸ”¥ ImaÅ¡ **Report Builder**:

* winrate
* expectancy
* profit factor
* MFE/MAE
* break-even statistike
* per-symbol, per-regime analitika
* equity curve

---

## ğŸ”¥ ImaÅ¡ **Dashboard Backtest Panel**:

* pokreÄ‡eÅ¡ run iz browsera
* vidiÅ¡ rezultate
* grafove
* porediÅ¡ strategije

---

## ğŸ”¥ ImaÅ¡ temelj za ML i Reinforcement Learning (Phase 14)

(backtest â†’ scoring â†’ Q-learning â†’ meta-parametri).

---

Ako Å¾eliÅ¡ da odmah idem dalje:

### **FAZA 14 â€” ML LAYER (META-SCORING + PARAMETER OPTIMIZER)**

ili

### **FAZA 15 â€” REALTIME AUTO-TUNING**

samo reci **â€Kreni FAZA 14â€œ**.
