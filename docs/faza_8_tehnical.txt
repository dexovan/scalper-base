Razumem.
Sada dobija≈° **OPCIJA A ‚Äî ULTRA DETALJAN, PRODUKCIJSKI, PROGRAMERSKO-TEHNIƒåKI PLAN ZA FAZU 8**, u identiƒçnom formatu i kvalitetu kao Phase 7 dokument.

Sve je pripremljeno tako da mo≈æe≈° odmah da ga ubaci≈° u repo kao:

```
docs/spec/phase08-risk-engine.md
```

---

# **PHASE 08 ‚Äì RISK & PORTFOLIO ENGINE**

**(UNREALIZED PNL, PORTFOLIO HEAT, DAILY LOSS LIMIT, RISK SIGNALI)**
**FINAL DEV SPEC ‚Äì ULTRA DETALJNO (Opcija A)**

---

# **0. UVOD ‚Äì Uloga Faze 08 u AI Scalper Arhitekturi**

Do Faze 07 tvoj sistem je nauƒçio da:

* posmatra tr≈æi≈°te (Faza 3)
* izraƒçunava microstructure i feature-e (Faza 4)
* razume globalne i lokalne re≈æime (Faza 5)
* ocenjuje simbole i generi≈°e WATCH/ARM signale (Faza 6)
* prelazi kroz state ma≈°inu (Faza 7)

ALI ‚Äî jo≈° uvek NE zna **da li sme da trejduje**.

To je uloga Faze 08:

### RISK ENGINE JE "GLAVNI SUDIJA".

On odreƒëuje:

‚ùå kada je NOVI ENTRY zabranjen
‚ùå kada je LONG zabranjen
‚ùå kada je SHORT zabranjen
‚ùå kada si blizu daily loss limita
‚ùå kada si previ≈°e izlo≈æen (portfolio heat)
‚ùå kada mora da se aktivira "risk-off mode"

I emituje signale:

* `riskAllowNewPositions`
* `riskAllowNewLong`
* `riskAllowNewShort`
* `riskForceCloseAll` (za buduƒáu fazu Execution-a)

Ove vrednosti ulaze direktno u:

### Scoring Engine ‚Üí penalizuje ili blokira signale

### State Machine ‚Üí spreƒçava pristup WATCH/ARM state-u

### Dashboard ‚Üí prikazuje globalni rizik sistema

---

# **1. FAJLOVI KOJE FAZA 08 KREIRA**

## **1.1 Novi fajlovi**

```
src/risk/riskEngine.js
src/risk/accountState.js
src/risk/positionTracker.js
src/risk/externalAccountAdapter.js (stub)
```

## **1.2 Izmene postojeƒáih fajlova**

```
src/state/stateMachine.js     (dodaje RISK_UPDATE dogaƒëaje)
src/scoring/scoringEngine.js  (uzima RiskSnapshot umesto stuba)
src/monitoring/health.js      (prikazuje risk health)
web/routes/api.js             (dodaje risk API endpoint-e)
```

## **1.3 Novi JSON fajlovi**

```
data/system/risk_snapshot.json
data/trades_log/day-YYYY-MM-DD.json
```

---

# **2. KONFIG (CONFIG.risk)**

Dodaje se sekcija:

```js
CONFIG.risk = {
  maxRiskPerTradePct: 1.0,
  maxPortfolioHeatPct: 6.0,
  maxDailyLossPct: 5.0,
  maxOpenPositions: 5,
  maxOpenPositionsPerSymbol: 1,
  allowNewLongIfHeatBelowPct: 4.0,
  allowNewShortIfHeatBelowPct: 4.0,
  dailyResetTimeUtc: "00:00"
};
```

### Obja≈°njenje:

* **portfolioHeatPct** = koliki procenat raƒçuna je u aktivnom riziku ako SVI SL-ovi puknu odmah.
* **dailyLossLimit** = osnovni "kill switch" ‚Äì nema novih trejdova kad se probije.
* **per-side risk limit** ‚Üí spreƒçava npr. otvaranje novih long pozicija kada si veƒá prete≈æak na long strani.
* **dailyResetTimeUtc** ‚Üí reset ƒçitavog risk sistema u ponuƒëeno vreme.

---

# **3. STRUKTURA U MEMORIJI: RiskEngineState**

```
RiskEngineState {
    account: AccountState,
    positions: Map<string, PositionState>,
    dailyStats: DailyRiskStats,
    riskFlags: RiskFlags,
    lastUpdateAt: ISOString
}
```

---

# **3.1 AccountState**

```
AccountState {
  mode: "SIM" | "DRY_RUN" | "LIVE",
  equityTotal: number,
  balanceAvailable: number,
  marginUsed: number,
  openPnlUnrealized: number,
  realizedPnlTotal: number,
  lastSyncAt: string
}
```

U SIM modu ‚Äî Equity se menja samo na osnovu realizovanih + nerealizovanih profita.

U LIVE modu ‚Äî ovo dolazi iz Bybit API-ja (stub u ovoj fazi).

---

# **3.2 PositionState (per symbol + side)**

Kljuƒç u map-i:

```
BTCUSDT_LONG
ETHUSDT_SHORT
```

Objekat:

```
PositionState {
  symbol,
  side,
  leverage,
  entryPrice,
  qty,
  notionalValue,
  stopLossPrice,
  takeProfit1Price,
  takeProfit2Price,
  maxFavorableExcursion,
  maxAdverseExcursion,
  unrealizedPnl,
  unrealizedPnlPct,
  realizedPnl,
  openedAt,
  updatedAt,
  isActive
}
```

---

# **3.3 DailyRiskStats**

ƒåuva dnevne limit-e i pona≈°anje:

```
DailyRiskStats {
  dateKey: "YYYY-MM-DD",
  dayRealizedPnl,
  dayRealizedPnlPct,
  dayMaxDrawdown,
  dayMaxDrawdownPct,
  tradesCount,
  winningTradesCount,
  losingTradesCount,
  synchronizedAt
}
```

---

# **3.4 RiskFlags**

```
RiskFlags {
  portfolioHeatPct,
  projectedHeatPctIfNewTrade,
  nearDailyLossLimit,
  dailyLossLimitHit,
  riskAllowNewPositions,
  riskAllowNewLong,
  riskAllowNewShort,
  riskForceCloseAll
}
```

---

# **4. PRORAƒåUNI ‚Äì MATEMATIKA RIZIKA**

---

# **4.1 Unrealized PnL**

LONG:

```
(current - entry) * qty
```

SHORT:

```
(entry - current) * qty
```

---

# **4.2 Risk Per Trade ("R")**

```
riskPerTradeUsd = |entryPrice - stopLossPrice| * qty
```

Ako SL ne postoji ‚Üí koristi konzervativni default SL offset, npr. 1.2 √ó ATR.

---

# **4.3 Portfolio Heat**

```
portfolioHeatPct = SUM(riskPerTradeUsd) / equityTotal * 100
```

Ako heat ‚â• maxPortfolioHeatPct ‚Üí zabrani nove pozicije.

---

# **4.4 Daily Loss Limit**

```
dayRealizedPnlPct = dayRealizedPnl / equityAtDayStart * 100
```

Ako dayRealizedPnlPct ‚â§ -maxDailyLossPct:

```
riskAllowNewPositions = false
riskForceCloseAll = true
```

---

# **5. MODUL: src/risk/accountState.js**

### Funkcije:

‚úî `initAccountState(mode)`
‚úî `syncWithExternalAccount()`
‚úî `getAccountState()`
‚úî `updateOnPositionChange(positionStates)`

U SIM modu ‚Äî sve se raƒçuna lokalno kroz PositionTracker.

---

# **6. MODUL: src/risk/positionTracker.js**

Praƒáenje svih pozicija + MFE/MAE + PnL.

### Funkcije:

### **6.1 initPositionTracker()**

Prazna mapa svih pozicija.

### **6.2 onNewPositionOpened(event)**

Kreira novi PositionState ili radi pyramiding.

### **6.3 onPositionPriceUpdate(symbol, side, price)**

Raƒçuna:

* unrealized PnL
* MFE (maximum favorable excursion)
* MAE (maximum adverse excursion)

### **6.4 onPositionClosed(event)**

* a≈æurira realized PnL
* ƒçuva zapis u `data/trades_log/day-YYYY-MM-DD.json`
* postavlja `isActive=false`

---

# **7. MODUL: src/risk/riskEngine.js**

Glavni orkestrator rizika.

### Funkcije:

---

## **7.1 initRiskEngine(config, mode)**

* kreira AccountState
* kreira PositionTracker
* inicijalizuje RiskFlags
* inicijalizuje DailyStats

---

## **7.2 onPositionEvent(event)**

Na svaki OPEN/CLOSE/MODIFY pozivne:

* updates PositionTracker
* poziva recalcRiskState

---

## **7.3 onPriceTickForSymbol(symbol, price)**

A≈æurira MFE/MAE i unrealized PnL u realnom vremenu.

---

## **7.4 recalcRiskState()**

Raƒçuna:

* portfolioHeatPct
* dailyLossPct
* maxDrawdown
* riskAllowNewPositions
* riskAllowNewLong
* riskAllowNewShort

I zapisuje sve u:

```
data/system/risk_snapshot.json
```

I ≈°alje:

```
RISK_UPDATE event ‚Üí stateMachine
```

---

## **7.5 getRiskSnapshot()**

Vraƒáa sve rizike za Scoring i StateMachine.

---

## **7.6 onDailyReset()**

Resetuje dnevne statistike u odreƒëeno vreme.

---

# **8. INTEGRACIJA ‚Äì KAKO FAZA 08 UTICAJE NA SVE OSTALO**

---

# **8.1 Scoring Engine**

`applyRegimeAndRiskFilters()` sada koristi:

```
riskSnapshot.riskAllowNewPositions
riskSnapshot.riskAllowNewLong
riskSnapshot.riskAllowNewShort
```

Ako je zabrana:

```
allowed = false
finalScore = 0
blockedReasons.push("RISK_ENGINE_BLOCK")
```

---

# **8.2 State Machine**

Na `RISK_UPDATE` event:

* ako `riskAllowNewPositions = false` ‚Üí blokira WATCH/ARM
* mo≈æe prekidati aktivne scenarije (politiku ti bira≈°)
* ubacuje razlog u state-change log

---

# **8.3 Dashboard**

Dodaje se novi panel:

### **GLOBAL RISK PANEL**

* Equity
* Unrealized PnL
* Realized PnL (day + lifetime)
* Portfolio Heat %
* Daily Loss %
* Drawdown
* Flags:

  * üü° nearDailyLossLimit
  * üî¥ dailyLossLimitHit
  * üîß riskAllowNewPositions=false
  * üî• riskForceCloseAll

## **Active Positions Table**

Prikazuje sve ACTIVE pozicije.

---

# **9. API ENDPOINTI**

---

## **9.1 GET /api/risk/overview**

Vrati kompletan snapshot rizika.

---

## **9.2 GET /api/risk/limits**

Vrati sve limite iz CONFIG.risk.

---

## **9.3 GET /api/positions**

Vrati listu aktivnih pozicija.

---

## **9.4 GET /api/positions/:symbol**

Filter za jedan simbol.

---

## **9.5 GET /api/trades_log/:date**

Vrati dnevni trade log.

---

# **10. TEST SCENARIO PLAN**

### ‚úî Test 1 ‚Äî Unrealized PnL accuracy

### ‚úî Test 2 ‚Äî Portfolio Heat

### ‚úî Test 3 ‚Äî Daily loss limit block

### ‚úî Test 4 ‚Äî Heat block

### ‚úî Test 5 ‚Äî Scoring ‚Üí risk block

### ‚úî Test 6 ‚Äî StateMachine ‚Üí risk block

### ‚úî Test 7 ‚Äî Trade log JSON validity

---

# **11. FINALNI REZULTAT FAZE 08**

Kada se Faza 8 zavr≈°i:

### Sistem PRE svake odluke pita:

* da li imamo dovoljno kapitala?
* da li je portfolio veƒá previ≈°e izlo≈æen?
* da li je daily loss limit probijen?
* da li smem LONG?
* da li smem SHORT?
* da li je bezbedno nastaviti?

### I emituje jasne signale koje svi moduli po≈°tuju.

Posle Faze 08 ‚Äî tvoj bot prestaje da bude samo precizan, i postaje **profesionalno siguran**.

---

Ako ≈æeli≈°, sada mogu da pripremim:

### **FAZA 09 ‚Äì TP/SL Planner (tpSlPlanner.v4) + Multi-Target + BE logic + Trailing AI**

ili

### **FAZA 10 ‚Äì Auto-ReEntry v2.0 ‚Äì full architecture**

Samo reci **koju fazu da radimo sledeƒáu**.
