========================================
PHASE 18 ‚Äì PRODUCTION DEPLOYMENT & PROCESS SPLIT
(FINALNA FAZA ‚Äì ‚Äû≈ΩIVI U SINGAPURU, ADMIN U ≈†VEDSKOJ, NE PADA, NE ZABAGUJE‚Äú)

Ovom fazom zatvaramo ceo krug:
tvoj sistem vi≈°e nije ‚Äûveliki Node script‚Äú, nego mali cluster servisa na Singapur VPS-u:

jasna podela na servise (Market Data, Strategy, Execution, Web/Dashboard),

PM2 ih di≈æe i dr≈æi u ≈æivotu, sa health-check, logovima, auto-restartom,

deploy flow: Local VSCode ‚Üí GitHub ‚Üí VPS auto-update.sh ‚Üí PM2 reload ‚Üí sve radi,

environment varijable (.env) za kljuƒçeve, modove, API podatke,

logovi rotirani, backup osnovnih podataka (users.db, config, profiles, logs).

Sve setup-ovano tako da ti u ≈†vedskoj na laptopu radi≈° u VS Code, push na GitHub,
a Singapur VPS sam sebe dr≈æi u full produkciji bez da ‚Äûpipka≈° ruƒçno svaki put‚Äú.

0. CILJ PHASE 18

Definisati servise i podelu procesa (process split) u okviru scalper-base.

Napraviti PM2 ekosistem konfiguraciju (ecosystem.config.cjs ili .json).

Urediti environment konfiguraciju ‚Äì .env fajl (lokal + proizvodnja).

Uvesti deployment workflow:

lokalni razvoj (Windows VS Code),

Git commit & push,

auto-update na VPS (tvoj update.sh + cron),

PM2 reload i health.

Postaviti log rotaciju i minimalni backup plan za kritiƒçne fajlove.

Podesiti security & dostupnost (portovi, firewall, basic hardening).

1. SERVISI ‚Äì KONAƒåNA PODELA PROCESA

Na kraju ≈æelimo minimum 4 procesa (sve Node.js 20.x):

1) market-service       ‚Äì Market Data Pipeline (Bybit public WS/REST)
2) strategy-service     ‚Äì Feature, Pump/Regime, Scoring, State, Risk
3) execution-service    ‚Äì Bybit private REST/WS, real orders
4) web-dashboard        ‚Äì Express + Dashboard API/UI


Kasnije mo≈æe≈° dodati:

5) replay-service       ‚Äì Replay & Backtest (kada radi≈° offline analizu)
6) worker-service       ‚Äì Periodiƒçni poslovi (retention, profiles update)


Za sada: osnovna 4 servisa su prioritet.

1.1 Mapiranje na postojeƒái kod (folderi)

market-service
koristi module iz:

src/connectors/public/

src/market/

src/pipelines/ (orderbook, trades, microcandles)

src/logging/logger.js

strategy-service
koristi:

src/features/ (imbalance, walls, spoofing, delta, vola, fee)

src/pump/ (Pump & Anomaly engine)

src/regime/

src/scoring/

src/state/ (stateMachine)

src/risk/

src/latency/, src/profiles/, src/config/

execution-service
koristi:

src/connectors/private/

src/execution/

src/tpsl/ (Phase 9)

src/failover/ (Phase 17)

src/latency/, src/logging/logger.js

web-dashboard
koristi:

web/server.js

web/routes/

web/views/

web/public/

API moduli (health, alerts, backtest, replay‚Ä¶)

ƒçita data/system/*.json, data/alerts/*, data/backtests/runs/* itd.

2. DIREKTORIJUMSKA STRUKTURA ZA SERVISE

Nema≈° obavezno da pravi≈° 4 odvojena Node projekata ‚Äì dovoljna je logiƒçka podela entry-point fajlova:

scalper-base/
  src/
    services/
      market-service.js
      strategy-service.js
      execution-service.js
      replay-service.js         (opciono kasnije)
      worker-service.js         (retention/profile updater)


Svaki od ovih entry fajlova:

importuje odgovarajuƒáe module,

inicijalizuje config, logger, health, event-bus (npr. Redis ili internal FS/event emitter),

pokreƒáe petlju/WS konekcije.

Tip: svi servisi su Node ES module ("type": "module" je veƒá u package.json).

3. ENVIRONMENT KONFIGURACIJA ‚Äì .env

Koristi se paket kao dotenv (mo≈æda veƒá koristi≈°; ako ne, u Phase 18 dodaj).

3.1 Lokacije .env fajla

lokalno:
C:\Users\Dejan...\scalper-base\.env.local (ne di≈æe se na GitHub)

produkcija (VPS):
/home/aiuser/scalper-base/.env.production

Va≈æno: Ovaj fajl je u .gitignore ‚Äì nikad ne ide na GitHub.

3.2 Primer .env.production
# Environment mode
NODE_ENV=production

# Bybit API (REAL KEY ‚Äì production)
BYBIT_API_KEY=xxx
BYBIT_API_SECRET=yyy
BYBIT_ACCOUNT_TYPE=linear
BYBIT_NETWORK=mainnet

# Trading mode
EXECUTION_MODE=LIVE            # LIVE | DRY_RUN | SIM
MAX_LEVERAGE=20

# Web dashboard
WEB_PORT=8080
WEB_HOST=0.0.0.0

# SQLite / database
SQLITE_PATH=./data/users.db

# Telegram alerts
TELEGRAM_BOT_TOKEN=123456:ABC-tele-bot
TELEGRAM_CHAT_ID=123456789

# Logging
LOG_LEVEL=info                 # info | debug | warn | error

# Security
ADMIN_USERNAME=admin
ADMIN_PASSWORD_HASH=$2b$10$... (bcrypt hash, ne ƒçist password)

# Internal service IDs (za health, identifikaciju)
SERVICE_CLUSTER_ID=scalper-cluster-1


Tipovi:

sve vrednosti u .env su string.

u kodu ih kastuje≈° u number/bool gde treba.

4. PM2 KONFIGURACIJA ‚Äì ecosystem.config.cjs

U root projekta (/home/aiuser/scalper-base/ecosystem.config.cjs):

module.exports = {
  apps: [
    {
      name: "market-service",
      script: "./src/services/market-service.js",
      interpreter: "node",
      instances: 1,
      exec_mode: "fork",
      env_production: {
        NODE_ENV: "production",
        SERVICE_NAME: "market-service",
        ENV_FILE: ".env.production"
      }
    },
    {
      name: "strategy-service",
      script: "./src/services/strategy-service.js",
      interpreter: "node",
      instances: 1,
      exec_mode: "fork",
      env_production: {
        NODE_ENV: "production",
        SERVICE_NAME: "strategy-service",
        ENV_FILE: ".env.production"
      }
    },
    {
      name: "execution-service",
      script: "./src/services/execution-service.js",
      interpreter: "node",
      instances: 1,
      exec_mode: "fork",
      env_production: {
        NODE_ENV: "production",
        SERVICE_NAME: "execution-service",
        ENV_FILE: ".env.production"
      }
    },
    {
      name: "web-dashboard",
      script: "./web/server.js",
      interpreter: "node",
      instances: 1,
      exec_mode: "fork",
      env_production: {
        NODE_ENV: "production",
        SERVICE_NAME: "web-dashboard",
        ENV_FILE: ".env.production",
        PORT: 8080
      }
    },
    {
      name: "worker-service",
      script: "./src/services/worker-service.js",
      interpreter: "node",
      instances: 1,
      exec_mode: "fork",
      env_production: {
        NODE_ENV: "production",
        SERVICE_NAME: "worker-service",
        ENV_FILE: ".env.production"
      }
    }
  ]
};


Tipovi:

name, script, interpreter, exec_mode ‚Üí string

instances ‚Üí number

env_production ‚Üí object<string,string>

Trenutno veƒá ima≈° PM2 sa web/server.js --name dashboard.
U ovoj fazi taj proces postaje jedan od app-ova u ecosystem.config.cjs.

5. KAKO SE SERVISI POKREƒÜU (PM2)

Na VPS-u:

cd /home/aiuser/scalper-base

# inicijalno
pm2 start ecosystem.config.cjs --env production

# za proveru
pm2 list
pm2 status
pm2 logs market-service
pm2 logs execution-service
pm2 logs web-dashboard

# svaki put kada update.sh povuƒçe novi kod:
pm2 reload ecosystem.config.cjs --env production


Tvoj postojeƒái update.sh:

#!/bin/bash
cd /home/aiuser/scalper-base

echo "üì• Pulling latest from GitHub..."
git fetch --all
git reset --hard origin/master

echo "üì¶ Installing dependencies..."
npm install --silent

echo "üîÑ Reloading PM2 apps..."
pm2 reload ecosystem.config.cjs --env production

echo "‚úÖ Update complete!"


(sam promenio liniju pm2 restart dashboard u pm2 reload ecosystem.config.cjs --env production)

Cron ostaje isti:

*/1 * * * * /home/aiuser/update.sh >> /home/aiuser/update.log 2>&1

6. DEPLOYMENT FLOW ‚Äì OD VS CODE DO PRODUKCIJE
6.1 Lokalni rad (Windows VS Code)

Radi≈° u C:\Users\DejanTrajkovic\Documents\scalper-base\

Setuje≈° .env.local (testnet, SIM/DRY_RUN mode).

Pokreƒáe≈° servise lokalno, ali mo≈æe≈° i monolit ‚Äûall-in-one‚Äú za test:

node src/services/market-service.js

node src/services/strategy-service.js

node src/services/execution-service.js (DRY_RUN)

node web/server.js

Kad si zadovoljan:

git add .

git commit -m "Phase xx ‚Äì feature y"

git push origin master

6.2 VPS Singapur ‚Äì auto update

Cron svake minute poziva update.sh.

update.sh povlaƒçi poslednji commit, radi npm install, radi pm2 reload.

PM2 napravi ‚Äûzero-downtime reload‚Äú ‚Äì servisi se restartuju jedan po jedan, bez velikih prekida.

Posle reload-a:

health monitor (Phase 1 / 11 / 17) proveri da li je sve OK.

ako ne, Failover & Alerts (Phase 16/17) javljaju problem.

7. LOGOVI ‚Äì ORGANIZACIJA I ROTACIJA

PM2 sam vodi log fajlove (po default-u):

~/.pm2/logs/market-service-out.log
~/.pm2/logs/market-service-error.log
... itd.


Ali tvoj sistem veƒá ima:

data/alerts/alert_log.jsonl

data/trades_log/day-YYYY-MM-DD.jsonl

data/orders/day-YYYY-MM-DD.jsonl

data/events/<symbol>.jsonl

data/system/*.json

7.1 PM2 log rotacija

Instalacija:

pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
pm2 set pm2-logrotate:compress true
pm2 set pm2-logrotate:dateFormat YYYY-MM-DD_HH-mm-ss


Tipovi:

max_size ‚Äì string "10M"

retain ‚Äì string/numeric 7

7.2 Interni retention (Phase 12)

Veƒá ima≈° retention.js koji:

bri≈°e stare JSON log fajlove iz data/ nakon X dana.

Worker-service (Phase 18) ƒáe:

jednom dnevno pozivati:

runRetentionJob()

profileUpdater.updateAll()

eventualno backup snapshot.

8. MINIMALNI BACKUP PLAN

Kritiƒçne datoteke:

data/users.db ‚Äì login korisnici

data/system/config_history.jsonl

data/system/config_version.json

data/system/process_state.json

data/profiles/*.json

data/backtests/runs/* (nije kritiƒçno, ali vredno)

Mo≈æe≈° uvesti jednostavan backup script:

/home/aiuser/backup.sh:

#!/bin/bash
DATE=$(date +"%Y%m%d-%H%M%S")
BACKUP_DIR="/home/aiuser/backups/$DATE"
mkdir -p "$BACKUP_DIR"

cp -r /home/aiuser/scalper-base/data/users.db "$BACKUP_DIR"/
cp -r /home/aiuser/scalper-base/data/system "$BACKUP_DIR"/system
cp -r /home/aiuser/scalper-base/data/profiles "$BACKUP_DIR"/profiles

echo "Backup created at $BACKUP_DIR"


Cron (jednom dnevno):

0 3 * * * /home/aiuser/backup.sh >> /home/aiuser/backup.log 2>&1

9. SECURITY & NETWORK
9.1 Portovi

Dashboard: port 8080 (veƒá koristi≈°).

Po≈æeljno: staviti ispred Nginx sa basic auth / HTTPS, ali minimalna verzija:

U ufw firewallu:

sudo ufw allow OpenSSH
sudo ufw allow 8080/tcp       # (ili ƒçak ograniƒçiti samo na tvoju IP)
sudo ufw enable


Za jo≈° bolju sigurnost:

ufw allow from <tvoja-IP-adresa> to any port 8080
(ograniƒçiti dashboard pristup samo sa tvoje IP / kuƒáe/kancelarije).

9.2 API kljuƒçevi

Bybit keys STO u .env.production (nikad u repo).

Telegram bot token isto u .env.production.

Admin credentials:

u bazi users.db hashed password

ne koristimo plain text u .env sem ako mora (i onda hashed ili random).

9.3 OS Hardening ‚Äì minimalno

Auto-update OS security paketa (unattended-upgrades).

Zabranjen root login preko SSH (koristi≈° aiuser + sudo).

SSH key-based auth (ne password).

(Ovo je vi≈°e DevOps, ali bitno za ozbiljan trading bot.)

10. HEALTH, FAILOVER & ALERTS ‚Äì KONAƒåNO VEZIVANJE

Posle Phase 18:

Svi servisi ≈°alju heartbeats i HealthSnapshot ima:

services: {
  "market-service": {...},
  "strategy-service": {...},
  "execution-service": {...},
  "web-dashboard": {...},
  "worker-service": {...},
  ...
}


Ako jedan proces padne (PM2 ga restartuje), FailoverManager:

detektuje restart (ProcessState vs new pid),

generi≈°e PROCESS_RESTART FailureEvent,

radi RESYNC_POSITIONS/ORDERS,

AlertEngine (Phase 16) ≈°alje CRIT info na Telegram.

Dashboard global panel:

vidi≈° koji servisi su ON,

vidi≈° mode (SIM/DRY/LIVE),

vidi≈° da li je SAFE_MODE + RISK_OFF.

11. TEST SCENARIJI ZA PHASE 18
Test 1 ‚Äì PM2 multi-service start

U Singapuru:

pm2 delete all (pa≈æljivo, ako ima starih test procesa).

pm2 start ecosystem.config.cjs --env production

Provera: pm2 list ‚Äì vidi≈° 4 app-a (market, strategy, execution, web, worker).

Dashboard na http://<vps-ip>:8080/ radi; health pokazuje sve OK.

Test 2 ‚Äì Auto-deploy

Napravi malu izmenu u kodu lokalno.

git commit, git push.

Saƒçekaj minut ‚Üí update.sh odradi svoj posao.

pm2 list vidi restart time, novi build.

Dashboard verzija (npr. verzija u footer-u) se promenila.

Test 3 ‚Äì Proces crash & auto-restart

Ruƒçno ubij market-service:

pm2 stop market-service pa pm2 start market-service,
ili u testu simuliraj exception.

PM2 ga restartuje.

Health & failover: vidi PROCESS_RESTART; safeMode ako treba; alert.

Test 4 ‚Äì Env separacija

Lokalu: .env.local sa DRY_RUN/testnet.

VPS: .env.production sa LIVE/mainnet.

Uveri se da nikad ne koristi≈° LIVE kljuƒç u SIM/DRY_RUN lokalno.

Test 5 ‚Äì Restart celog clustera

pm2 reload ecosystem.config.cjs

Sistem se reload-uje bez ‚Äûhard down‚Äú stanja.

Health nakon 30 sekundi: sve GREEN.

Nikakve pozicije na Bybit-u nisu ‚Äûizgubljene‚Äú ‚Äì recovery radi.

12. FINALNI REZULTAT ‚Äì POSLE PHASE 18

Tvoj AI Scalper sistem:

Radi na Singapur VPS-u kao skup servisa:

market-service

strategy-service

execution-service

web-dashboard

worker-service

Ima:

stabilan deployment flow (GitHub ‚Üí auto-update ‚Üí PM2 reload),

standardizovan config preko .env.production + config.json,

logove pod kontrolom (rotation + retention),

safe failover & recovery (Phase 17),

alerting (Phase 16) kad god ne≈°to nije u redu,

replay + backtest laboratoriju (Phase 12‚Äì13),

adaptive config & profile sistem (Phase 14‚Äì15).

Ovo vi≈°e nije ‚Äûsklepani bot‚Äú ‚Äì ovo je mini trading platforma sa:

jasno definisanim modulima,

procesima koji ≈æive dugo,

automatskim update-om,

sigurnosnim slojem,

alatom za razvoj i testiranje (lokalno + VPS).

========================================
KRAJ DOKUMENTA ‚Äì PHASE 18
(KOMPLETAN SISTEMSKI PLAN JE ZATVOREN)
