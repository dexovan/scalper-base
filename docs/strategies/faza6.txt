Razumem â€” nastavljamo odmah.

# âœ… **FAZA 6 â€“ STATE MACHINE (Trade Lifecycle Orchestration)**

**Cilj:** napraviti savrÅ¡eno organizovan orkestrator koji upravlja celim Å¾ivotnim ciklusom jednog trejda â€“ od signala â†’ do kompletnog zatvaranja â†’ do ÄiÅ¡Ä‡enja stanja.

Ovo je *mozak sistema*.
Bez stabilne **state machine**, trading engine nikada neÄ‡e biti pouzdan.

---

# ğŸ§© **FAZA 6 â€“ Kompletna Programerska Specifikacija**

## ğŸ”¥ 6.0. Arhitektura

Faza 6 uvodi *jedan centralni modul*:

```
src/state/
   tradeStateMachine.js
   stateTransitions.js
   stateConstants.js
   stateLogger.js
   stateRecovery.js
```

Integracija sa modulima iz Faza 3, 4 i 5:

* `signalEngine` â†’ aktivira ULazno stanje (signal_detected)
* `peakEngine` â†’ prelazi u waiting_peak / waiting_pullback
* `entryEngine` â†’ prelazi u entry_pending / in_position
* `positionEngine` â†’ TP/DCA/SL prelaze u partial_exit / risk_free / closing
* `dcaEngine` â†’ trigeruje posebna stanja
* `tpEngine` â†’ prelazi stanje kada TP1/TP2/TP3 pogode
* `skipFilters` â†’ poniÅ¡tavaju state i vraÄ‡aju u IDLE

State Machine je apsolutni **master controller**.

---

# ğŸ­ **6.1 Lista Stanja (Definitivno i konaÄno)**

### **0) IDLE**

Sistem ne radi niÅ¡ta, Äeka validan signal.
Ulazi: posle zatvaranja trejda ili skip filtera.

### **1) SIGNAL_DETECTED**

Stigao validan signal (score >=70).
Sistem pokreÄ‡e peak detection.

### **2) WAITING_PEAK**

PraÄ‡enje 1â€“3 min dok se formira lokalni maksimum (short) ili minimum (long).

### **3) WAITING_PULLBACK**

Peak/minimum detektovan â†’ sada Äeka 3â€“5% pullback.

### **4) ENTRY_PENDING**

Pullback dobar â†’ Äeka potvrdu orderbook/microstructure â†’ priprema entry.

### **5) IN_POSITION**

Pozicija otvorena.
U ovom stanju radi:

* TP engine
* DCA engine
* Order monitoring
* Price watcher

### **6) PARTIAL_EXIT**

TP1 ili TP2 pogodi â†’ prelazi u ovo stanje i zatim nazad u IN_POSITION.

### **7) RISK_FREE**

TP1 hit â†’ SL pomeren na entry â†’ bez rizika.

### **8) CLOSING**

Finalni TP/SL â†’ zatvaramo celokupnu poziciju.

### **9) CLOSED**

Trejd zatvoren, stanje oÄiÅ¡Ä‡eno â†’ prelazi nazad u IDLE.

---

# ğŸ” **6.2 Validne Transicije**

### SIGNAL â†’ PEAK

```
IDLE
 â†’ SIGNAL_DETECTED
 â†’ WAITING_PEAK
```

### PEAK â†’ PULLBACK

```
WAITING_PEAK â†’ WAITING_PULLBACK
```

### PULLBACK â†’ ENTRY

```
WAITING_PULLBACK â†’ ENTRY_PENDING
```

### ENTRY â†’ LIVE

```
ENTRY_PENDING â†’ IN_POSITION
```

### TP1/TP2

```
IN_POSITION â†’ PARTIAL_EXIT â†’ IN_POSITION
```

### TP3

```
IN_POSITION â†’ CLOSING â†’ CLOSED â†’ IDLE
```

### DCA

```
IN_POSITION â†’ IN_POSITION (restart TP logic)
```

### Breakeven mode

```
PARTIAL_EXIT(TP1) â†’ RISK_FREE â†’ IN_POSITION
```

### Abort (skip filter)

```
any state â†’ IDLE
```

### Timeout

```
WAITING_PEAK (5 min timeout) â†’ IDLE
WAITING_PULLBACK (5 min timeout) â†’ IDLE
ENTRY_PENDING (30s timeout) â†’ IDLE
```

---

# âš ï¸ **6.3 Timeout Sistemi**

### WAITING_PEAK timeout (5 min)

Ako u 5 minuta nema lokalnog maksimuma â†’ poniÅ¡tava trejd.

### WAITING_PULLBACK timeout (3â€“5 min)

Ako nema pullback od 3â€“5% â†’ odustani.

### ENTRY_PENDING timeout (30 sekundi)

Ako microstructure ne potvrdi entry â†’ skip.

### IN_POSITION timeout

NEMA timeout â€” trejd moÅ¾e da traje satima (Andre i do 9h).

---

# ğŸ“¦ **6.4 State Persistence (Obavezno!)**

Sve stanje mora da preÅ¾ivi:

* restart Node.js procesa
* PM2 reload
* server crash
* WS reconnect

Implementacija:

```
data/state/currentTrade.json
data/state/history.jsonl
```

SadrÅ¾aj primer `currentTrade.json`:

```json
{
  "state": "IN_POSITION",
  "symbol": "1000SATS",
  "entry": 0.0004562,
  "tp": { "tp1": 0.0004601, "tp2": 0.0004688, "tp3": 0.0004917 },
  "dca": { "d1": 0.0004789, "d2": 0.0005076, "d3": 0.0006168 },
  "timestamp": 1712345678
}
```

---

# ğŸ”¥ **6.5 Event-Driven Architecture**

Potrebno je koristiti EventEmitter:

```
src/state/stateBus.js
```

Eventi:

### Signal events

```
signal.detected
signal.rejected
```

### Peak events

```
peak.found
pullback.ok
pullback.rejected
```

### Entry events

```
entry.confirmed
entry.failed
```

### Position events

```
position.opened
position.partially_closed
position.dca_hit
position.tp_hit
position.breakeven
position.closed
```

Sve ide kroz state machine:

```
eventBus.on('entry.confirmed', () => stateMachine.transition('IN_POSITION'))
```

---

# ğŸ“˜ **6.6 Logovanje State Promena**

Svaka promena stanja ide u:

```
data/logs/state.log
```

Format:

```
2025-11-22 13:04:51 | RADUSDT | WAITING_PEAK â†’ WAITING_PULLBACK | peak: 0.06523
2025-11-22 13:05:37 | RADUSDT | WAITING_PULLBACK â†’ ENTRY_PENDING | pullback: -3.8%
2025-11-22 13:05:59 | RADUSDT | ENTRY_PENDING â†’ IN_POSITION | entry: 0.06296
2025-11-22 13:12:10 | RADUSDT | IN_POSITION â†’ PARTIAL_EXIT | TP1 hit
2025-11-22 13:18:44 | RADUSDT | IN_POSITION â†’ CLOSING | TP3 hit
2025-11-22 13:18:45 | RADUSDT | CLOSING â†’ CLOSED
```

---

# ğŸ§¨ **6.7 State Recovery (kljuÄan deo)**

Ako engine padne i ponovo se startuje, radi se:

1. uÄitaj `currentTrade.json`
2. ako nema â†’ state = IDLE
3. ako ima:

### Ako je stanje IN_POSITION

â†’ odmah re-startuj TP/DCA monitoring

### Ako je ENTRY_PENDING

â†’ proveri trÅ¾iÅ¡te, ako viÅ¡e ne vaÅ¾i â†’ IDLE

### Ako je WAITING_PEAK ili WAITING_PULLBACK

â†’ proveri da li je istekao timeout â†’ IDLE

### Ako CLOSED

â†’ IDLE + arhivirati

Nikada se ne sme:
âŒ izgubiti trejd usred rada
âŒ zaboraviti stanje i otvoriti dupli entry
âŒ ignorisati DCA/TP kada je pozicija veÄ‡ tu

---

# ğŸ§  **6.8 Edge Cases koji MORAJU biti pokriveni**

### 1. WS reconnect during IN_POSITION

â†’ nastaviti monitoring bez gubitka podataka

### 2. Bybit API error tokom TP hit

â†’ retry 5x â†’ fallback market close

### 3. TP1 hit + price vraÄ‡en gore (fake TP?)

â†’ proveriti preko trade fills, ne samo price ticka

### 4. Double DCA hit u istoj sekundi

â†’ queue ordera, izvrÅ¡avati sekvencijalno

### 5. Multiple TP hits u istoj sveÄ‡i

â†’ izvrÅ¡iti ih u redosledu TP1 â†’ TP2 â†’ TP3

### 6. State corruption (npr. JSON oÅ¡teÄ‡en)

â†’ fallback u IDLE + alert adminu

---

# ğŸ”’ **6.9 NajvaÅ¾nija pravila**

### **State machine je JEDINA istina.**

Ni jedan modul ne sme da menja stanje direktno.

### **Sve ide kroz transition() metod.**

Bez hackova.

### **Svako stanje mora da ima:**

* enter() handler
* exit() handler
* allowed transitions

### **Svi paralelni trejdovi (max 3) imaju svoj state machine instance.**

---

# âœ”ï¸ **6.10 Success Criteria**

Da bi FAZA 6 bila kompletna:

* 100% svih stanja implementirano
* nema deadlock (blokiranih stanja)
* recovery radi nakon ruÅ¡enja
* sve logike idu kroz eventBus
* svako stanje ima timeout
* concurrency izolovan po trejdu
* sistem radi 24/7 bez gubitka stanja
* <50ms transition latency

Ovo je industrijski nivo â€” identiÄno kao Binance botovi.

---

# ğŸŸ¢ Spreman za FAZU 7 â€“ Bybit API Execution Layer?

Ako jesi â†’ kreÄ‡em odmah.
