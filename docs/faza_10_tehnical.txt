Odliƒçno.
Sada isporuƒçujem **FAZU 10 ‚Äì EXECUTION ENGINE** u *ultra-detaljnom programersko-tehniƒçkom formatu*, identiƒçnom nivou kakav smo koristili za Faze 6-7-8-9.

---

# ‚úÖ **PHASE 10 ‚Äì EXECUTION ENGINE**

**ORDER ROUTING ‚Ä¢ SIM/DRY/LIVE ‚Ä¢ SAFETY GUARDS ‚Ä¢ ORDER LOGS**
**FINAL ENGINEERING DOCUMENT ‚Äî MAX DETAIL**

---

# 1. PREGLED

Ovo je faza gde bot po prvi put **realno upravlja nalozima**.

Iz prethodnih faza sada imamo:

* **StateMachine (Faza 07):** generi≈°e ORDER_REQUEST (open/close/reverse)
* **RiskEngine (Faza 08):** dozvoljava / blokira naloge
* **TPSL Engine (Faza 09):** tra≈æi SL/TP naloge i trailing izmene
* **RegimeEngine (Faza 05):** odreƒëuje da li tr≈æi≈°te dozvoljava pozicije

**Execution Engine** je ‚Äúruke i noge‚Äù sistema ‚Äî sve ostalo je mozak.

On:

* prima ORDER_REQUEST dogaƒëaje
* radi **complete safety validation**
* route-uje naloge u:

  * SIM engine (lokalna simulacija)
  * DRY_RUN engine (bez slanja, ali kao realni fill)
  * LIVE engine (Bybit REST/WS)
* propagira EXECUTION_* dogaƒëaje ka:

  * stateMachine
  * positionTracker
  * riskEngine
  * TPSLEngine
* vodi sve ORGANIƒåNE evidencije u JSON Lines formatima

Ovo je apsolutno kritiƒçna faza.

---

# 2. FAJLOVI KOJI SE UVODE / MENJAJU

## üìÅ Novi fajlovi

```
src/connectors/bybitPrivateRest.js
src/execution/executionEngine.js
src/execution/orderRouter.js
src/execution/safetyGuards.js
src/execution/simulatedExchange.js
```

## üìÅ Izmene u postojeƒáim

```
src/state/stateMachine.js        // dodaje ORDER_REQUEST ‚Üí EXEC events
src/risk/positionTracker.js      // koristi EXEC events
src/monitoring/health.js         // execution health blok
web/routes/api.js                // novi endpoint-i
```

## üìÅ Novi JSON fajlovi

```
data/orders/day-YYYY-MM-DD.json
data/system/execution_snapshot.json
```

---

# 3. CONFIG.execution (kritiƒçna konfiguracija)

U `src/config/index.js`:

```
CONFIG.execution = {
  mode: "SIM",               // "SIM" | "DRY_RUN" | "LIVE"
  venue: "BYBIT_LINEAR_PERP",

  restBaseUrl: "...",
  wsPrivateUrl: "...",

  maxSlippagePct: 0.10,
  maxSpreadPct: 0.15,
  orderTimeoutMs: 120000,
  maxRetryCount: 3,

  minNotionalUsd: 5,
  maxNotionalUsd: 500,

  clientOrderIdPrefix: "AISCLP",

  panicCloseOnGlobalPanic: true,
  safeModeOnNetworkErrors: true
}
```

ENV varijable za LIVE:

```
BYBIT_API_KEY
BYBIT_API_SECRET
BYBIT_ENV=MAINNET | TESTNET
```

---

# 4. OSNOVNI TIPOVI

## 4.1 OrderSide

```
"BUY" | "SELL"
```

## 4.2 OrderType

```
"LIMIT" | "MARKET" | "STOP_MARKET" | "TAKE_PROFIT_MARKET"
```

## 4.3 TimeInForce

```
"GTC" | "IOC" | "FOK" | "PostOnly"
```

## 4.4 OrderStatus

```
"NEW" | "PARTIALLY_FILLED" | "FILLED" | "CANCELED" | "REJECTED" | "EXPIRED"
```

---

# 5. ORDER_REQUEST OBJEKAT (koji dolazi u ExecutionEngine)

```
{
  symbol: "BTCUSDT",
  side: "LONG" | "SHORT",
  action: "OPEN" | "CLOSE" | "REVERSE",

  qtyUsd: number | null,
  qtyContracts: number | null,

  preferredType: "LIMIT" | "MARKET",
  timeInForce: string,
  reduceOnly: boolean,

  source: "STATE_MACHINE" | "TPSL_ENGINE" | "MANUAL"
}
```

ExecutionEngine ovo konvertuje u ‚Äúreal order‚Äù.

---

# 6. ORDER_REQUEST ‚Üí OrderRequest (real format)

ExecutionEngine kreira:

```
OrderRequest = {
  symbol: string,
  side: "BUY" | "SELL",
  type: string,              // limit/market/tp/sl
  price: number | null,
  triggerPrice: number | null,
  qty: number,
  reduceOnly: boolean,
  timeInForce: string,
  clientOrderId: "AISCLP-<timestamp>-<rand>",
  source: string,
  mode: CONFIG.execution.mode
}
```

Ovo ide kroz safety guards, pa u orderRouter.

---

# 7. SAFETY GUARDS (src/execution/safetyGuards.js)

Najbitniji modul koji spreƒçava katastrofu.

## validateOrderRequest(orderRequest, marketSnapshot, riskSnapshot, regimeState)

```
returns: {
  ok: boolean,
  reasons: [],
  warnings: [],
  adjustedOrder?: OrderRequest
}
```

### 7.1 Provere:

#### ‚úî Spread check

```
if spreadPct > maxSpreadPct ‚Üí ok=false
```

#### ‚úî Slippage check

Za LIMIT BUY/SELL:

```
if |orderPrice - best| / best > maxSlippagePct ‚Üí reject
```

#### ‚úî Notional check

```
notional = price * qty
notional < minNotional ‚Üí reject
notional > maxNotional ‚Üí reject or adjust qty
```

#### ‚úî Risk blokade

```
riskAllowNewPositions === false ‚Üí reject
riskAllowNewLong === false and BUY ‚Üí reject
riskAllowNewShort === false and SELL ‚Üí reject
```

#### ‚úî Regime blokade

```
regimeState.current != "NORMAL" and order is opening ‚Üí reject
globalRegime = GLOBAL_PANIC ‚Üí reject
```

### Ako bilo ≈°ta nije OK ‚Üí ExecutionEngine ≈°alje:

```
EXECUTION_ORDER_REJECTED
```

---

# 8. SIMULATED EXCHANGE (src/execution/simulatedExchange.js)

U SIM/DRY_RUN modovima bot nikada ne ≈°alje stvarne naloge.

### placeOrderSim(orderRequest, marketSnapshot)

* MARKET ‚Üí instant fill @ bestBid/ask (plus maleni slippage)
* LIMIT:

  * ako povoljna cena ‚Üí instant fill
  * inaƒçe NEW (pending)

### cancelOrderSim(simOrderId)

* odmah = canceled

### getOpenOrdersSim()

* vraƒáa pending sim naloge

Ultra jednostavno, ali precizno za testiranje.

---

# 9. ORDER ROUTER (src/execution/orderRouter.js)

Centralni modul koji bira ≈°ta se de≈°ava:

```
async routeOrder(orderRequest, marketSnapshot, riskSnapshot, regimeState)
```

### Flow:

1. safetyGuards.validate()
2. ako !ok ‚Üí ExecutionOrder(REJECTED)
3. ako SIM ‚Üí simulatedExchange.placeOrderSim()
4. ako DRY_RUN ‚Üí isto kao SIM (za sada)
5. ako LIVE ‚Üí bybitPrivateRest.placeOrder()

### loguje svako u:

```
data/orders/day-YYYY-MM-DD.json  (JSON Lines)
```

### vraƒáa ExecutionOrder objekat:

```
{
  clientOrderId,
  exchangeOrderId,
  status,
  filledQty,
  avgFillPrice,
  source,
  mode,
  price,
  qty,
  reduceOnly,
  notionalUsd,
  createdAt,
  updatedAt
}
```

---

# 10. EXECUTION ENGINE (src/execution/executionEngine.js)

Najva≈æniji modul faze.

## 10.1 internal state:

```
ExecutionEngineState = {
  mode,
  safeMode,
  pendingOrders: Map<clientOrderId, ExecutionOrder>,
  lastErrorAt,
  lastErrorMessage
}
```

---

## 10.2 initExecutionEngine()

* uƒçitava config
* prazni pendingOrders
* safeMode=false
* spreman da prima ORDER_REQUEST evente

---

## 10.3 submitOrder(request: OrderRequestInput)

1. pretvori side/action ‚Üí BUY/SELL
2. izraƒçunaj qty
3. napravi OrderRequest
4. marketSnapshot = bestBid/ask
5. riskSnapshot = riskEngine.getRiskSnapshot()
6. regimeState = regimeEngine.getSymbolRegime(symbol)
7. routeOrder()
8. dobije ExecutionOrder
9. ≈°alje state event:

### Moguƒái event-i:

#### ‚úî EXECUTION_ORDER_PLACED

#### ‚úî EXECUTION_ORDER_FILLED

#### ‚úî EXECUTION_ORDER_REJECTED

#### ‚úî EXECUTION_ORDER_CANCELED

Za fill‚Üí ≈°alje:

* EXECUTION_POSITION_OPENED
* EXECUTION_POSITION_CLOSED

koje koriste:

* stateMachine
* riskEngine (positionTracker)
* TPSLEngine

---

# 11. FILL UPDATE

Sim engine ili Bybit (LIVE) ≈°alju update:

ExecutionEngine:

```
handleFillUpdate(orderUpdate)
```

‚Üí a≈æurira pendingOrders
‚Üí generi≈°e STATE EVENTS:

* EXECUTION_ORDER_FILLED
* EXECUTION_POSITION_OPENED
* EXECUTION_POSITION_CLOSED

---

# 12. PANIC CLOSE (globalno ili po simbolu)

ExecutionEngine nudi:

### panicCloseAll(reason)

* safeMode=true
* pronaƒái sve aktivne pozicije
* poslati MARKET reduceOnly CLOSE
* logovati sve

### panicCloseSymbol(symbol, reason)

* analogno, samo jedan simbol

StateMachine dobija PANIC event i ulazi u BLOCKED/COOLDOWN.

---

# 13. JSON LOGOVI

## data/orders/day-YYYY-MM-DD.json

Svaki order / update je jedan JSON line.

## data/system/execution_snapshot.json

```
{
  timestamp,
  mode,
  safeMode,
  pendingOrdersCount,
  activeOrdersCount,
  lastErrorAt,
  lastErrorMessage
}
```

---

# 14. API ENDPOINTS

## GET /api/execution/overview

execution snapshot

## GET /api/execution/orders

filtriranje po symbol/status

## POST /api/execution/panic-close-all

zatvori sve pozicije

## POST /api/execution/panic-close-symbol

zatvori samo jedan simbol

## POST /api/execution/cancel-orders

cancel pending ordera

---

# 15. DASHBOARD POSLE FAZE 10

## Execution panel:

* MODE: SIM / DRY / LIVE
* SafeMode indicator
* Pending count
* Active count

## Global panic button

## Per-symbol panic button

## Order table (live-updating):

* time
* symbol
* side
* type
* price
* qty
* status
* source

---

# 16. TEST SCENARIJI ‚Äî VALIDACIJA

### Test 1 ‚Äî SIM happy path

* submitOrder(LONG MARKET)
* expected: EXECUTION_ORDER_FILLED + POSITION_OPENED

### Test 2 ‚Äî Spread too wide

* expected: REJECTED + reason

### Test 3 ‚Äî Daily loss block

* riskAllowNewPositions=false ‚Üí REJECTED

### Test 4 ‚Äî Regime pump block

* regime=PUMP ‚Üí REJECTED

### Test 5 ‚Äî Panic close

* global panic closes all

### Test 6 ‚Äî Correct logging

* JSON files valid

### Test 7 ‚Äî Execution snapshot correctness

---

# 17. FINALNI REZULTAT FAZE 10

Kada ova faza bude gotova:

‚úî Sistem mo≈æe da ≈°alje orƒçestrisane naloge u SIM/DRY/LIVE modu
‚úî Svi nalogi su **bezbednosno validirani** (spread/slippage/risk/regime)
‚úî Svi rezultati se pretvaraju u **EXECUTION_* evente** koje drugi moduli koriste
‚úî Sistem ima **panic close** mehanizme
‚úî Dashboard dobija kompletan execution panel
‚úî Svaki nalog se loguje ‚Äî nema ‚Äúnevidljivih‚Äù operacija
‚úî Tok izvr≈°enja je potpuno jasan i auditabilan

**Execution Engine sada ƒçini tvoj sistem industrijski profesionalnim i sigurnim.**

---

Ako ≈æeli≈° ‚Äî odmah prelazimo na **FAZU 11 ‚Äì AUTO-REENTRY SYSTEM (v1.0 / v2.0)**
ili
**FAZU 12 ‚Äì ADVANCED POSITION MANAGEMENT / PARTIALS / SMART SIZING**
ili
**FAZU 13 ‚Äì DASHBOARD REALTIME WS + ALERTING**.

≈†ta dalje ≈æeli≈°?
