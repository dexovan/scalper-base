
# ğŸ”¥ FAZA 5 â€” ULTRA DETALJAN PLAN RADA

## **REGIME ENGINE (PER-SYMBOL + GLOBAL MARKET REGIME)**

*(Potpuni tehniÄki i operativni plan koji direktno nastavlja na Faze 1â€“4)*

---

# ğŸ§© **0. KONTEKST â€” Å¡ta smo zavrÅ¡ili do sada**

Tvoj sistem sada ima:

* **Faza 1** â†’ Bazni framework, konfiguraciju, engine skeleton
* **Faza 2** â†’ Bybit Public Connector + Universe + Path System
* **Faza 3** â†’ Orderbook, Trades, Micro-Candles pipeline
* **Faza 4** â†’ Feature Engine (imbalance, walls, spoofing, flow, vola, pump-pre-signals, fee/leverage, metrics snapshot)

**FAZA 5 SADA UVODI:**

* inteligentnu interpretaciju feature-a
* per-symbol reÅ¾ime (NORMAL, PUMP, MANIPULATED, NEWS_DRIVEN, COOLDOWN)
* global market reÅ¾ime (NORMAL, RISK_OFF, PANIC)
* logiku prelaza
* cooldown mehanizme
* integraciju sa state-maÅ¡inom i scoring engine-om
* blokade i risk interfejs

---

# ğŸš€ **1. CILJ FAZE 5 â€” Å TA TAÄŒNO GRADIMO**

U ovoj fazi mora da se implementira **potpuno funkcionalan Regime Engine** koji radi:

### **1. Per-symbol reÅ¾im**

Za svaki simbol bot mora realno da zna:

* da li je simbol normalan â†’ scalping dozvoljen
* da li je u pump modu â†’ LONG zabranjen, short specijalan
* da li je manipulisan â†’ trgovanje blokirano
* da li je news-driven â†’ oprez, minimalni trade
* da li je u cooldown â†’ privremena zabrana posle eksplozije volatilnosti

### **2. Global regime (BTC/ETH + trÅ¾iÅ¡te)**

Bot mora da prepozna:

* RISK_OFF â†’ ne otvaraj nove pozicije
* PANIC â†’ zatvori postojeÄ‡e pozicije ASAP
* NORMAL â†’ sve dozvoljeno

### **3. Kompletan kontrolni sloj izmeÄ‘u Faza 4 i buduÄ‡e Faze 6/7**

Regime Engine odreÄ‘uje da li Ä‡e scoring/state-machine uopÅ¡te moÄ‡i da razmatra trejdove.

Regime je najvaÅ¾niji mehanizam spreÄavanja *â€œidiotskih ulazaâ€* i sistemskih gubitaka.

---

# ğŸš€ **2. STRUKTURA FAZE 5 â€” Å TA SE TAÄŒNO IMPLEMENTIRA**

## ğŸ“Œ Nova 3 modula:

```
src/regime/symbolRegime.js
src/regime/globalRegime.js
src/regime/regimeEngine.js
```

## ğŸ“Œ Izmene:

```
src/features/featureEngine.js
src/monitoring/health.js
web/routes/api.js
```

## ğŸ“Œ Novi fajlovi u data/:

```
data/system/global_regime.json
```

I dopuna:

```
data/metrics/<symbol>.json  â† feature + regime snapshot
```

---

# ğŸš€ **3. KORAK-PO-KORAK TEHNIÄŒKI PLAN (ULTRA DETALJAN)**

## ------------------------------------------------------------

# **STEP 1 â€” Kreirati strukturu RegimeEngine**

Putanja:

```
src/regime/regimeEngine.js
```

RegimeEngineState:

```
{
  perSymbol: {
     BTCUSDT: RegimeStateObject,
     ETHUSDT: RegimeStateObject,
     ...
  },
  globalRegime: GlobalMarketRegimeObject
}
```

### Zadatak:

* inicijalizacija prazne mape `perSymbol`
* inicijalizacija `globalRegime = GLOBAL_NORMAL`
* import svih potrebnih dependencija:

  * featureEngine
  * universe
  * logger
  * config

### Najbolja praksa:

Sve reÅ¾ime u memoriji drÅ¾ati kao **Äisti JavaScript objekti** (bez klasa) jer su brÅ¾i za GC i snapshot.

---

# **STEP 2 â€” Implementacija Symbol Regime modula**

Putanja:

```
src/regime/symbolRegime.js
```

### RegimeState format (finalni):

```
{
  symbol: "BTCUSDT",
  current: "NORMAL",
  updatedAt: "2025-11-19T21:05:11.122Z",

  pumpState: "NONE",
  pumpStrength: 0.0,

  spoofingLevel: 0.0,
  newsImpactScore: 0,
  volatilityScore: 0.0,

  cooldownActive: false,
  cooldownEndsAt: null,
  cooldownReason: null
}
```

### Logika odreÄ‘ivanja reÅ¾ima:

#### PRIORITETI (najjaÄi â†’ najslabiji)

1. NEWS_DRIVEN
2. MANIPULATED
3. PUMP
4. COOLDOWN
5. NORMAL

### Ulazi iz Feature Engine-a:

* spoofingScore
* pumpLikelihoodScore
* pumpSignals.priceChange5sPct
* volatility.explosionFlag
* volatilityScore

### Ulaz iz NewsEngine:

* impactScore
* type

---

# **STEP 3 â€” Implementirati determineSymbolRegime()**

Ovo je srce per-symbol logike.

Parametri:

```
(symbol, featureState, newsState, previousRegime)
```

### Profesionalno podeÅ¡eni pragovi (bez pitanja):

```
NEWS_THRESHOLD = 80
SPOOF_THRESHOLD = 0.72
PUMP_THRESHOLD = 0.65
VOLATILITY_EXPLOSION = featureState.volatility.explosionFlag
COOLDOWN_MS = 12_000
```

### Sekvenca:

#### 1) NEWS DRIVEN

Ako:

```
newsImpactScore â‰¥ 80
```

â†’ reÅ¾im = "NEWS_DRIVEN"

#### 2) MANIPULATED

Ako:

```
featureState.spoofing.spoofingScore â‰¥ 0.72
```

â†’ reÅ¾im = "MANIPULATED"

#### 3) PUMP

Ako:

```
featureState.pumpSignals.pumpLikelihoodScore â‰¥ 0.65
```

â†’ reÅ¾im = "PUMP"

Dodatno:
Ako priceChange5sPct > 6% â†’ PUMP odmah bez diskusije.

#### 4) COOLDOWN

Ako:

```
volatility.explosionFlag == true
```

I prethodni reÅ¾im NIJE cooldown:

â†’ cooldownActive = true
â†’ cooldownEndsAt = now + 12s
â†’ reÅ¾im = "COOLDOWN"

Ako je u cooldown:

* ako cooldown nije istekao â†’ ostaje u cooldown
* ako je istekao â†’ preÄ‘e u NORMAL

#### 5) NORMAL

Ako niÅ¡ta gore nije aktivirano â†’ NORMAL

---

# **STEP 4 â€” Spojiti rezultat u finalni RegimeState objekt**

Dodati:

* pumpStrength = pumpLikelihoodScore
* spoofingLevel = spoofingScore
* volatilityScore
* newsImpactScore
* cooldownActive + timestamps

Ovo se upisuje u:

```
RegimeEngineState.perSymbol[symbol]
data/metrics/<symbol>.json
```

---

# **STEP 5 â€” Global Market Regime**

Putanja:

```
src/regime/globalRegime.js
```

### Ulaz:

* BTC featureState
* ETH featureState
* svi per-symbol reÅ¾imi
* broad market delta (agregat flow na 30â€“50 simbola)

### Profesionalno podeÅ¡eni pragovi:

```
GLOBAL_PANIC_BTC_VOL = 0.92
GLOBAL_RISK_OFF_BTC_VOL = 0.75
GLOBAL_PANIC_DUMP_5S = -3.5%
GLOBAL_RISK_OFF_DUMP_5S = -2.0%
```

### Logika:

#### 1) GLOBAL PANIC

Ako:

* BTC vol > 0.92
* ili BTC 5s dump < -3.5%
* ili >40% simbola u MANIPULATED / COOLDOWN

â†’ globalRegime = GLOBAL_PANIC
â†’ forceClosePositions = true
â†’ allowNewPositions = false

#### 2) GLOBAL RISK OFF

Ako:

* BTC vol > 0.75
* ili ETH vol > 0.70
* ili znaÄajan broj simbola u PUMP

â†’ globalRegime = GLOBAL_RISK_OFF
â†’ forceClosePositions = false
â†’ allowNewPositions = false

#### 3) GLOBAL NORMAL

Sve ostalo.

---

# **STEP 6 â€” RegimeEngine update loop**

U `regimeEngine.js` dodati:

```
initRegimeEngine()
  - uÄita config
  - registruje interval (npr. svakih 1000ms)
  - svaka iteracija radi:
    updateAllSymbolRegimes()
    updateGlobalRegime()
```

### Performanse:

* aÅ¾urirati **prime** simbole svaki 1s
* **normal** simbole svaki 2s
* **wild** simbole svaki 3â€“5s

Optimalno:
**round-robin scheduling** (najbolja praksa u HFT).

---

# **STEP 7 â€” API Endpoints**

Dodati u `web/routes/api.js`:

### 1) Per symbol:

```
GET /api/symbol/:symbol/regime
```

### 2) Global regime:

```
GET /api/regime/global
```

### 3) Overview:

```
GET /api/regime/overview
```

Dashboard sada realno vidi:

* ğŸ”¥ pump
* ğŸ­ spoof
* ğŸš¨ news
* â„ï¸ cooldown
* â›” global risk-off
* ğŸŸ¥ global panic

---

# **STEP 8 â€” Integracija sa Feature Engine (Faza 4)**

U `featureEngine.js`:

Posle izraÄunavanja feature-a:

```
regimeEngine.updateSymbolRegime(symbol)
```

i u JSON snapshot dodati:

```
featureState.regime = regimeState;
```

---

# **STEP 9 â€” Health Monitoring**

Izmeniti:

```
src/monitoring/health.js
```

Dodati:

```
services.regimeEngine = {
   status,
   lastUpdateAt,
   lastSymbolUpdated,
   globalRegime: globalRegime.current
}
```

---

# **STEP 10 â€” Test scenariji (obavezni za Fazu 5)**

### Test 1 â€” Pump reÅ¾im

Simulirati pumpLikelihoodScore = 0.9
â†’ expected: "PUMP"

### Test 2 â€” Spoof reÅ¾im

spoofingScore = 0.8
â†’ MANIPULATED

### Test 3 â€” News reÅ¾im

impactScore = 95
â†’ NEWS_DRIVEN

### Test 4 â€” Cooldown

explosionFlag = true
â†’ COOLDOWN 12s

### Test 5 â€” Global Panic

BTC vol > 0.92
â†’ PANIC + forceClosePositions=true

---

# ğŸ§¨ FINALNI REZULTAT FAZE 5

Posle ove faze tvoj sistem:

## âœ” Zna kada je trÅ¾iÅ¡te opasno

## âœ” SpreÄava loÅ¡e trejdove

## âœ” Prepoznaje pump, spoofing, news i volatilnost

## âœ” MoÅ¾e da zamrzne trgovanje

## âœ” MoÅ¾e da â€œpanic close allâ€

## âœ” Å alje jasnu sliku scoring/state-machine-u

## âœ” Å titi kapital i spreÄava katastrofalne gubitke

---

# ğŸ¯ Ako Å¾eliÅ¡, sledeÄ‡i korak mogu odmah da napravim:

## **ULTRA-DETALJAN PLAN RADA ZA FAZU 6 (SCORING ENGINE)**

ili

## **FAZA 7 (STATE MACHINE)**

ili

## **FAZA 5 â€“ implementacione module jedan po jedan (kod)**

Samo reci: **Å ta je sledeÄ‡e?**
